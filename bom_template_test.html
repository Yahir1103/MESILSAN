<!-- Estilos específicos para Control de BOM que complementan style.css -->
<style>
    /* Contenedor principal */
    .bom-container {
        font-family: 'LG regular', sans-serif;
        background-color: #32323E;
        color: lightgray;
        min-height: 100vh;
        padding: 2px;
    }

    /* Botonera */
    .bom-toolbar {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 8px;
        margin-bottom: 3px;
        padding: 8px;
        background-color: #34334E;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border: #20688C 1px solid;
        flex-wrap: wrap;
    }

    .bom-dropdown {
        background-color: #2c3e50;
        color: lightgray;
        border: 1px solid #34495e;
        border-radius: 4px;
        padding: 6px 8px;
        font-size: 11px;
        min-width: 200px;
        transition: border-color 0.3s;
    }

    .bom-dropdown:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .bom-btn {
        padding: 4px 8px;
        border: none;
        border-radius: 3px;
        background-color: #3C3940;
        border: #20688C 1px solid;
        color: white;
        cursor: pointer;
        font-size: 10px;
        transition: all 0.3s;
        font-weight: 500;
    }

    .bom-btn:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    .bom-btn.consultar {
        background-color: #3C3940;
    }

    .bom-btn.registrar {
        background-color: #502696;
    }

    .bom-btn.registrar:hover {
        background-color: #8e44ad;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);
    }

    .bom-btn.eliminar {
        background-color: #e74c3c;
    }

    .bom-btn.eliminar:hover {
        background-color: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    .bom-btn.sustituir {
        background-color: #e67e22;
    }

    .bom-btn.sustituir:hover {
        background-color: #d35400;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(230, 126, 34, 0.3);
    }

    .bom-btn.exportar, .bom-btn.importar {
        background-color: #456636;
    }

    .bom-btn.exportar:hover, .bom-btn.importar:hover {
        background-color: #5a7c42;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(69, 102, 54, 0.3);
    }

    /* Tabla */
    .bom-table-container {
        background-color: #40424F;
        padding: 0px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow-x: auto;
        width: 100%;
        max-width: 100%;
    }

    .bom-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
        font-size: 11px;
        background-color: #40424F;
        table-layout: fixed;
        max-width: 100%;
    }

    .bom-table th {
        background-color: #172A46;
        color: #ecf0f1;
        padding: 4px 3px;
        text-align: center;
        border: 1px solid #20688C;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 9px;
        line-height: 1.1;
        min-width: 50px;
        max-width: 200px;
        resize: horizontal;
    }

    .bom-table td {
        padding: 3px 2px;
        text-align: center;
        border: 1px solid #5F6375;
        background-color: #40424F;
        color: lightgray;
        transition: background-color 0.3s;
        font-size: 9px;
        line-height: 1.0;
    }

    .bom-table tr:hover td {
        background-color: #485563;
    }

    .bom-table tr:nth-child(even) td {
        background-color: #44475A;
    }

    .bom-table tr:nth-child(even):hover td {
        background-color: #485563;
    }

    .bom-table input[type="checkbox"] {
        transform: scale(1.1);
        cursor: pointer;
        accent-color: #3498db;
    }

    .bom-table .no-data {
        text-align: center;
        padding: 20px;
        color: #95a5a6;
        font-style: italic;
        background-color: #40424F;
        font-size: 10px;
    }

    /* Mensajes de estado */
    .bom-loading {
        text-align: center;
        padding: 15px;
        color: #3498db;
        font-size: 10px;
    }

    .bom-error {
        text-align: center;
        padding: 15px;
        color: #e74c3c;
        font-size: 10px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .bom-toolbar {
            flex-direction: column;
            gap: 10px;
        }
        
        .bom-btn {
            width: 100%;
        }
        
        .bom-dropdown {
            min-width: 100%;
        }
        
        .bom-table-container {
            padding: 15px;
        }
    }
</style>
</head>
<body>
<div class="bom-container">
    <!-- Botonera -->
    <div class="bom-toolbar">
        <select class="bom-dropdown" id="bomModeloSelect">
            
        </select>
        
        <button class="bom-btn consultar" onclick="consultarBOM()">
            Consultar
        </button>
        <button class="bom-btn registrar" onclick="mostrarFormularioBOM()">
            Registrar
        </button>
        <button class="bom-btn eliminar" onclick="eliminarBOM()">
            Eliminar
        </button>
        <button class="bom-btn sustituir" onclick="mostrarSustitutoBOM()">
            Registro de mat. sustituto
        </button>
        <button class="bom-btn exportar" onclick="exportarExcelBOM()">
            Exportar al excel
        </button>
        <input type="file" id="importarExcelBOM" onchange="importarExcelBOM()" style="display:none" accept=".xlsx,.xls" />
        <button class="bom-btn importar" onclick="document.getElementById('importarExcelBOM').click()">
            Importar al excel
        </button>
    </div>

    <!-- Tabla de BOM -->
    <div class="bom-table-container">
        <table class="bom-table" id="bomDataTable">
            <thead>
                <tr>
                    <th>Selector</th>
                    <th class="col-codigo">Código de material</th>
                    <th class="col-numero-parte">Número de parte</th>
                    <th class="col-side">Side</th>
                    <th class="col-tipo">Tipo de material</th>
                    <th class="col-clasificacion">Classification</th>
                    <th class="col-especificacion">Especificación de material</th>
                    <th class="col-vender">Vender</th>
                    <th class="col-cantidad-total">Cantidad total</th>
                    <th class="col-cantidad-original">Cantidad original</th>
                    <th class="col-ubicacion">Ubicación</th>
                    <th class="col-material-sustituto">Material sustituto</th>
                    <th class="col-material-original">Material original</th>
                    <th class="col-registrador">Registrador</th>
                    <th class="col-fecha">Fecha de registro</th>
                </tr>
            </thead>
            <tbody id="bomTableBody">
                <tr>
                    <td colspan="15" class="no-data">
                        No hay datos para mostrar. Seleccione un modelo y haga clic en "Consultar" para cargar los datos.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal personalizado para mensajes -->
<div id="customAlertModal" style="display:none;position:fixed;z-index:2147483647;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;">
  <div style="background:#39515F;padding:32px 24px 20px 24px;border-radius:10px;border-color: #3498db; box-shadow:0 4px 24px #0008;min-width:320px;max-width:90vw;text-align:center;position:relative;outline:none;" tabindex="0" id="customAlertDialog">
    <div id="customAlertMessage" style="color:#fff;font-size:1.1em;margin-bottom:18px;"></div>
    <button onclick="hideCustomAlert()" id="customAlertOkBtn" style="background:#2D363D;color:#fff;border: 2px; ;padding:8px 32px;border-radius:5px;font-size:1em;cursor:pointer;">OK</button>
  </div>
</div>

<script>
    function cargarDatosBOMEnTabla(datos) {
        const tbody = document.querySelector('#bomTableBody');
        tbody.innerHTML = '';
        
        if (!datos || datos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="15" class="no-data">No hay datos de BOM registrados. Use el botón "Registrar" para añadir nuevos elementos.</td></tr>';
            return;
        }
        
        datos.forEach((item, index) => {
            const row = document.createElement('tr');
            
            // Función para limpiar decimales innecesarios en números
            function limpiarNumero(valor) {
                if (!valor) return '';
                const numero = parseFloat(valor);
                if (!isNaN(numero) && numero % 1 === 0) {
                    return numero.toString();
                }
                return valor.toString();
            }
            
            // Crear checkbox selector
            const selectorCheckbox = `<input type="checkbox" onchange="seleccionarFilaBOM(${index}, this.checked)">`;
            
            row.innerHTML = `
                <td>${selectorCheckbox}</td>
                <td>${item.codigoMaterial || ''}</td>
                <td>${item.numeroParte || ''}</td>
                <td>${item.side || ''}</td>
                <td>${item.tipoMaterial || ''}</td>
                <td>${item.classification || ''}</td>
                <td>${item.especificacionMaterial || ''}</td>
                <td>${item.vender || ''}</td>
                <td>${limpiarNumero(item.cantidadTotal || '0')}</td>
                <td>${limpiarNumero(item.cantidadOriginal || '0')}</td>
                <td>${item.ubicacion || ''}</td>
                <td>${item.materialSustituto || ''}</td>
                <td>${item.materialOriginal || ''}</td>
                <td>${item.registrador || ''}</td>
                <td>${item.fechaRegistro || ''}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function cargarDatosBOMDesdeServidor() {
        const modelo = document.getElementById('bomModeloSelect').value;
        
        fetch('/listar_bom', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ modelo: modelo })
        })
        .then(response => response.json())
        .then(data => {
            cargarDatosBOMEnTabla(data);
        })
        .catch(error => {
            console.error('Error al cargar datos de BOM:', error);
            const tbody = document.querySelector('#bomTableBody');
            tbody.innerHTML = '<tr><td colspan="15" class="bom-error">Error al cargar los datos. Por favor, intente nuevamente.</td></tr>';
        });
    }

    function consultarBOM() {
        // Mostrar indicador de carga
        const tbody = document.querySelector('#bomTableBody');
        tbody.innerHTML = '<tr><td colspan="15" class="bom-loading"><div>Cargando datos de BOM...</div></td></tr>';
        
        // Cargar datos desde el servidor
        cargarDatosBOMDesdeServidor();
    }

    function mostrarFormularioBOM() {
        alert('Funcionalidad de registro de BOM en desarrollo');
    }

    function eliminarBOM() {
        alert('Funcionalidad de eliminación de BOM en desarrollo');
    }

    function mostrarSustitutoBOM() {
        alert('Funcionalidad de registro de material sustituto en desarrollo');
    }

    function exportarExcelBOM() {
        try {
            alert('Generando archivo Excel de BOM, por favor espere...');
            
            fetch('/exportar_excel_bom', {
                method: 'GET',
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en el servidor');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `bom_export_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                window.URL.revokeObjectURL(url);
                alert('Archivo Excel de BOM descargado exitosamente');
            })
            .catch(error => {
                console.error('Error al exportar Excel de BOM:', error);
                alert('Error al exportar el archivo Excel de BOM: ' + error.message);
            });
            
        } catch (error) {
            console.error('Error al exportar Excel de BOM:', error);
            alert('Error al exportar el archivo Excel de BOM');
        }
    }

    function importarExcelBOM() {
        const fileInput = document.getElementById('importarExcelBOM');
        const file = fileInput.files[0];
        
        if (!file) {
            showCustomAlert("Por favor selecciona un archivo Excel de BOM.");
            return;
        }
        
        if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
            showCustomAlert("Por favor selecciona un archivo Excel válido (.xlsx o .xls)");
            return;
        }
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/importar_excel_bom', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const now = new Date();
                const fecha = now.toLocaleDateString();
                const hora = now.toLocaleTimeString();
                showCustomAlert(`Carga exitosa<br><span style='font-size:0.95em;color:#b0eaff;'>${fecha} ${hora}</span>`);
                fileInput.value = '';
            } else {
                showCustomAlert("Error al importar BOM: " + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showCustomAlert("Error al importar el archivo de BOM");
        });
    }

    function seleccionarFilaBOM(index, seleccionado) {
        console.log(`Fila ${index} ${seleccionado ? 'seleccionada' : 'deseleccionada'}`);
        // Aquí puedes agregar lógica adicional para manejar la selección
    }

    function cargarModelosBOM() {
        fetch('/listar_modelos_bom', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(modelos => {
            const select = document.getElementById('bomModeloSelect');
            select.innerHTML = '<option value="todos">Todos los modelos</option>';
            
            modelos.forEach(modelo => {
                const option = document.createElement('option');
                option.value = modelo.modelo;
                option.textContent = modelo.modelo;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error al cargar modelos:', error);
            showCustomAlert('Error al cargar la lista de modelos');
        });
    }

    // Permitir redimensionar columnas tipo Excel
    document.addEventListener('DOMContentLoaded', function () {
        // Cargar modelos al inicializar la página
        cargarModelosBOM();
        
        // Modal: cerrar con Escape/Enter y bloquear tabulación fuera del modal
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('customAlertModal');
            if (modal.style.display === 'flex') {
                if (e.key === 'Escape' || e.key === 'Enter') {
                    e.preventDefault();
                    hideCustomAlert();
                } else if (e.key === 'Tab') {
                    // Bloquear tabulación fuera del modal
                    const dialog = document.getElementById('customAlertDialog');
                    e.preventDefault();
                    dialog.focus();
                }
            }
        });
        const table = document.getElementById('bomDataTable');
        const thElements = table.querySelectorAll('th');
        thElements.forEach(function (th) {
            // Crear un "grip" para el resize
            const resizer = document.createElement('div');
            resizer.style.width = '5px';
            resizer.style.height = '100%';
            resizer.style.position = 'absolute';
            resizer.style.right = '0';
            resizer.style.top = '0';
            resizer.style.cursor = 'col-resize';
            resizer.style.userSelect = 'none';
            resizer.style.zIndex = '100';
            resizer.classList.add('th-resizer');
            th.style.position = 'relative';
            th.appendChild(resizer);

            let startX, startWidth;

            resizer.addEventListener('mousedown', function (e) {
                startX = e.pageX;
                startWidth = th.offsetWidth;
                document.body.style.cursor = 'col-resize';

                function onMouseMove(e) {
                    const newWidth = startWidth + (e.pageX - startX);
                    th.style.width = newWidth + 'px';
                }

                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    document.body.style.cursor = '';
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    });

    // Modal personalizado
    window.showCustomAlert = function(message) {
        const modal = document.getElementById('customAlertModal');
        const msg = document.getElementById('customAlertMessage');
        msg.innerHTML = message;
        modal.style.display = 'flex';
        setTimeout(() => {
            const okBtn = document.getElementById('customAlertOkBtn');
            if (okBtn) okBtn.focus();
        }, 50);
    }
    window.hideCustomAlert = function() {
        document.getElementById('customAlertModal').style.display = 'none';
    }
</script>
</body>
</html>