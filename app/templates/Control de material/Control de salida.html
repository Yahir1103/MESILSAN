<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Salida de Material</title>
    <link rel="stylesheet" href="/static/css/control_salida_material.css">
    <link rel="stylesheet" href="/static/css/control_salida_material_responsive.css">
</head>
<body>
    <div id="control-salida-container">
        <div class="material-toolbar">
            <!-- Contenedor izquierdo: Campo de escaneo -->
            <div class="scan-container">
                <div class="material-form-group">
                    <label>Código de material recibido</label>
                    <input type="text" id="salida_codigo_material_recibido" placeholder="Escanear código aquí..." onkeydown="procesarEscaneoRapido(event)" autocomplete="off">
                </div>
            </div>
            <div class="material-form-group verification-group">
                <label>Verificación de salida (Requerido)</label>
                <input type="text" id="salida_verificacion_codigo" placeholder="Escanear código de verificación..." onkeydown="procesarVerificacion(event)" autocomplete="off" style="border: 2px solid #e74c3c;">
            </div>

            <!-- Contenedor derecho: Checkboxes -->
            <div class="checkbox-container">
                <label style="display: flex; align-items: center; gap: 8px; color: #ecf0f1; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="salida_registroAutomatico" style="transform: scale(1.0); accent-color: #27ae60;" checked>
                     Registro automático
                </label>
                <label style="display: flex; align-items: center; gap: 8px; color: #ecf0f1; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="salida_verificacionBOM" style="transform: scale(1.0); accent-color: #8e44ad;">
                    Verificación de BOM
                </label>
                <label style="display: flex; align-items: center; gap: 8px; color: #ecf0f1; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="salida_peps" style="transform: scale(1.0); accent-color: #27ae60;">
                    PEPS
                </label>
            </div>
        </div>
        <div class="material-form-section">
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label>Modelo</label>
                    <div class="salida-search-container">
                        <input type="text" class="salida-search-dropdown" id="salida_modelo_search" placeholder="Buscar modelo..." onkeyup="filtrarModelosSalida()" onclick="mostrarDropdownSalida()" />
                        <div class="salida-dropdown-list" id="salidaDropdownList" style="display: none;">
                            <!-- Los modelos se cargarán dinámicamente aquí -->
                        </div>
                        <!-- Campo oculto para el valor real del modelo -->
                        <input type="hidden" id="salida_modelo" name="modelo" required />
                    </div>
                </div>
                <div class="material-form-group">
                    <!-- Campo movido arriba -->
                </div>
                <div class="material-form-group">
                    <button class="material-btn secondary" id="salida_btnGuardarSalida" onclick="procesarSalidaManual()" style="display: none;">Guardar Salida</button>
                </div>
            </div>
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label>Código de material original</label>
                    <input type="text" id="salida_codigo_material_original" readonly>
                </div>
                <div class="material-form-group">
                    <label>Código de material</label>
                    <input type="text" id="salida_codigo_material" readonly>
                </div>
                <div class="material-form-group">
                    <label>Especificación de material</label>
                    <input type="text" id="salida_especificacion_material" readonly>
                </div>
            </div>
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label>Numero de parte</label>
                    <input type="text" id="salida_numero_parte" readonly>
                </div>
                <div class="material-form-group">
                    <label>Cantidad actual</label>
                    <input type="text" id="salida_cantidad_actual" readonly>
                </div>
                <div class="material-form-group">
                    <label>Numero de lote de material</label>
                    <input type="text" id="salida_numero_lote_material" readonly>
                </div>
            </div>
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label>Fecha de salida</label>
                    <input type="date" id="salida_fecha_salida_form" value="">
                </div>
                <div class="material-form-group">
                    <!-- Campo vacío -->
                </div>
                <div class="material-form-group">
                    <!-- Campo vacío -->
                </div>
            </div>
        </div>

        <div class="material-table-container">
            <div class="material-table-controls">
                <button class="material-btn" id="btnRegistroSalida" onclick="mostrarRegistroSalida()">Registro de salida</button>
                <button class="material-btn" id="btnHistorialSalida" onclick="mostrarHistorialSalida()">Historial de salida</button>
            </div>

            <!-- Tablas para modo Registro de salida - siempre visibles -->
            <div id="tablasRegistroSalida" class="registro-tablas-container" style="display: flex; gap: 20px; margin: 20px 0;">
                <!-- Primera tabla - Información general del BOM -->
                <div class="tabla-container" style="flex: 1;">
                    <h4 style="margin: 0 0 10px 0; color: #ecf0f1; font-size: 14px; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Componentes del BOM seleccionado</h4>
                    <table class="material-table">
                        <thead>
                            <tr>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Número de parte</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Especificación</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Cantidad total</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Unidad</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla1BOM">
                            <tr>
                                <td colspan="5" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Seleccione un modelo para ver componentes</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Divisor vertical -->
                <div style="width: 2px; background-color: #bdc3c7; margin: 0 10px; border-radius: 1px;"></div>

                <!-- Segunda tabla - Detalles del material seleccionado -->
                <div class="tabla-container" style="flex: 1;">
                    <h4 style="margin: 0 0 10px 0; color: #ecf0f1; font-size: 14px; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Material actual para salida</h4>
                    <table class="material-table">
                        <thead>
                            <tr>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Número de parte</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Descripción</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Cantidad disponible</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Cantidad requerida</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Estado</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Código de material</th>
                            </tr>
                        </thead>
                        <tbody id="tabla2BOM">
                            <tr>
                                <td colspan="6" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Seleccione un componente de la tabla izquierda</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Controles y tabla de historial -->
            <div id="historialSection" style="display: none;">
                <div class="material-table-controls" id="historialControles" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between;">
                    <!-- Filtros de fecha - lado izquierdo -->
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="material-form-group">
                            <label>Fecha desde</label>
                            <input type="date" id="salida_fecha_desde">
                        </div>
                        <div class="material-form-group">
                            <label>Fecha hasta</label>
                            <input type="date" id="salida_fecha_hasta">
                        </div>
                    </div>
                    
                    <!-- Controles principales - lado derecho -->
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="material-form-group">
                            <label>Código de material recibido</label>
                            <input type="text" id="salida_filtro_codigo" placeholder="Buscar por código...">
                        </div>
                        <button class="material-btn secondary" onclick="consultarSalidas()">Consultar</button>
                        <button class="material-btn" onclick="limpiarFiltros()" style="background-color: #95a5a6;">Limpiar filtros</button>
                        <button class="material-btn orange" onclick="exportarExcel()">Exportar el excel</button>
                    </div>
                </div>
                <table class="material-table" id="salida_tablaSalidas">
                    <thead>
                        <tr>
                            <th>Fecha de salida</th>
                            <th>Proceso de salida</th>
                            <th>Código de material recibido</th>
                            <th>Código de material</th>
                            <th>Número de parte</th>
                            <th>Disp.</th>
                            <th>Hist.</th>
                            <th>Código de material original</th>
                            <th>Número de lote</th>
                            <th>Máquina(linea)</th>
                            <th>Departamento de salida</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="11" class="no-data">No hay dato registrado</td>
                        </tr>
                    </tbody>
                </table>
                <div class="total-info" id="salida_totalInfo">Total Rows: 0</div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let materialActual = null;
        let verificacionCompletada = false;

        // Función global para inicializar cuando se muestra el control de salida (para AJAX)
        window.inicializarControlSalidaModule = function() {
            setTimeout(() => {
                inicializarControlSalida();
            }, 100);
        };

        // Función de inicialización simplificada
        function inicializarControlSalida() {
            // Establecer fecha actual
            const hoy = new Date().toISOString().split('T')[0];
            const fechaSalidaForm = document.getElementById('salida_fecha_salida_form');
            
            if (fechaSalidaForm) fechaSalidaForm.value = hoy;

            // Establecer fecha actual en los filtros de historial
            const fechaDesde = document.getElementById('salida_fecha_desde');
            const fechaHasta = document.getElementById('salida_fecha_hasta');
            
            if (fechaDesde) fechaDesde.value = hoy;
            if (fechaHasta) fechaHasta.value = hoy;

            // Configurar listeners para el checkbox de registro automático
            configurarRegistroAutomatico();

            // Cargar modelos disponibles en el BOM
            console.log('🔧 DEBUG: Iniciando carga de modelos BOM...');
            cargarModelosBOM();

            // Enfocar campo de código
            const codigoInput = document.getElementById('salida_codigo_material_recibido');
            if (codigoInput) {
                setTimeout(() => codigoInput.focus(), 100);
            }

            // Mostrar por defecto las tablas de registro
            mostrarRegistroSalida();

            // No cargar datos automáticamente - solo cuando se haga clic en "Consultar"
        }

        // Nueva función para configurar el comportamiento del registro automático
        function configurarRegistroAutomatico() {
            const checkbox = document.getElementById('salida_registroAutomatico');
            const btnGuardar = document.getElementById('salida_btnGuardarSalida');
            
            if (checkbox && btnGuardar) {
                // Configurar estado inicial
                actualizarModoRegistro();
                
                // Listener para cambios en el checkbox
                checkbox.addEventListener('change', function() {
                    actualizarModoRegistro();
                });
            } else {
                console.error('❌ No se pudo configurar registro automático - elementos no encontrados');
            }
        }

        // Función para actualizar el modo de registro según el checkbox
        function actualizarModoRegistro() {
            const checkbox = document.getElementById('salida_registroAutomatico');
            const btnGuardar = document.getElementById('salida_btnGuardarSalida');
            
            if (checkbox && btnGuardar) {
                if (checkbox.checked) {
                    // Modo automático: ocultar botón
                    btnGuardar.style.display = 'none';
                } else {
                    // Modo manual: mostrar botón
                    btnGuardar.style.display = 'block';
                }
            }
        }

        // Nueva función para procesar verificación de salida
        function procesarVerificacion(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                
                const codigoVerificacion = event.target.value.trim();
                
                if (!codigoVerificacion) {
                    return;
                }
                
                if (!materialActual) {
                    mostrarMensajeSimple('Primero debe escanear un material', 'error');
                    event.target.value = '';
                    return;
                }
                
                // Verificar si el código escaneado coincide con algún número del material actual
                const coincidencias = verificarCoincidencias(codigoVerificacion, materialActual);
                
                if (coincidencias.length > 0) {
                    mostrarMensajeSimple(`✅ Verificado: ${coincidencias.join(', ')}`, 'success');
                    verificacionCompletada = true;
                    
                    // Cambiar el borde del campo de verificación a verde
                    event.target.style.border = '2px solid #27ae60';
                    event.target.readOnly = true;
                    
                    // VERIFICAR SI REGISTRO AUTOMÁTICO ESTÁ ACTIVADO
                    const checkbox = document.getElementById('salida_registroAutomatico');
                    const registroAutomatico = checkbox ? checkbox.checked : false;
                    
                    if (registroAutomatico) {
                        // Procesar salida automáticamente después de verificación exitosa
                        setTimeout(async () => {
                            await procesarSalidaAutomaticaDespuesVerificacion();
                        }, 500);
                    } else {
                        // Modo manual: mostrar mensaje para usar botón
                        mostrarMensajeSimple('Verificación completada - Haga clic en "Guardar Salida"', 'info');
                    }
                    
                } else {
                    mostrarMensajeSimple('❌ Código no coincide con el material', 'error');
                    verificacionCompletada = false;
                    event.target.value = '';
                    event.target.focus();
                }
            }
        }

        // Función para verificar coincidencias entre el código escaneado y los datos del material
        function verificarCoincidencias(codigoVerificacion, material) {
            const coincidencias = [];
            
            // Lista de campos a verificar
            const camposAVerificar = [
                { campo: 'codigo_material_recibido', nombre: 'Código Recibido' },
                { campo: 'codigo_material', nombre: 'Código Material' },
                { campo: 'codigo_material_original', nombre: 'Código Original' },
                { campo: 'numero_parte', nombre: 'Número de Parte' },
                { campo: 'numero_lote_material', nombre: 'Lote' }
            ];
            
            camposAVerificar.forEach(item => {
                const valorCampo = material[item.campo];
                if (valorCampo && codigoVerificacion.includes(valorCampo)) {
                    coincidencias.push(item.nombre);
                }
                // También verificar coincidencia parcial o completa
                if (valorCampo && valorCampo.includes(codigoVerificacion)) {
                    if (!coincidencias.includes(item.nombre)) {
                        coincidencias.push(item.nombre);
                    }
                }
            });
            
            return coincidencias;
        }

        // Función para limpiar verificación cuando se cambie de material
        function limpiarVerificacion() {
            const campoVerificacion = document.getElementById('salida_verificacion_codigo');
            
            if (campoVerificacion) {
                campoVerificacion.value = '';
                campoVerificacion.style.border = '2px solid #e74c3c';
                campoVerificacion.readOnly = false;
            }
            
            verificacionCompletada = false;
        }

        // FUNCIÓN SIMPLE: Limpiar código y enfocar (pero mantener campos rellenados)
        function limpiarCodigo() {
            const input = document.getElementById('salida_codigo_material_recibido');
            if (input) {
                input.value = '';
                setTimeout(() => input.focus(), 100);
            }
        }

        // FUNCIÓN PRINCIPAL: Procesar escaneo ultra rápido
        async function procesarEscaneoRapido(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                
                const codigo = event.target.value.trim();
                
                if (!codigo) {
                    return;
                }
                
                try {
                    // 1. Buscar material primero
                    const response = await fetch(`/buscar_material_por_codigo?codigo_recibido=${encodeURIComponent(codigo)}`);
                    const data = await response.json();

                    if (!data.success || !data.material) {
                        mostrarMensajeSimple(data.error || 'Material no encontrado', 'error');
                        return;
                    }

                    const material = data.material;
                    
                    // 2. Rellenar campos del material
                    rellenarCamposMaterial(material);
                    materialActual = material;
                    
                    // 3. Limpiar verificación anterior
                    limpiarVerificacion();
                    
                    // 4. AUTOMÁTICAMENTE pasar al campo de verificación
                    const campoVerificacion = document.getElementById('salida_verificacion_codigo');
                    if (campoVerificacion) {
                        setTimeout(() => {
                            campoVerificacion.focus();
                        }, 300);
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    mostrarMensajeSimple('Error al buscar material', 'error');
                }
            }
        }

        // Nueva función para procesamiento automático después de verificación exitosa
        async function procesarSalidaAutomaticaDespuesVerificacion() {
            try {
                const codigo = document.getElementById('salida_codigo_material_recibido')?.value?.trim();
                
                if (!codigo || !materialActual || !verificacionCompletada) {
                    mostrarMensajeSimple('Error: faltan datos para procesar salida', 'error');
                    return;
                }
                
                // 1. Validar modelo
                const modelo = document.getElementById('salida_modelo')?.value || '';
                if (!modelo) {
                    mostrarMensajeSimple('Seleccione modelo primero', 'error');
                    return;
                }

                const cantidadSalida = parseFloat(materialActual.cantidad_actual) || 0;

                if (cantidadSalida <= 0) {
                    mostrarMensajeSimple('Sin stock disponible', 'error');
                    return;
                }

                // 2. Procesar salida automática
                const salidaResponse = await fetch('/procesar_salida_material', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codigo_material_recibido: codigo,
                        cantidad_salida: cantidadSalida,
                        modelo: modelo,
                        numero_lote: materialActual.numero_lote_material || '',
                        fecha_salida: document.getElementById('salida_fecha_salida_form')?.value || '',
                        depto_salida: 'Producción',
                        proceso_salida: 'SMT 1st SIDE',
                        codigo_verificacion: document.getElementById('salida_verificacion_codigo')?.value || ''
                    })
                });

                const salidaData = await salidaResponse.json();

                if (salidaData.success) {
                    mostrarMensajeSimple(`✅ Salida automática procesada: ${cantidadSalida}`, 'success');
                    
                    // Limpiar TODOS los campos para siguiente escaneo
                    setTimeout(() => {
                        limpiarCamposMaterial();
                    }, 1000);
                    
                } else {
                    mostrarMensajeSimple('Error al procesar salida automática', 'error');
                }
                
            } catch (error) {
                console.error('❌ Error en procesamiento automático:', error);
                mostrarMensajeSimple('Error interno en procesamiento automático', 'error');
            }
        }

        // Nueva función para buscar material sin guardar (modo manual)
        async function buscarMaterialSinGuardar(codigo) {
            try {
                const response = await fetch(`/buscar_material_por_codigo?codigo_recibido=${encodeURIComponent(codigo)}`);
                const data = await response.json();

                if (!data.success || !data.material) {
                    mostrarMensajeSimple(data.error || 'Material no encontrado', 'error');
                    return;
                }

                const material = data.material;
                
                // IMPORTANTE: Solo rellenar campos, NO guardar la salida
                rellenarCamposMaterial(material);
                materialActual = material;
                
                // Limpiar verificación anterior para el nuevo material
                limpiarVerificacion();
                
                // Mensaje claro indicando que debe usar el botón
                mostrarMensajeSimple('Material encontrado - Complete verificación y haga clic en "Guardar Salida"', 'info');
                
                // Enfocar el campo de verificación
                const campoVerificacion = document.getElementById('salida_verificacion_codigo');
                if (campoVerificacion) {
                    setTimeout(() => campoVerificacion.focus(), 500);
                }
                
            } catch (error) {
                console.error('Error:', error);
                mostrarMensajeSimple('Error al buscar material', 'error');
            }
        }

        // Nueva función para procesamiento manual con botón
        async function procesarSalidaManual() {
            const codigo = document.getElementById('salida_codigo_material_recibido')?.value?.trim();
            
            if (!codigo) {
                mostrarMensajeSimple('Ingrese código de material', 'error');
                return;
            }
            
            if (!materialActual) {
                mostrarMensajeSimple('Primero busque el material escaneando o escribiendo código', 'error');
                return;
            }
            
            // VALIDAR VERIFICACIÓN REQUERIDA
            if (!verificacionCompletada) {
                mostrarMensajeSimple('Debe completar la verificación de salida primero', 'error');
                const campoVerificacion = document.getElementById('salida_verificacion_codigo');
                if (campoVerificacion) {
                    campoVerificacion.focus();
                }
                return;
            }
            
            // PROCESAR SALIDA MANUAL
            try {
                // 1. Validar modelo
                const modelo = document.getElementById('salida_modelo')?.value || '';
                if (!modelo) {
                    mostrarMensajeSimple('Seleccione modelo', 'error');
                    return;
                }

                const cantidadSalida = parseFloat(materialActual.cantidad_actual) || 0;

                if (cantidadSalida <= 0) {
                    mostrarMensajeSimple('Sin stock disponible', 'error');
                    return;
                }

                // 2. Procesar salida directa
                const salidaResponse = await fetch('/procesar_salida_material', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codigo_material_recibido: codigo,
                        cantidad_salida: cantidadSalida,
                        modelo: modelo,
                        numero_lote: materialActual.numero_lote_material || '',
                        fecha_salida: document.getElementById('salida_fecha_salida_form')?.value || '',
                        depto_salida: 'Producción', // Valor por defecto
                        proceso_salida: 'SMT 1st SIDE', // Valor por defecto
                        codigo_verificacion: document.getElementById('salida_verificacion_codigo')?.value || ''
                    })
                });

                const salidaData = await salidaResponse.json();

                if (salidaData.success) {
                    // ✅ OPTIMIZACIÓN: Mostrar mensaje especial para respuesta optimizada
                    if (salidaData.optimized) {
                        mostrarMensajeSimple(`Salida procesada: ${cantidadSalida} | Inventario actualizándose`, 'success');
                    } else {
                        mostrarMensajeSimple(`Salida manual procesada: ${cantidadSalida}`, 'success');
                    }
                    
                    // Actualizar tabla en background más rápido (solo si está visible)
                    const historialSection = document.getElementById('historialSection');
                    if (historialSection && historialSection.style.display !== 'none') {
                        setTimeout(() => consultarSalidas(), 300);
                    }
                    
                    // Limpiar TODOS los campos después de procesar exitosamente
                    setTimeout(() => {
                        limpiarCamposMaterial();
                    }, 1000);
                    
                } else {
                    mostrarMensajeSimple('Error al procesar salida', 'error');
                }
                
            } catch (error) {
                console.error('❌ Error en procesamiento manual:', error);
                mostrarMensajeSimple('Error interno', 'error');
            }
        }

        // FUNCIÓN ULTRA SIMPLIFICADA: Salida inmediata
        async function procesarSalidaInmediata(codigo) {
            try {
                // 1. Validar modelo
                const modelo = document.getElementById('salida_modelo')?.value || '';
                if (!modelo) {
                    mostrarMensajeSimple('Seleccione modelo', 'error');
                    limpiarCodigo();
                    return;
                }

                // 2. Buscar material y rellenar campos
                const response = await fetch(`/buscar_material_por_codigo?codigo_recibido=${encodeURIComponent(codigo)}`);
                const data = await response.json();

                if (!data.success || !data.material) {
                    mostrarMensajeSimple(data.error || 'Material no encontrado', 'error');
                    limpiarCodigo();
                    return;
                }

                const material = data.material;
                
                // Rellenar campos automáticamente
                rellenarCamposMaterial(material);
                materialActual = material;
                
                // Limpiar verificación anterior para el nuevo material
                limpiarVerificacion();
                
                const cantidadSalida = parseFloat(material.cantidad_actual) || 0;

                if (cantidadSalida <= 0) {
                    mostrarMensajeSimple('Sin stock', 'error');
                    limpiarCodigo();
                    return;
                }

                // VALIDAR VERIFICACIÓN REQUERIDA PARA MODO AUTOMÁTICO
                if (!verificacionCompletada) {
                    mostrarMensajeSimple('Complete la verificación primero', 'warning');
                    const campoVerificacion = document.getElementById('salida_verificacion_codigo');
                    if (campoVerificacion) {
                        campoVerificacion.focus();
                    }
                    return; // No limpiar código para permitir reintento
                }

                // 3. Procesar salida directa
                const salidaResponse = await fetch('/procesar_salida_material', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codigo_material_recibido: codigo,
                        cantidad_salida: cantidadSalida,
                        modelo: modelo,
                        numero_lote: material.numero_lote_material || '',
                        fecha_salida: document.getElementById('salida_fecha_salida_form')?.value || '',
                        depto_salida: 'Producción', // Valor por defecto
                        proceso_salida: 'SMT 1st SIDE', // Valor por defecto
                        codigo_verificacion: document.getElementById('salida_verificacion_codigo')?.value || ''
                    })
                });

                const salidaData = await salidaResponse.json();

                if (salidaData.success) {
                    // ✅ OPTIMIZACIÓN: Feedback más rápido y claro
                    if (salidaData.optimized) {
                        mostrarMensajeSimple(`🚀 ULTRA-RÁPIDO: ${cantidadSalida} | Background processing`, 'success');
                    } else {
                        mostrarMensajeSimple(`Salida OK: ${cantidadSalida}`, 'success');
                    }
                    
                    // Actualizar tabla más rápido para mostrar el cambio inmediatamente (solo si está visible)
                    const historialSection = document.getElementById('historialSection');
                    if (historialSection && historialSection.style.display !== 'none') {
                        setTimeout(() => consultarSalidas(), 300);
                    }
                } else {
                    mostrarMensajeSimple('Error en salida', 'error');
                }

                limpiarCodigo();
                limpiarVerificacion(); // Limpiar verificación después de procesar
                
            } catch (error) {
                console.error('Error:', error);
                mostrarMensajeSimple('Error', 'error');
                limpiarCodigo();
            }
        }

        // FUNCIÓN NUEVA: Limpiar todos los campos del material
        function limpiarCamposMaterial() {
            // Limpiar campo de código de material recibido
            const codigoInput = document.getElementById('salida_codigo_material_recibido');
            if (codigoInput) {
                codigoInput.value = '';
            }
            
            // Limpiar todos los campos del material
            const camposALimpiar = [
                'salida_codigo_material_original',
                'salida_codigo_material', 
                'salida_especificacion_material',
                'salida_numero_parte',
                'salida_cantidad_actual',
                'salida_numero_lote_material'
            ];
            
            camposALimpiar.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = '';
                    // Resetear estilos
                    input.style.backgroundColor = '';
                    input.style.color = '';
                    input.style.fontWeight = '';
                }
            });
            
            // Limpiar verificación
            limpiarVerificacion();
            
            // Resetear variables globales
            materialActual = null;
            verificacionCompletada = false;
            
            // Enfocar nuevamente el campo de código
            setTimeout(() => {
                if (codigoInput) {
                    codigoInput.focus();
                }
            }, 100);
        }

        // FUNCIÓN SIMPLE: Limpiar código y enfocar (pero mantener campos rellenados)
        function limpiarCodigo() {
            const input = document.getElementById('salida_codigo_material_recibido');
            if (input) {
                input.value = '';
                setTimeout(() => input.focus(), 200);
            }
        }

        // FUNCIÓN SIMPLE: Mostrar mensaje breve
        function mostrarMensajeSimple(mensaje, tipo) {
            // Buscar o crear contenedor de mensajes
            let info = document.getElementById('salida-info-message');
            if (!info) {
                info = document.createElement('div');
                info.id = 'salida-info-message';
                info.style.position = 'fixed';
                info.style.top = '10px';
                info.style.left = '50%';
                info.style.transform = 'translateX(-50%)';
                info.style.padding = '6px 12px';
                info.style.borderRadius = '4px';
                info.style.fontSize = '12px';
                info.style.fontWeight = '500';
                info.style.zIndex = '9999';
                info.style.display = 'none';
                info.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                info.style.maxWidth = '400px';
                info.style.textAlign = 'center';
                info.style.transition = 'all 0.3s ease';
                document.body.appendChild(info);
            }
            
            info.textContent = mensaje;
            info.style.display = 'block';
            info.style.color = 'white';
            switch(tipo) {
                case 'success':
                    info.style.backgroundColor = '#27ae60';
                    break;
                case 'error':
                    info.style.backgroundColor = '#e74c3c';
                    break;
                case 'info':
                    info.style.backgroundColor = '#3498db';
                    break;
                default:
                    info.style.backgroundColor = '#95a5a6';
            }
            
            setTimeout(() => {
                info.style.display = 'none';
            }, 2500);
        }

        // Ejecutar inicialización simplificada
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarControlSalida);
        } else {
            setTimeout(inicializarControlSalida, 50);
        }

        // Funciones para controlar la visibilidad de la tabla
        function mostrarRegistroSalida() {
            // Mostrar tablas de registro (siempre visibles)
            document.getElementById('tablasRegistroSalida').style.display = 'flex';
            
            // Ocultar otras secciones
            document.getElementById('historialSection').style.display = 'none';
            
            // Manejar clases CSS para responsive móvil
            document.body.classList.remove('historial-active');
            document.getElementById('tablasRegistroSalida').classList.remove('hidden', 'hidden-by-historial');
            
            // Cambiar estado visual de los botones
            document.getElementById('btnRegistroSalida').style.backgroundColor = '#3498db';
            document.getElementById('btnHistorialSalida').style.backgroundColor = '';
        }

        function mostrarHistorialSalida() {
            // Ocultar otras secciones
            document.getElementById('tablasRegistroSalida').style.display = 'none';
            
            // Mostrar sección de historial
            document.getElementById('historialSection').style.display = 'block';
            
            // Manejar clases CSS para responsive móvil
            document.body.classList.add('historial-active');
            document.getElementById('tablasRegistroSalida').classList.add('hidden-by-historial');
            
            // Establecer fecha actual en los filtros de fecha
            const hoy = new Date().toISOString().split('T')[0];
            const fechaDesde = document.getElementById('salida_fecha_desde');
            const fechaHasta = document.getElementById('salida_fecha_hasta');
            
            if (fechaDesde && !fechaDesde.value) {
                fechaDesde.value = hoy;
            }
            if (fechaHasta && !fechaHasta.value) {
                fechaHasta.value = hoy;
            }
            
            // Cambiar estado visual de los botones
            document.getElementById('btnHistorialSalida').style.backgroundColor = '#3498db';
            document.getElementById('btnRegistroSalida').style.backgroundColor = '';
        }

        // Función para cargar los modelos disponibles en el BOM
        async function cargarModelosBOM() {
            try {
                const response = await fetch('/listar_modelos_bom');
                if (!response.ok) {
                    console.warn('No se pudieron cargar modelos BOM, usando modelos por defecto');
                    return;
                }
                
                const modelos = await response.json();
                console.log('🔧 DEBUG: Modelos BOM disponibles:', modelos);
                
                const dropdownList = document.getElementById('salidaDropdownList');
                if (dropdownList && Array.isArray(modelos) && modelos.length > 0) {
                    // Limpiar opciones existentes
                    dropdownList.innerHTML = '';
                    
                    // Agregar modelos del BOM
                    modelos.forEach((modelo, index) => {
                        const item = document.createElement('div');
                        item.className = 'salida-dropdown-item';
                        
                        // Manejar tanto objetos como strings
                        let modeloTexto;
                        if (typeof modelo === 'object' && modelo !== null) {
                            modeloTexto = modelo.modelo || modelo.name || modelo.id || Object.values(modelo)[0] || '';
                        } else {
                            modeloTexto = String(modelo);
                        }
                        
                        console.log(`🔧 DEBUG Modelo ${index}:`, modelo, '-> Texto:', modeloTexto);
                        
                        if (modeloTexto && modeloTexto.trim()) {
                            item.dataset.value = modeloTexto;
                            item.textContent = modeloTexto;
                            item.onclick = () => seleccionarModeloSalida(modeloTexto);
                            dropdownList.appendChild(item);
                        }
                    });
                    
                    console.log('✅ DEBUG: Modelos cargados en dropdown:', dropdownList.children.length);
                    console.log('🔧 DEBUG: Primer modelo ejemplo:', modelos[0]);
                } else {
                    console.log('⚠️ DEBUG: No hay modelos disponibles o elemento no encontrado');
                }
                
            } catch (error) {
                console.error('❌ DEBUG: Error al cargar modelos BOM:', error);
                // Si hay error, mantener los modelos por defecto que ya están en el HTML
            }
        }

        // Función para filtrar modelos en el dropdown searchable
        function filtrarModelosSalida() {
            const searchInput = document.getElementById('salida_modelo_search');
            const dropdownList = document.getElementById('salidaDropdownList');
            const searchTerm = searchInput.value.toLowerCase();
            
            // Mostrar el dropdown
            dropdownList.style.display = 'block';
            
            const items = dropdownList.querySelectorAll('.salida-dropdown-item');
            let hasVisibleItems = false;
            
            items.forEach(item => {
                const modeloText = item.textContent.toLowerCase();
                if (modeloText.includes(searchTerm)) {
                    item.classList.remove('hidden');
                    hasVisibleItems = true;
                } else {
                    item.classList.add('hidden');
                }
            });
            
            // Si no hay coincidencias, ocultar el dropdown
            if (!hasVisibleItems && searchTerm.length > 0) {
                dropdownList.style.display = 'none';
            }
        }

        // Función para mostrar dropdown
        function mostrarDropdownSalida() {
            const dropdownList = document.getElementById('salidaDropdownList');
            const searchInput = document.getElementById('salida_modelo_search');
            
            if (searchInput.value.trim() === '') {
                // Si el input está vacío, mostrar todos los modelos
                const items = dropdownList.querySelectorAll('.salida-dropdown-item');
                items.forEach(item => {
                    item.classList.remove('hidden');
                });
            }
            
            dropdownList.style.display = 'block';
        }

        // Función para seleccionar un modelo del dropdown
        function seleccionarModeloSalida(modelo) {
            const searchInput = document.getElementById('salida_modelo_search');
            const dropdownList = document.getElementById('salidaDropdownList');
            const hiddenInput = document.getElementById('salida_modelo');
            
            searchInput.value = modelo;
            hiddenInput.value = modelo;
            dropdownList.style.display = 'none';
            
            console.log(`✅ Modelo seleccionado desde dropdown: ${modelo}`);
            
            // Cargar BOM para el modelo seleccionado
            cargarBOMPorModelo(modelo);
        }

        // Event listener para cerrar dropdown cuando se hace clic fuera
        document.addEventListener('click', function(event) {
            const searchContainer = document.querySelector('.salida-search-container');
            const dropdownList = document.getElementById('salidaDropdownList');
            
            if (searchContainer && !searchContainer.contains(event.target)) {
                dropdownList.style.display = 'none';
            }
        });

        // Nueva función para cargar BOM automáticamente cuando se selecciona un modelo
        async function cargarBOMPorModelo(modelo) {
            console.log('🔧 DEBUG: Modelo seleccionado:', modelo);
            
            if (!modelo || modelo === '') {
                // Si no hay modelo seleccionado, limpiar las tablas
                limpiarTablasBOM();
                return;
            }

            try {
                mostrarMensajeSimple(`Cargando BOM para modelo: ${modelo}...`, 'info');

                const url = `/consultar_bom?modelo=${encodeURIComponent(modelo)}`;
                console.log('🔧 DEBUG: URL de consulta:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const bomData = await response.json();

                console.log('📊 DEBUG: Datos BOM recibidos para modelo:', modelo, bomData);

                if (Array.isArray(bomData) && bomData.length > 0) {
                    actualizarTablaBOMRegistro(bomData);
                    mostrarMensajeSimple(`BOM cargado: ${bomData.length} componentes encontrados para ${modelo}`, 'success');
                } else {
                    limpiarTablasBOM();
                    mostrarMensajeSimple(`No se encontraron componentes BOM para el modelo: ${modelo}`, 'info');
                    console.log('⚠️ DEBUG: No hay datos BOM o array vacío:', bomData);
                }

            } catch (error) {
                console.error('❌ DEBUG: Error al cargar BOM:', error);
                mostrarMensajeSimple('Error al cargar BOM: ' + error.message, 'error');
                limpiarTablasBOM();
            }
        }

        // Función para actualizar la primera tabla con los datos del BOM
        function actualizarTablaBOMRegistro(bomData) {
            const tbody1 = document.getElementById('tabla1BOM');
            const tbody2 = document.getElementById('tabla2BOM');
            
            if (!tbody1) return;

            if (bomData.length === 0) {
                tbody1.innerHTML = '<tr><td colspan="5" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">No hay componentes BOM para este modelo</td></tr>';
                if (tbody2) {
                    tbody2.innerHTML = '<tr><td colspan="6" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Seleccione un componente de la tabla izquierda</td></tr>';
                }
                return;
            }

            let html = '';
            bomData.forEach((item, index) => {
                // Obtener campos con los nombres correctos que vienen del backend
                const numeroParte = item.numeroParte || item.numero_parte || item.part_number || '';
                const especificacion = item.especificacionMaterial || item.descripcion || item.especificacion || item.description || '';
                const cantidadTotal = item.cantidadTotal || item.cantidad_total || item.cantidad_requerida || item.cantidad || '';
                const unidad = item.unidad || item.unit || item.uom || 'PCS';
                
                console.log('🔧 DEBUG Item BOM:', {
                    original: item,
                    numeroParte,
                    especificacion,
                    cantidadTotal,
                    unidad
                });
                
                html += `
                    <tr style="cursor: pointer; background-color: #2c3e50; color: #ecf0f1;" onclick="seleccionarComponenteBOM('${index}', '${numeroParte}', '${especificacion}', '${cantidadTotal}')" onmouseover="this.style.backgroundColor='#34495e'" onmouseout="this.style.backgroundColor='#2c3e50'">
                        <td style="padding: 8px; border: 1px solid #34495e;"><strong style="color: #3498db;">${numeroParte}</strong></td>
                        <td style="padding: 8px; border: 1px solid #34495e;">${especificacion}</td>
                        <td style="padding: 8px; border: 1px solid #34495e; text-align: center; font-weight: bold; color: #e67e22;">${cantidadTotal}</td>
                        <td style="padding: 8px; border: 1px solid #34495e; text-align: center;">${unidad}</td>
                        <td style="padding: 8px; border: 1px solid #34495e; text-align: center;">
                            <button class="material-btn small" onclick="event.stopPropagation(); transferirComponenteAFormulario('${numeroParte}', '${especificacion}')" style="padding: 4px 8px; font-size: 10px; background-color: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                Usar
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody1.innerHTML = html;
            
            // Limpiar la segunda tabla hasta que se seleccione algo
            if (tbody2) {
                tbody2.innerHTML = '<tr><td colspan="6" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Haga clic en un componente para ver detalles</td></tr>';
            }
        }

        // Función para seleccionar un componente y mostrar detalles en la segunda tabla
        async function seleccionarComponenteBOM(index, numeroParte, descripcion, cantidadRequerida) {
            const tbody2 = document.getElementById('tabla2BOM');
            if (!tbody2) return;

            try {
                // Buscar si existe el material en inventario
                const response = await fetch(`/buscar_material_por_numero_parte?numero_parte=${encodeURIComponent(numeroParte)}`);
                const data = await response.json();

                let html = '';
                if (data.success && data.materiales && data.materiales.length > 0) {
                    // Si hay materiales disponibles
                    data.materiales.forEach(material => {
                        const cantidadDisponible = parseFloat(material.cantidad_actual) || 0;
                        const cantidadReq = parseFloat(cantidadRequerida) || 0;
                        const suficiente = cantidadDisponible >= cantidadReq;
                        
                        html += `
                            <tr style="background-color: ${suficiente ? '#27ae60' : '#e74c3c'}; color: #ecf0f1;">
                                <td style="padding: 8px; border: 1px solid #34495e;"><strong style="color: #3498db;">${material.numero_parte || ''}</strong></td>
                                <td style="padding: 8px; border: 1px solid #34495e;">${material.especificacion || descripcion}</td>
                                <td style="padding: 8px; border: 1px solid #34495e; text-align: center; font-weight: bold; color: #ecf0f1;">
                                    ${cantidadDisponible}
                                </td>
                                <td style="padding: 8px; border: 1px solid #34495e; text-align: center; font-weight: bold; color: #f39c12;">
                                    ${cantidadReq}
                                </td>
                                <td style="padding: 8px; border: 1px solid #34495e; text-align: center;">
                                    <span style="padding: 4px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; color: #2c3e50; background-color: ${suficiente ? '#2ecc71' : '#e74c3c'};">
                                        ${suficiente ? '✓ OK' : '✗ FALTA'}
                                    </span>
                                </td>
                                <td style="padding: 8px; border: 1px solid #34495e;">${material.codigo_material || ''}</td>
                            </tr>
                        `;
                    });
                } else {
                    // Si no hay materiales disponibles
                    html = `
                        <tr style="background-color: #f39c12; color: #2c3e50;">
                            <td style="padding: 8px; border: 1px solid #34495e;"><strong>${numeroParte}</strong></td>
                            <td style="padding: 8px; border: 1px solid #34495e;">${descripcion}</td>
                            <td style="padding: 8px; border: 1px solid #34495e; text-align: center; font-weight: bold;">0</td>
                            <td style="padding: 8px; border: 1px solid #34495e; text-align: center; font-weight: bold;">${cantidadRequerida}</td>
                            <td style="padding: 8px; border: 1px solid #34495e; text-align: center;">
                                <span style="padding: 4px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; color: #2c3e50; background-color: #ffc107;">
                                    NO DISPONIBLE
                                </span>
                            </td>
                            <td style="padding: 8px; border: 1px solid #34495e;">-</td>
                        </tr>
                    `;
                }

                tbody2.innerHTML = html;

            } catch (error) {
                console.error('❌ Error al buscar material:', error);
                tbody2.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data" style="color: #e74c3c;">
                            Error al buscar información del material
                        </td>
                    </tr>
                `;
            }
        }

        // Función para transferir componente seleccionado al formulario de registro
        function transferirComponenteAFormulario(numeroParte, descripcion) {
            // Llenar los campos del formulario
            const numeroParteInput = document.getElementById('salida_numero_parte');
            const especificacionInput = document.getElementById('salida_especificacion_material');

            if (numeroParteInput) {
                numeroParteInput.value = numeroParte;
                numeroParteInput.style.backgroundColor = '#e3f2fd';
                numeroParteInput.style.color = '#1565c0';
                numeroParteInput.style.fontWeight = 'bold';
            }

            if (especificacionInput) {
                especificacionInput.value = descripcion;
                especificacionInput.style.backgroundColor = '#e3f2fd';
                especificacionInput.style.color = '#1565c0';
                especificacionInput.style.fontWeight = 'bold';
            }

            // Enfocar el campo de código de material para continuar
            setTimeout(() => {
                const codigoInput = document.getElementById('salida_codigo_material_recibido');
                if (codigoInput) {
                    codigoInput.focus();
                }
            }, 300);

            mostrarExito(`Transferido al formulario: ${numeroParte}`);
        }

        // Función para limpiar las tablas BOM
        function limpiarTablasBOM() {
            const tbody1 = document.getElementById('tabla1BOM');
            const tbody2 = document.getElementById('tabla2BOM');
            
            if (tbody1) {
                tbody1.innerHTML = '<tr><td colspan="5" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Seleccione un modelo para ver componentes</td></tr>';
            }
            
            if (tbody2) {
                tbody2.innerHTML = '<tr><td colspan="6" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Seleccione un componente de la tabla izquierda</td></tr>';
            }
        }

        async function buscarMaterialPorCodigo(codigo) {
            try {
                mostrarCargando('Buscando material...');
                
                const response = await fetch(`/buscar_material_por_codigo?codigo_recibido=${encodeURIComponent(codigo)}`);
                const data = await response.json();

                if (data.success && data.material) {
                    materialActual = data.material;
                    rellenarCamposMaterial(data.material);
                    // ✅ OCULTAR mensaje de carga cuando termine exitosamente
                    // (el mensaje se oculta automáticamente en rellenarCamposMaterial)
                } else {
                    limpiarCamposMaterial();
                    mostrarError(data.error || 'Material no encontrado');
                }
            } catch (error) {
                console.error('Error al buscar material:', error);
                mostrarError('Error al buscar material');
                limpiarCamposMaterial();
            }
        }

        function rellenarCamposMaterial(material) {
            // Rellenar todos los campos con los datos del material
            const campos = {
                'salida_codigo_material_original': material.codigo_material_original || '',
                'salida_codigo_material': material.codigo_material || '',
                'salida_especificacion_material': material.especificacion || '',
                'salida_numero_parte': material.numero_parte || '',
                'salida_cantidad_actual': material.cantidad_actual || '',
                'salida_numero_lote_material': material.numero_lote_material || ''
            };

            Object.keys(campos).forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = campos[id];
                    
                    // Colorear el campo de cantidad según el stock disponible
                    if (id === 'salida_cantidad_actual') {
                        const stockDisponible = parseFloat(material.cantidad_actual) || 0;
                        if (stockDisponible <= 0) {
                            input.style.backgroundColor = '#ffebee';
                            input.style.color = '#c62828';
                            input.style.fontWeight = 'bold';
                        } else if (stockDisponible <= 10) {
                            input.style.backgroundColor = '#fff3e0';
                            input.style.color = '#f57c00';
                            input.style.fontWeight = 'bold';
                        } else {
                            input.style.backgroundColor = '#e8f5e8';
                            input.style.color = '#2e7d32';
                            input.style.fontWeight = 'bold';
                        }
                    }
                    
                    // Destacar el número de lote de material cuando se llene
                    if (id === 'salida_numero_lote_material' && campos[id]) {
                        input.style.backgroundColor = '#e3f2fd';
                        input.style.color = '#1565c0';
                        input.style.fontWeight = 'bold';
                        input.style.border = '2px solid #2196f3';
                    }
                }
            });

            // Mostrar mensaje más detallado
            let mensaje = `Material encontrado. Stock disponible: ${material.cantidad_actual}`;
            
            if (material.numero_lote_material) {
                mensaje += ` | Lote: ${material.numero_lote_material}`;
            }
            
            if (material.cantidad_original && material.total_salidas !== undefined) {
                mensaje += ` (Original: ${material.cantidad_original}, Salidas: ${material.total_salidas})`;
            }
            
            if (parseFloat(material.cantidad_actual) <= 0) {
                mostrarError(`${mensaje} - NO SE PUEDEN HACER MÁS SALIDAS`);
            } else if (parseFloat(material.cantidad_actual) <= 10) {
                mostrarInfo(`${mensaje} - STOCK BAJO`);
            } else {
                mostrarExito(mensaje);
            }
        }

        function limpiarCamposMaterial() {
            // Limpiar campo de código de material recibido
            const codigoInput = document.getElementById('salida_codigo_material_recibido');
            if (codigoInput) {
                codigoInput.value = '';
            }
            
            // Limpiar todos los campos del material
            const camposALimpiar = [
                'salida_codigo_material_original',
                'salida_codigo_material', 
                'salida_especificacion_material',
                'salida_numero_parte',
                'salida_cantidad_actual',
                'salida_numero_lote_material'
            ];
            
            camposALimpiar.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = '';
                    // Resetear estilos
                    input.style.backgroundColor = '';
                    input.style.color = '';
                    input.style.fontWeight = '';
                }
            });
            
            // Limpiar verificación
            limpiarVerificacion();
            
            // Resetear variables globales
            materialActual = null;
            verificacionCompletada = false;
            
            // Enfocar nuevamente el campo de código
            setTimeout(() => {
                if (codigoInput) {
                    codigoInput.focus();
                }
            }, 100);
        }

        function reiniciarFormulario() {
            // Limpiar todos los campos del formulario
            const campos = [
                'salida_codigo_material_recibido'
            ];

            campos.forEach(campo => {
                const input = document.getElementById(campo);
                if (input) {
                    input.value = '';
                }
            });

            limpiarCamposMaterial();

            // Restablecer fecha actual
            const hoy = new Date().toISOString().split('T')[0];
            const fechaSalidaForm = document.getElementById('salida_fecha_salida_form');
            if (fechaSalidaForm) {
                fechaSalidaForm.value = hoy;
            }

            mostrarInfo('Formulario reiniciado - El modelo seleccionado se mantiene');
        }

        async function guardarSalida() {
            try {
                // Validar campos requeridos
                const codigoRecibido = document.getElementById('salida_codigo_material_recibido')?.value.trim() || '';
                const modeloSeleccionado = document.getElementById('salida_modelo')?.value || '';

                if (!codigoRecibido) {
                    mostrarError('Debe ingresar el código de material recibido');
                    return;
                }

                if (!modeloSeleccionado) {
                    mostrarError('Debe seleccionar un modelo');
                    return;
                }

                if (!materialActual) {
                    mostrarError('No se ha encontrado información del material');
                    return;
                }

                // Verificar que el material tenga número de lote
                if (!materialActual.numero_lote_material) {
                    mostrarError('El material no tiene número de lote asignado');
                    return;
                }

                // Usar automáticamente la cantidad actual como cantidad de salida
                const cantidadSalida = parseFloat(materialActual.cantidad_actual) || 0;
                
                if (cantidadSalida <= 0) {
                    mostrarError('No hay stock disponible para realizar la salida');
                    return;
                }

                mostrarCargando('Procesando salida...');

                // Preparar datos para enviar
                const datosEnvio = {
                    codigo_material_recibido: codigoRecibido,
                    cantidad_salida: cantidadSalida,
                    modelo: modeloSeleccionado,
                    numero_lote: materialActual.numero_lote_material || '', // Usar el número de lote del material
                    fecha_salida: document.getElementById('salida_fecha_salida_form')?.value || '',
                    depto_salida: 'Producción', // Valor por defecto
                    proceso_salida: 'SMT 1st SIDE' // Valor por defecto
                };

                const response = await fetch('/procesar_salida_material', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datosEnvio)
                });

                const data = await response.json();

                if (data.success) {
                    // ✅ OPTIMIZACIÓN: Mensajes más informativos según el tipo de respuesta
                    if (data.optimized) {
                        mostrarExito(`🚀 SALIDA ULTRA-RÁPIDA COMPLETADA | Stock restante: ${data.cantidad_restante || 'N/A'}`);
                        
                        // Mostrar información adicional sobre optimización
                        setTimeout(() => {
                            mostrarInfo('💡 Optimización activa: Inventario general actualizándose en segundo plano');
                        }, 1500);
                    } else {
                        mostrarExito(data.message);
                    }
                    
                    // NUEVO COMPORTAMIENTO: Ya no se eliminan registros del almacén
                    // El historial se preserva completo y el inventario se maneja en otra tabla
                    
                    if (data.nota && !data.optimized) {
                        // Mostrar información adicional sobre el nuevo comportamiento
                        setTimeout(() => {
                            mostrarInfo(data.nota);
                        }, 2000);
                    }
                    
                    // Actualizar la interfaz para mostrar la cantidad calculada (no la real del almacén)
                    if (materialActual && data.cantidad_restante !== undefined) {
                        // Actualizar cantidad mostrada (calculada)
                        const cantidadActualInput = document.getElementById('salida_cantidad_actual');
                        
                        if (cantidadActualInput) {
                            cantidadActualInput.value = data.cantidad_restante;
                            cantidadActualInput.style.color = data.cantidad_restante <= 0 ? '#e74c3c' : '#27ae60';
                        }
                        
                        // Si el stock calculado es 0 o menos, mostrar advertencia
                        if (data.cantidad_restante <= 0) {
                            setTimeout(() => {
                                mostrarInfo('Stock agotado para este lote. El historial se mantiene en almacén.');
                            }, 3000);
                        }
                    }

                    // Limpiar solo el código de material para permitir nueva búsqueda
                    // El modelo se mantiene fijo como solicitado
                    const codigoInput = document.getElementById('salida_codigo_material_recibido');
                    if (codigoInput) codigoInput.value = '';
                    
                    // Limpiar campos del material encontrado
                    limpiarCamposMaterial();

                    // ✅ OPTIMIZACIÓN: Tiempo reducido para actualización de tabla (solo si está visible)
                    const historialSection = document.getElementById('historialSection');
                    if (historialSection && historialSection.style.display !== 'none') {
                        setTimeout(() => {
                            consultarSalidas();
                        }, data.optimized ? 300 : 1000);
                    }

                } else {
                    mostrarError(data.error || 'Error al procesar la salida');
                }

            } catch (error) {
                console.error('Error al guardar salida:', error);
                mostrarError('Error interno al procesar la salida');
            }
        }

        async function consultarSalidas() {
            try {
                const codigoFiltro = document.getElementById('salida_filtro_codigo')?.value?.trim() || '';
                const fechaDesde = document.getElementById('salida_fecha_desde')?.value || '';
                const fechaHasta = document.getElementById('salida_fecha_hasta')?.value || '';

                // Validación de fechas
                if (fechaDesde && fechaHasta && fechaDesde > fechaHasta) {
                    mostrarError('La fecha desde no puede ser mayor que la fecha hasta');
                    return;
                }

                // Mostrar mensaje específico según los filtros aplicados
                let mensajeCarga = 'Consultando salidas...';
                if (fechaDesde || fechaHasta || codigoFiltro) {
                    mensajeCarga = 'Aplicando filtros y consultando...';
                }
                mostrarCargando(mensajeCarga);

                let url = '/consultar_historial_salidas';
                const params = new URLSearchParams();

                // Agregar filtro de código de material
                if (codigoFiltro) {
                    params.append('codigo_material', codigoFiltro);
                }

                // Agregar filtros de fecha
                if (fechaDesde) {
                    params.append('fecha_desde', fechaDesde);
                }
                if (fechaHasta) {
                    params.append('fecha_hasta', fechaHasta);
                }

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                // Debug: mostrar la URL que se está enviando
                console.log('🔍 Consultando URL:', url);
                console.log('📅 Filtros aplicados:', {
                    codigo: codigoFiltro,
                    fechaDesde: fechaDesde,
                    fechaHasta: fechaHasta
                });

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const salidas = await response.json();

                console.log('📊 Respuesta del servidor:', salidas);

                if (Array.isArray(salidas)) {
                    actualizarTablaSalidas(salidas);
                    const totalInfo = document.getElementById('salida_totalInfo');
                    if (totalInfo) {
                        const mensaje = `Total Rows: ${salidas.length}`;
                        const filtros = [];
                        if (codigoFiltro) {
                            filtros.push(`Código: ${codigoFiltro}`);
                        }
                        if (fechaDesde) {
                            filtros.push(`Desde: ${fechaDesde}`);
                        }
                        if (fechaHasta) {
                            filtros.push(`Hasta: ${fechaHasta}`);
                        }
                        
                        totalInfo.textContent = filtros.length > 0 ? 
                            `${mensaje} | Filtros: ${filtros.join(', ')}` : mensaje;
                    }
                    
                    // ✅ OCULTAR mensaje de carga cuando termine exitosamente
                    ocultarMensaje();
                } else {
                    console.error('❌ Error en respuesta:', salidas);
                    mostrarError(salidas.error || 'Error al consultar salidas');
                }

            } catch (error) {
                console.error('❌ Error al consultar salidas:', error);
                mostrarError('Error al consultar salidas: ' + error.message);
            }
        }

        function limpiarFiltros() {
            const codigoFiltro = document.getElementById('salida_filtro_codigo');
            const fechaDesde = document.getElementById('salida_fecha_desde');
            const fechaHasta = document.getElementById('salida_fecha_hasta');
            
            if (codigoFiltro) codigoFiltro.value = '';
            if (fechaDesde) fechaDesde.value = '';
            if (fechaHasta) fechaHasta.value = '';
            
            // Consultar automáticamente con filtros limpiados
            consultarSalidas();
            
            mostrarMensajeSimple('Filtros limpiados', 'info');
        }

        function actualizarTablaSalidas(salidas) {
            const tbody = document.querySelector('#salida_tablaSalidas tbody');
            if (!tbody) return;
            
            if (salidas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="no-data">No hay dato registrado</td></tr>';
                return;
            }

            let html = '';
            salidas.forEach(salida => {
                html += `
                    <tr>
                        <td>${salida.fecha_salida || ''}</td>
                        <td>${salida.proceso_salida || ''}</td>
                        <td>${salida.codigo_material_recibido || ''}</td>
                        <td>${salida.codigo_material || ''}</td>
                        <td>${salida.numero_parte || ''}</td>
                        <td style="text-align: center;">
                            <input type="checkbox" ${salida.disp ? 'checked' : ''} disabled>
                        </td>
                        <td style="text-align: center;">
                            <input type="checkbox" ${salida.hist ? 'checked' : ''} disabled>
                        </td>
                        <td>${salida.codigo_material_original || ''}</td>
                        <td>${salida.numero_lote || ''}</td>
                        <td>${salida.maquina_linea || ''}</td>
                        <td>${salida.departamento || ''}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function formatearFecha(fechaISO) {
            if (!fechaISO) return '';
            try {
                const fecha = new Date(fechaISO);
                return fecha.toLocaleString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return fechaISO;
            }
        }

        function exportarExcel() {
            try {
                // Obtener datos de la tabla
                const tabla = document.getElementById('salida_tablaSalidas');
                if (!tabla) {
                    mostrarError('No se encontró la tabla');
                    return;
                }

                const filas = tabla.querySelectorAll('tbody tr');
                
                if (filas.length === 1 && filas[0].querySelector('.no-data')) {
                    mostrarError('No hay datos para exportar');
                    return;
                }

                // Crear CSV
                let csv = 'Fecha de salida,Proceso de salida,Código material recibido,Código de material,Número de parte,Disp,Hist,Código material original,Número de lote,Máquina(linea),Departamento de salida\n';
                
                filas.forEach(fila => {
                    const celdas = fila.querySelectorAll('td');
                    if (celdas.length > 1) { // Evitar la fila de "no hay datos"
                        const valores = Array.from(celdas).map(celda => 
                            '"' + celda.textContent.replace(/"/g, '""') + '"'
                        );
                        csv += valores.join(',') + '\n';
                    }
                });

                // Descargar archivo
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `salidas_material_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                mostrarExito('Archivo exportado exitosamente');

            } catch (error) {
                console.error('Error al exportar:', error);
                mostrarError('Error al exportar el archivo');
            }
        }

        // Funciones de utilidad para mostrar mensajes
        function mostrarMensaje(mensaje, tipo) {
            // Buscar contenedor de mensajes existente o crear uno
            let contenedor = document.getElementById('salida-mensaje-sistema');
            if (!contenedor) {
                contenedor = document.createElement('div');
                contenedor.id = 'salida-mensaje-sistema';
                contenedor.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 5px;
                    color: white;
                    font-weight: bold;
                    z-index: 10000;
                    max-width: 400px;
                    word-wrap: break-word;
                `;
                document.body.appendChild(contenedor);
            }

            // Establecer el color según el tipo
            switch (tipo) {
                case 'exito':
                    contenedor.style.backgroundColor = '#27ae60';
                    break;
                case 'error':
                    contenedor.style.backgroundColor = '#e74c3c';
                    break;
                case 'info':
                    contenedor.style.backgroundColor = '#3498db';
                    break;
                case 'cargando':
                    contenedor.style.backgroundColor = '#f39c12';
                    break;
                default:
                    contenedor.style.backgroundColor = '#95a5a6';
            }

            contenedor.textContent = mensaje;
            contenedor.style.display = 'block';

            // Auto-ocultar después de cierto tiempo (excepto para "cargando")
            if (tipo !== 'cargando') {
                setTimeout(() => {
                    contenedor.style.display = 'none';
                }, tipo === 'error' ? 5000 : 3000);
            }
        }

        function mostrarExito(mensaje) {
            // Primero ocultar cualquier mensaje anterior (especialmente los de carga)
            ocultarMensaje();
            // Pequeña pausa para asegurar que se oculte el anterior
            setTimeout(() => {
                mostrarMensaje(mensaje, 'exito');
            }, 100);
        }

        function mostrarError(mensaje) {
            // Primero ocultar cualquier mensaje anterior (especialmente los de carga)
            ocultarMensaje();
            // Pequeña pausa para asegurar que se oculte el anterior
            setTimeout(() => {
                mostrarMensaje(mensaje, 'error');
            }, 100);
        }

        function mostrarInfo(mensaje) {
            mostrarMensaje(mensaje, 'info');
        }

        function mostrarCargando(mensaje) {
            mostrarMensaje(mensaje, 'cargando');
        }

        function ocultarMensaje() {
            const contenedor = document.getElementById('salida-mensaje-sistema');
            if (contenedor) {
                contenedor.style.display = 'none';
            }
        }

        // Función global para limpiar al cambiar de página
        window.limpiarControlSalida = function() {
            window.controlSalidaInicializado = false;
            const contenedor = document.getElementById('salida-mensaje-sistema');
            if (contenedor) {
                contenedor.remove();
            }
        };

        // Función de test de conectividad para debugging
        window.testConectividadSalida = function() {
            fetch('/consultar_historial_salidas')
                .then(response => response.ok ? response.json() : Promise.reject('Error HTTP: ' + response.status))
                .then(data => console.log('✅ Conectividad OK'))
                .catch(error => console.error('❌ Error de conectividad:', error));
        };

        // Función global para acceso directo desde consola (debugging)
        window.debugControlSalida = function() {
            return {
                materialActual: materialActual,
                elementosDOM: {
                    codigoInput: !!document.getElementById('salida_codigo_material_recibido'),
                    tablaSalidas: !!document.getElementById('salida_tablaSalidas'),
                    checkbox: !!document.getElementById('salida_registroAutomatico'),
                    modelo: document.getElementById('salida_modelo')?.value || 'No seleccionado'
                }
            };
        };

    </script>
</body>
</html>