<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Salida de Material</title>
    <link rel="stylesheet" href="/static/css/control_salida_material.css">
    <link rel="stylesheet" href="/static/css/control_salida_material_responsive.css">
</head>
<body>
    <div id="control-salida-container">
        <div class="material-toolbar">
            <!-- Contenedor izquierdo: Campo de escaneo -->
            <div class="scan-container">
                <div class="material-form-group">
                    <label>Código de material recibido</label>
                    <input type="text" id="salida_codigo_material_recibido" placeholder="Escanear código aquí..." autocomplete="off">
                </div>
            </div>
            <div class="material-form-group verification-group">
                <label>Verificación de salida (Requerido)</label>
                <input type="text" id="salida_verificacion_codigo" placeholder="Escanear código de verificación..." autocomplete="off" style="border: 2px solid #e74c3c;">
            </div>

            <!-- Contenedor derecho: Checkboxes -->
            <div class="checkbox-container">
                <label style="display: flex; align-items: center; gap: 8px; color: #ecf0f1; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="salida_registroAutomatico" style="transform: scale(1.0); accent-color: #27ae60;" checked>
                    Registro automático
                </label>
                <label style="display: flex; align-items: center; gap: 8px; color: #ecf0f1; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="salida_verificacionBOM" style="transform: scale(1.0); accent-color: #8e44ad;">
                    Verificación de BOM
                </label>
                <label style="display: flex; align-items: center; gap: 8px; color: #ecf0f1; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="salida_peps" style="transform: scale(1.0); accent-color: #27ae60;">
                    PEPS
                </label>
            </div>
        </div>
        <div class="material-form-section">
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label>Modelo <span style="color: #95a5a6; font-size: 11px;">(Opcional)</span></label>
                    <div class="salida-search-container">
                        <input type="text" class="salida-search-dropdown" id="salida_modelo_search" placeholder="Buscar modelo (opcional)..." onkeyup="filtrarModelosSalida()" onclick="mostrarDropdownSalida()" />
                        <div class="salida-dropdown-list" id="salidaDropdownList" style="display: none;">
                            <!-- Los modelos se cargarán dinámicamente aquí -->
                        </div>
                        <!-- Campo oculto para el valor real del modelo -->
                        <input type="hidden" id="salida_modelo" name="modelo" />
                    </div>
                </div>
                <div class="material-form-group">
                    <!-- Campo movido arriba -->
                </div>
                <div class="material-form-group">
                    <button class="material-btn secondary" id="salida_btnGuardarSalida" onclick="procesarSalidaManual()" style="display: none;">Guardar Salida</button>
                </div>
            </div>
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label>Código de material original</label>
                    <input type="text" id="salida_codigo_material_original" readonly>
                </div>
                <div class="material-form-group">
                    <label>Código de material</label>
                    <input type="text" id="salida_codigo_material" readonly>
                </div>
                <div class="material-form-group">
                    <label>Especificación de material</label>
                    <input type="text" id="salida_especificacion_material" readonly>
                </div>
            </div>
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label>Numero de parte</label>
                    <input type="text" id="salida_numero_parte" readonly>
                </div>
                <div class="material-form-group">
                    <label>Cantidad actual</label>
                    <input type="text" id="salida_cantidad_actual" readonly>
                </div>
                <div class="material-form-group">
                    <label>Numero de lote de material</label>
                    <input type="text" id="salida_numero_lote_material" readonly>
                </div>
            </div>
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label>Fecha de salida</label>
                    <input type="date" id="salida_fecha_salida_form" value="">
                </div>
                <div class="material-form-group">
                    <!-- Campo vacío -->
                </div>
                <div class="material-form-group">
                    <!-- Campo vacío -->
                </div>
            </div>
        </div>

        <div class="material-table-container">
            <div class="material-table-controls">
                <button class="material-btn" id="btnRegistroSalida" onclick="mostrarRegistroSalida()">Registro de salida</button>
                <button class="material-btn" id="btnHistorialSalida" onclick="mostrarHistorialSalida()">Historial de salida</button>
                
                <!-- Control de Plan -->
                <div class="plan-control" style="display: flex; align-items: center; gap: 10px; margin-left: auto;">
                    <label style="color: #ecf0f1; font-weight: 600; font-size: 14px;">Plan:</label>
                    <input type="text" id="plan_cantidad" placeholder="500" value="1" 
                           style="width: 60px; padding: 4px 6px; border: 2px solid #3498db; border-radius: 4px; 
                                  background-color: #2c3e50; color: #ecf0f1; font-weight: bold; text-align: center; font-size: 12px;"
                           onchange="actualizarCantidadesPlan()" onkeyup="actualizarCantidadesPlan()">
                    <span style="color: #95a5a6; font-size: 12px;">unidades</span>
                </div>
            </div>

            <!-- Tablas para modo Registro de salida - siempre visibles -->
            <div id="tablasRegistroSalida" class="registro-tablas-container" style="display: flex; gap: 20px; margin: 20px 0;">
                <!-- Primera tabla - Información general del BOM -->
                <div class="tabla-container" style="flex: 1;">
                    <h4 style="margin: 0 0 10px 0; color: #ecf0f1; font-size: 14px; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Componentes del BOM seleccionado</h4>
                    <table class="material-table">
                        <thead>
                            <tr>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Número de parte</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Especificación</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Cantidad total</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">PLAN</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Faltantes</th>
                            </tr>
                        </thead>
                        <tbody id="tabla1BOM">
                            <tr>
                                <td colspan="5" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Seleccione un modelo para ver componentes</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Divisor vertical -->
                <div style="width: 2px; background-color: #bdc3c7; margin: 0 10px; border-radius: 1px;"></div>

                <!-- Segunda tabla - Detalles del material seleccionado -->
                <div class="tabla-container" style="flex: 1;">
                    <h4 style="margin: 0 0 10px 0; color: #ecf0f1; font-size: 14px; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Material actual para salida</h4>
                    <table class="material-table">
                        <thead>
                            <tr>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Número de parte</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Descripción</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Cantidad disponible</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Cantidad requerida</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Estado</th>
                                <th style="background-color: #34495e; color: #ecf0f1; border: 1px solid #2c3e50;">Código de material</th>
                            </tr>
                        </thead>
                        <tbody id="tabla2BOM">
                            <tr>
                                <td colspan="6" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Seleccione un componente de la tabla izquierda</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Controles y tabla de historial -->
            <div id="historialSection" style="display: none;">
                <div class="material-table-controls" id="historialControles" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between;">
                    <!-- Filtros de fecha - lado izquierdo -->
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="material-form-group">
                            <label>Fecha desde</label>
                            <input type="date" id="salida_fecha_desde">
                        </div>
                        <div class="material-form-group">
                            <label>Fecha hasta</label>
                            <input type="date" id="salida_fecha_hasta">
                        </div>
                    </div>
                    
                    <!-- Controles principales - lado derecho -->
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div class="material-form-group">
                            <label>Código de material recibido</label>
                            <input type="text" id="salida_filtro_codigo" placeholder="Buscar por código...">
                        </div>
                        <button class="material-btn secondary" onclick="consultarSalidas()">Consultar</button>
                        <button class="material-btn" onclick="limpiarFiltros()" style="background-color: #95a5a6;">Limpiar filtros</button>
                        <button class="material-btn orange" onclick="exportarExcel()">Exportar el excel</button>
                    </div>
                </div>
                <table class="material-table" id="salida_tablaSalidas">
                    <thead>
                        <tr>
                            <th>Fecha de salida</th>
                            <th>Proceso de salida</th>
                            <th>Código de material recibido</th>
                            <th>Código de material</th>
                            <th>Número de parte</th>
                            <th>Disp.</th>
                            <th>Hist.</th>
                            <th>Código de material original</th>
                            <th>Número de lote</th>
                            <th>Máquina(linea)</th>
                            <th>Departamento de salida</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="11" class="no-data">No hay dato registrado</td>
                        </tr>
                    </tbody>
                </table>
                <div class="total-info" id="salida_totalInfo">Total Rows: 0</div>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================
        // 🚀 CONTROL DE SALIDA OPTIMIZADO PARA ESCANEO CON ENTER
        // ===================================================================
        // 
        // FLUJO ULTRA-RÁPIDO IMPLEMENTADO:
        // 1. Escanear código material ➜ ENTER ➜ Auto-enfoca verificación
        // 2. Escanear código verificación ➜ ENTER ➜ Salida automática (si está activada)
        // 3. Auto-limpia campos ➜ Auto-enfoca código ➜ Listo para siguiente
        //
        // OPTIMIZACIONES:
        // - Event listeners adicionales para garantizar función Enter
        // - Auto-selección de texto al enfocar para escaneo rápido
        // - Tiempos reducidos: 50-100ms (vs 300-500ms anteriores)
        // - Mensajes informativos para guiar flujo de trabajo
        // - Procesamiento instantáneo con verificación exitosa
        // ===================================================================

        // Variables globales
        let materialActual = null;
        let verificacionCompletada = false;

        // Función global para inicializar cuando se muestra el control de salida (para AJAX)
        window.inicializarControlSalidaModule = function() {
            setTimeout(() => {
                inicializarControlSalida();
            }, 100);
        };

        // Función de inicialización simplificada
        function inicializarControlSalida() {
            console.log('🚀 Inicializando Control de Salida...');
            
            try {
                // Establecer fecha actual
                const hoy = new Date().toISOString().split('T')[0];
                const fechaSalidaForm = document.getElementById('salida_fecha_salida_form');
                
                if (fechaSalidaForm) {
                    fechaSalidaForm.value = hoy;
                    console.log('✅ Fecha de salida establecida:', hoy);
                }

                // Establecer fecha actual en los filtros de historial
                const fechaDesde = document.getElementById('salida_fecha_desde');
                const fechaHasta = document.getElementById('salida_fecha_hasta');
                
                if (fechaDesde) {
                    fechaDesde.value = hoy;
                    console.log('✅ Fecha desde establecida:', hoy);
                }
                if (fechaHasta) {
                    fechaHasta.value = hoy;
                    console.log('✅ Fecha hasta establecida:', hoy);
                }

                // Configurar listeners para el checkbox de registro automático
                configurarRegistroAutomatico();

                // Cargar modelos disponibles en el BOM
                cargarModelosBOM();

                // 🚀 OPTIMIZACIÓN: Configurar event listeners adicionales para Enter en campos de escaneo
                setTimeout(() => {
                    configurarEventListenersEscaneo();
                }, 200); // Pequeña demora para asegurar que el DOM esté listo

                // Enfocar campo de código
                const codigoInput = document.getElementById('salida_codigo_material_recibido');
                if (codigoInput) {
                    setTimeout(() => {
                        codigoInput.focus();
                        console.log('✅ Campo de código enfocado');
                    }, 100);
                } else {
                    console.error('❌ Campo de código no encontrado');
                }

                // Mostrar por defecto las tablas de registro
                mostrarRegistroSalida();

                // No cargar datos automáticamente - solo cuando se haga clic en "Consultar"
                console.log('✅ Control de Salida inicializado correctamente');
                
            } catch (error) {
                console.error('❌ Error en inicialización:', error);
                mostrarMensajeSimple('Error en inicialización: ' + error.message, 'error');
            }
        }

        // 🚀 Nueva función para configurar event listeners optimizados de escaneo
        function configurarEventListenersEscaneo() {
            const codigoInput = document.getElementById('salida_codigo_material_recibido');
            const verificacionInput = document.getElementById('salida_verificacion_codigo');
            
            if (codigoInput) {
                // Remover listeners existentes y agregar uno unificado
                codigoInput.removeEventListener('keydown', procesarEscaneoRapido);
                codigoInput.removeEventListener('keypress', procesarEscaneoRapido);
                
                // Listener único para Enter (usar keydown para mejor compatibilidad)
                codigoInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' || event.keyCode === 13) {
                        event.preventDefault();
                        event.stopPropagation();
                        console.log('🚀 Enter detectado en código material');
                        procesarEscaneoRapido(event);
                    }
                });
                
                // Auto-seleccionar texto al enfocar para escaneo rápido
                codigoInput.addEventListener('focus', function() {
                    this.select();
                });
                
                // Mostrar ayuda al enfocar por primera vez
                codigoInput.addEventListener('focus', function() {
                    if (!this.dataset.helpShown) {
                        mostrarMensajeSimple('💡 Flujo rápido: Escanear ➜ Enter ➜ Verificar ➜ Enter', 'info');
                        this.dataset.helpShown = 'true';
                    }
                }, { once: true });
            }
            
            if (verificacionInput) {
                // Remover listeners existentes y agregar uno unificado
                verificacionInput.removeEventListener('keydown', procesarVerificacion);
                verificacionInput.removeEventListener('keypress', procesarVerificacion);
                
                // Listener único para Enter (usar keydown para mejor compatibilidad)
                verificacionInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' || event.keyCode === 13) {
                        event.preventDefault();
                        event.stopPropagation();
                        console.log('🚀 Enter detectado en verificación');
                        procesarVerificacion(event);
                    }
                });
                
                // Auto-seleccionar texto al enfocar para escaneo rápido
                verificacionInput.addEventListener('focus', function() {
                    this.select();
                });
            }
            
            console.log('✅ Event listeners de escaneo configurados correctamente');
        }

        // Nueva función para configurar el comportamiento del registro automático
        function configurarRegistroAutomatico() {
            const checkbox = document.getElementById('salida_registroAutomatico');
            const btnGuardar = document.getElementById('salida_btnGuardarSalida');
            
            if (checkbox && btnGuardar) {
                // Configurar estado inicial
                actualizarModoRegistro();
                
                // Listener para cambios en el checkbox
                checkbox.addEventListener('change', function() {
                    actualizarModoRegistro();
                });
            } else {
                console.error('❌ No se pudo configurar registro automático - elementos no encontrados');
            }
        }

        // Función para actualizar el modo de registro según el checkbox
        function actualizarModoRegistro() {
            const checkbox = document.getElementById('salida_registroAutomatico');
            const btnGuardar = document.getElementById('salida_btnGuardarSalida');
            
            if (checkbox && btnGuardar) {
                if (checkbox.checked) {
                    // Modo automático: ocultar botón
                    btnGuardar.style.display = 'none';
                } else {
                    // Modo manual: mostrar botón
                    btnGuardar.style.display = 'block';
                }
            }
        }

        // Nueva función para procesar verificación de salida
        function procesarVerificacion(event) {
            console.log('🔍 procesarVerificacion llamada, event:', event);
            
            // Siempre verificar Enter independientemente del tipo de evento
            if (event.key === 'Enter' || event.keyCode === 13 || event.type === 'click') {
                event.preventDefault();
                
                const codigoVerificacion = event.target.value.trim();
                console.log('📝 Código verificación:', codigoVerificacion);
                
                if (!codigoVerificacion) {
                    console.log('⚠️ Código verificación vacío');
                    return;
                }
                
                if (!materialActual) {
                    mostrarMensajeSimple('Primero debe escanear un material', 'error');
                    event.target.value = '';
                    return;
                }
                
                // Verificar si el código escaneado coincide con algún número del material actual
                const coincidencias = verificarCoincidencias(codigoVerificacion, materialActual);
                console.log('✅ Coincidencias encontradas:', coincidencias);
                
                if (coincidencias.length > 0) {
                    mostrarMensajeSimple(`✅ Verificado: ${coincidencias.join(', ')}`, 'success');
                    verificacionCompletada = true;
                    
                    // Cambiar el borde del campo de verificación a verde
                    event.target.style.border = '2px solid #27ae60';
                    event.target.readOnly = true;
                    
                    // VERIFICAR SI REGISTRO AUTOMÁTICO ESTÁ ACTIVADO
                    const checkbox = document.getElementById('salida_registroAutomatico');
                    const registroAutomatico = checkbox ? checkbox.checked : false;
                    console.log('🔄 Registro automático:', registroAutomatico);
                    
                    if (registroAutomatico) {
                        // 🚀 PROCESAMIENTO INSTANTÁNEO: Sin demoras para máxima eficiencia
                        mostrarMensajeSimple('🚀 Procesando salida automáticamente...', 'info');
                        setTimeout(async () => {
                            await procesarSalidaAutomaticaDespuesVerificacion();
                        }, 100); // Reducido de 500ms a 100ms para mayor velocidad
                    } else {
                        // Modo manual: mostrar mensaje para usar botón
                        mostrarMensajeSimple('Verificación completada - Haga clic en "Guardar Salida"', 'info');
                    }
                    
                } else {
                    mostrarMensajeSimple('❌ Código no coincide con el material', 'error');
                    verificacionCompletada = false;
                    event.target.value = '';
                    event.target.focus();
                }
            }
        }

        // Función para verificar coincidencias entre el código escaneado y los datos del material
        function verificarCoincidencias(codigoVerificacion, material) {
            const coincidencias = [];
            
            // Lista de campos a verificar
            const camposAVerificar = [
                { campo: 'codigo_material_recibido', nombre: 'Código Recibido' },
                { campo: 'codigo_material', nombre: 'Código Material' },
                { campo: 'codigo_material_original', nombre: 'Código Original' },
                { campo: 'numero_parte', nombre: 'Número de Parte' },
                { campo: 'numero_lote_material', nombre: 'Lote' }
            ];
            
            camposAVerificar.forEach(item => {
                const valorCampo = material[item.campo];
                if (valorCampo && codigoVerificacion.includes(valorCampo)) {
                    coincidencias.push(item.nombre);
                }
                // También verificar coincidencia parcial o completa
                if (valorCampo && valorCampo.includes(codigoVerificacion)) {
                    if (!coincidencias.includes(item.nombre)) {
                        coincidencias.push(item.nombre);
                    }
                }
            });
            
            return coincidencias;
        }

        // Función para limpiar verificación cuando se cambie de material
        // 🚀 Función optimizada para limpiar verificación y facilitar flujo rápido
        function limpiarVerificacion() {
            const campoVerificacion = document.getElementById('salida_verificacion_codigo');
            
            if (campoVerificacion) {
                campoVerificacion.value = '';
                campoVerificacion.style.border = '2px solid #e74c3c';
                campoVerificacion.readOnly = false;
                
                // Auto-enfocar el campo de verificación para flujo continuo de escaneo
                setTimeout(() => {
                    campoVerificacion.focus();
                }, 20); // Tiempo mínimo para asegurar que el campo esté listo
            }
            
            verificacionCompletada = false;
        }

        // 🚀 FUNCIÓN SIMPLE: Limpiar código y enfocar (optimizada para flujo de escaneo rápido)
        function limpiarCodigo() {
            const input = document.getElementById('salida_codigo_material_recibido');
            if (input) {
                input.value = '';
                setTimeout(() => {
                    input.focus();
                    // Mensaje de ayuda para el usuario
                    mostrarMensajeSimple('💡 Escanee código ➜ Enter ➜ Escanee verificación ➜ Enter', 'info');
                }, 50); // Tiempo reducido para mayor eficiencia
            }
        }
        // FUNCIÓN PRINCIPAL: Procesar escaneo ultra rápido
        async function procesarEscaneoRapido(event) {
            console.log('🔍 procesarEscaneoRapido llamada, event:', event);
            
            // Siempre verificar Enter independientemente del tipo de evento
            if (event.key === 'Enter' || event.keyCode === 13 || event.type === 'click') {
                event.preventDefault();
                
                const codigo = event.target.value.trim();
                console.log('📝 Código material:', codigo);
                
                if (!codigo) {
                    console.log('⚠️ Código material vacío');
                    return;
                }
                
                try {
                    // 1. Buscar material primero
                    console.log('🔍 Buscando material con código:', codigo);
                    const response = await fetch(`/buscar_material_por_codigo?codigo_recibido=${encodeURIComponent(codigo)}`);
                    const data = await response.json();

                    if (!data.success || !data.material) {
                        mostrarMensajeSimple(data.error || 'Material no encontrado', 'error');
                        return;
                    }

                    const material = data.material;
                    console.log('✅ Material encontrado:', material);
                    
                    // 2. Rellenar campos del material
                    rellenarCamposMaterial(material);
                    materialActual = material;
                    
                    // 3. Limpiar verificación anterior
                    limpiarVerificacion();
                    
                    // 4. 🚀 ENFOQUE INMEDIATO al campo de verificación para máxima eficiencia
                    const campoVerificacion = document.getElementById('salida_verificacion_codigo');
                    if (campoVerificacion) {
                        // Reducido de 300ms a 50ms para flujo ultra-rápido de escaneo
                        setTimeout(() => {
                            campoVerificacion.focus();
                            mostrarMensajeSimple('👆 Escanee código de verificación', 'info');
                        }, 50);
                    }
                    
                } catch (error) {
                    console.error('❌ Error:', error);
                    mostrarMensajeSimple('Error al buscar material', 'error');
                }
            }
        }

        // Nueva función para procesamiento automático después de verificación exitosa
        // 🚀 Nueva función optimizada para procesamiento automático después de verificación exitosa
        async function procesarSalidaAutomaticaDespuesVerificacion() {
            try {
                const codigo = document.getElementById('salida_codigo_material_recibido')?.value?.trim();
                
                if (!codigo || !materialActual || !verificacionCompletada) {
                    mostrarMensajeSimple('Error: faltan datos para procesar salida', 'error');
                    return;
                }
                
                // 1. Obtener modelo (opcional)
                const modelo = document.getElementById('salida_modelo')?.value || 'SIN_MODELO';
                
                // Mostrar mensaje informativo si no hay modelo seleccionado
                if (modelo === 'SIN_MODELO') {
                    console.log('⚠️ DEBUG: Procesando salida sin modelo específico');
                }

                const cantidadSalida = parseFloat(materialActual.cantidad_actual) || 0;

                if (cantidadSalida <= 0) {
                    mostrarMensajeSimple('Sin stock disponible', 'error');
                    return;
                }

                // 2. Procesar salida automática con optimización
                mostrarMensajeSimple('⚡ Procesando salida...', 'info');
                
                const salidaResponse = await fetch('/procesar_salida_material', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codigo_material_recibido: codigo,
                        cantidad_salida: cantidadSalida,
                        modelo: modelo,
                        numero_lote: materialActual.numero_lote_material || '',
                        fecha_salida: document.getElementById('salida_fecha_salida_form')?.value || '',
                        depto_salida: 'Producción',
                        proceso_salida: 'SMT 1st SIDE',
                        codigo_verificacion: document.getElementById('salida_verificacion_codigo')?.value || ''
                    })
                });

                const salidaData = await salidaResponse.json();

                if (salidaData.success) {
                    const modeloTexto = modelo === 'SIN_MODELO' ? ' (sin modelo)' : ` (${modelo})`;
                    mostrarMensajeSimple(`✅ Salida procesada: ${cantidadSalida}${modeloTexto}`, 'success');
                    
                    // 🔥 MARCAR MATERIAL PROCESADO para actualización forzada
                    if (materialActual && materialActual.numero_parte) {
                        window.ultimoMaterialProcesado = materialActual.numero_parte;
                    }
                    
                    // ACTUALIZAR FALTANTES EN TABLA BOM INMEDIATAMENTE DESPUÉS DE LA SALIDA
                    // 🚀 OPTIMIZACIÓN: Actualización instantánea con refresh del inventario
                    await actualizarFaltantesBOMInstantaneo();
                    
                    // 🚀 FLUJO ULTRA-RÁPIDO: Limpiar campos y preparar para siguiente escaneo
                    setTimeout(() => {
                        limpiarCamposMaterial();
                        // Auto-enfocar campo de código para continuar escaneando
                        const codigoInput = document.getElementById('salida_codigo_material_recibido');
                        if (codigoInput) {
                            codigoInput.focus();
                            mostrarMensajeSimple('👆 Listo para siguiente código', 'info');
                        }
                    }, 800); // Tiempo reducido para flujo más rápido
                    
                } else {
                    mostrarMensajeSimple('Error al procesar salida automática: ' + (salidaData.error || 'Error desconocido'), 'error');
                }
                
            } catch (error) {
                console.error('❌ Error en procesamiento automático:', error);
                mostrarMensajeSimple('Error interno en procesamiento automático', 'error');
            }
        }

        // Nueva función para buscar material sin guardar (modo manual)
        async function buscarMaterialSinGuardar(codigo) {
            try {
                const response = await fetch(`/buscar_material_por_codigo?codigo_recibido=${encodeURIComponent(codigo)}`);
                const data = await response.json();

                if (!data.success || !data.material) {
                    mostrarMensajeSimple(data.error || 'Material no encontrado', 'error');
                    return;
                }

                const material = data.material;
                
                // IMPORTANTE: Solo rellenar campos, NO guardar la salida
                rellenarCamposMaterial(material);
                materialActual = material;
                
                // Limpiar verificación anterior para el nuevo material
                limpiarVerificacion();
                
                // Mensaje claro indicando que debe usar el botón
                mostrarMensajeSimple('Material encontrado - Complete verificación y haga clic en "Guardar Salida"', 'info');
                
                // Enfocar el campo de verificación
                const campoVerificacion = document.getElementById('salida_verificacion_codigo');
                if (campoVerificacion) {
                    setTimeout(() => campoVerificacion.focus(), 500);
                }
                
            } catch (error) {
                console.error('Error:', error);
                mostrarMensajeSimple('Error al buscar material', 'error');
            }
        }

        // Nueva función para procesamiento manual con botón
        async function procesarSalidaManual() {
            const codigo = document.getElementById('salida_codigo_material_recibido')?.value?.trim();
            
            if (!codigo) {
                mostrarMensajeSimple('Ingrese código de material', 'error');
                return;
            }
            
            if (!materialActual) {
                mostrarMensajeSimple('Primero busque el material escaneando o escribiendo código', 'error');
                return;
            }
            
            // VALIDAR VERIFICACIÓN REQUERIDA
            if (!verificacionCompletada) {
                mostrarMensajeSimple('Debe completar la verificación de salida primero', 'error');
                const campoVerificacion = document.getElementById('salida_verificacion_codigo');
                if (campoVerificacion) {
                    campoVerificacion.focus();
                }
                return;
            }
            
            // PROCESAR SALIDA MANUAL
            try {
                // 1. Obtener modelo (opcional)
                const modelo = document.getElementById('salida_modelo')?.value || 'SIN_MODELO';
                
                // Mostrar mensaje informativo si no hay modelo seleccionado
                if (modelo === 'SIN_MODELO') {
                }

                const cantidadSalida = parseFloat(materialActual.cantidad_actual) || 0;

                if (cantidadSalida <= 0) {
                    mostrarMensajeSimple('Sin stock disponible', 'error');
                    return;
                }

                // 2. Procesar salida directa
                const salidaResponse = await fetch('/procesar_salida_material', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codigo_material_recibido: codigo,
                        cantidad_salida: cantidadSalida,
                        modelo: modelo,
                        numero_lote: materialActual.numero_lote_material || '',
                        fecha_salida: document.getElementById('salida_fecha_salida_form')?.value || '',
                        depto_salida: 'Producción', // Valor por defecto
                        proceso_salida: 'SMT 1st SIDE', // Valor por defecto
                        codigo_verificacion: document.getElementById('salida_verificacion_codigo')?.value || ''
                    })
                });

                const salidaData = await salidaResponse.json();

                if (salidaData.success) {
                    const modeloTexto = modelo === 'SIN_MODELO' ? ' (sin modelo)' : ` (${modelo})`;
                    // ✅ OPTIMIZACIÓN: Mostrar mensaje especial para respuesta optimizada
                    if (salidaData.optimized) {
                        mostrarMensajeSimple(`Salida procesada: ${cantidadSalida}${modeloTexto} | Inventario actualizándose`, 'success');
                    } else {
                        mostrarMensajeSimple(`Salida manual procesada: ${cantidadSalida}${modeloTexto}`, 'success');
                    }
                    
                    // 🔥 MARCAR MATERIAL PROCESADO para actualización forzada
                    if (materialActual && materialActual.numero_parte) {
                        window.ultimoMaterialProcesado = materialActual.numero_parte;
                    }
                    
                    // ACTUALIZAR FALTANTES EN TABLA BOM INMEDIATAMENTE DESPUÉS DE LA SALIDA
                    // 🚀 OPTIMIZACIÓN: Actualización instantánea con refresh del inventario
                    await actualizarFaltantesBOMInstantaneo();
                    
                    // Actualizar tabla en background más rápido (solo si está visible)
                    const historialSection = document.getElementById('historialSection');
                    if (historialSection && historialSection.style.display !== 'none') {
                        setTimeout(() => consultarSalidas(), 300);
                    }
                    
                    // Limpiar TODOS los campos después de procesar exitosamente
                    setTimeout(() => {
                        limpiarCamposMaterial();
                    }, 1000);
                    
                } else {
                    mostrarMensajeSimple('Error al procesar salida', 'error');
                }
                
            } catch (error) {
                console.error('❌ Error en procesamiento manual:', error);
                mostrarMensajeSimple('Error interno', 'error');
            }
        }

        // FUNCIÓN ULTRA SIMPLIFICADA: Salida inmediata
        async function procesarSalidaInmediata(codigo) {
            try {
                // 1. Obtener modelo (opcional)
                const modelo = document.getElementById('salida_modelo')?.value || 'SIN_MODELO';
                
                // Mostrar mensaje informativo si no hay modelo seleccionado
                if (modelo === 'SIN_MODELO') {
                }

                // 2. Buscar material y rellenar campos
                const response = await fetch(`/buscar_material_por_codigo?codigo_recibido=${encodeURIComponent(codigo)}`);
                const data = await response.json();

                if (!data.success || !data.material) {
                    mostrarMensajeSimple(data.error || 'Material no encontrado', 'error');
                    limpiarCodigo();
                    return;
                }

                const material = data.material;
                
                // Rellenar campos automáticamente
                rellenarCamposMaterial(material);
                materialActual = material;
                
                // Limpiar verificación anterior para el nuevo material
                limpiarVerificacion();
                
                const cantidadSalida = parseFloat(material.cantidad_actual) || 0;

                if (cantidadSalida <= 0) {
                    mostrarMensajeSimple('Sin stock', 'error');
                    limpiarCodigo();
                    return;
                }

                // VALIDAR VERIFICACIÓN REQUERIDA PARA MODO AUTOMÁTICO
                if (!verificacionCompletada) {
                    mostrarMensajeSimple('Complete la verificación primero', 'warning');
                    const campoVerificacion = document.getElementById('salida_verificacion_codigo');
                    if (campoVerificacion) {
                        campoVerificacion.focus();
                    }
                    return; // No limpiar código para permitir reintento
                }

                // 3. Procesar salida directa
                const salidaResponse = await fetch('/procesar_salida_material', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codigo_material_recibido: codigo,
                        cantidad_salida: cantidadSalida,
                        modelo: modelo,
                        numero_lote: material.numero_lote_material || '',
                        fecha_salida: document.getElementById('salida_fecha_salida_form')?.value || '',
                        depto_salida: 'Producción', // Valor por defecto
                        proceso_salida: 'SMT 1st SIDE', // Valor por defecto
                        codigo_verificacion: document.getElementById('salida_verificacion_codigo')?.value || ''
                    })
                });

                const salidaData = await salidaResponse.json();

                if (salidaData.success) {
                    const modeloTexto = modelo === 'SIN_MODELO' ? ' (sin modelo)' : ` (${modelo})`;
                    // ✅ OPTIMIZACIÓN: Mostrar mensaje especial para respuesta optimizada
                    if (salidaData.optimized) {
                        mostrarMensajeSimple(`🚀 ULTRA-RÁPIDO: ${cantidadSalida}${modeloTexto} | Background processing`, 'success');
                    } else {
                        mostrarMensajeSimple(`Salida OK: ${cantidadSalida}${modeloTexto}`, 'success');
                    }
                    
                    // 🔥 MARCAR MATERIAL PROCESADO para actualización forzada
                    if (materialActual && materialActual.numero_parte) {
                        window.ultimoMaterialProcesado = materialActual.numero_parte;
                    }
                    
                    // ACTUALIZAR FALTANTES EN TABLA BOM INMEDIATAMENTE DESPUÉS DE LA SALIDA
                    // 🚀 OPTIMIZACIÓN: Actualización instantánea con refresh del inventario
                    await actualizarFaltantesBOMInstantaneo();
                    
                    // Actualizar tabla más rápido para mostrar el cambio inmediatamente (solo si está visible)
                    const historialSection = document.getElementById('historialSection');
                    if (historialSection && historialSection.style.display !== 'none') {
                        setTimeout(() => consultarSalidas(), 300);
                    }
                } else {
                    mostrarMensajeSimple('Error en salida', 'error');
                }

                limpiarCodigo();
                limpiarVerificacion(); // Limpiar verificación después de procesar
                
            } catch (error) {
                console.error('Error:', error);
                mostrarMensajeSimple('Error', 'error');
                limpiarCodigo();
            }
        }

        // FUNCIÓN NUEVA: Limpiar todos los campos del material
        function limpiarCamposMaterial() {
            // Limpiar campo de código de material recibido
            const codigoInput = document.getElementById('salida_codigo_material_recibido');
            if (codigoInput) {
                codigoInput.value = '';
            }
            
            // Limpiar todos los campos del material
            const camposALimpiar = [
                'salida_codigo_material_original',
                'salida_codigo_material', 
                'salida_especificacion_material',
                'salida_numero_parte',
                'salida_cantidad_actual',
                'salida_numero_lote_material'
            ];
            
            camposALimpiar.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = '';
                    // Resetear estilos
                    input.style.backgroundColor = '';
                    input.style.color = '';
                    input.style.fontWeight = '';
                }
            });
            
            // Limpiar verificación
            limpiarVerificacion();
            
            // Resetear variables globales
            materialActual = null;
            verificacionCompletada = false;
            
            // Enfocar nuevamente el campo de código
            setTimeout(() => {
                if (codigoInput) {
                    codigoInput.focus();
                }
            }, 100);
        }

        // FUNCIÓN SIMPLE: Limpiar código y enfocar (pero mantener campos rellenados)
        function limpiarCodigo() {
            const input = document.getElementById('salida_codigo_material_recibido');
            if (input) {
                input.value = '';
                setTimeout(() => input.focus(), 200);
            }
        }

        // FUNCIÓN SIMPLE: Mostrar mensaje breve
        function mostrarMensajeSimple(mensaje, tipo) {
            // Buscar o crear contenedor de mensajes
            let info = document.getElementById('salida-info-message');
            if (!info) {
                info = document.createElement('div');
                info.id = 'salida-info-message';
                info.style.position = 'fixed';
                info.style.top = '10px';
                info.style.left = '50%';
                info.style.transform = 'translateX(-50%)';
                info.style.padding = '6px 12px';
                info.style.borderRadius = '4px';
                info.style.fontSize = '12px';
                info.style.fontWeight = '500';
                info.style.zIndex = '9999';
                info.style.display = 'none';
                info.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                info.style.maxWidth = '400px';
                info.style.textAlign = 'center';
                info.style.transition = 'all 0.3s ease';
                document.body.appendChild(info);
            }
            
            info.textContent = mensaje;
            info.style.display = 'block';
            info.style.color = 'white';
            switch(tipo) {
                case 'success':
                    info.style.backgroundColor = '#27ae60';
                    break;
                case 'error':
                    info.style.backgroundColor = '#e74c3c';
                    break;
                case 'info':
                    info.style.backgroundColor = '#3498db';
                    break;
                default:
                    info.style.backgroundColor = '#95a5a6';
            }
            
            setTimeout(() => {
                info.style.display = 'none';
            }, 2500);
        }

        // ===============================================
        // FUNCIÓN ULTRA-OPTIMIZADA PARA ACTUALIZACIÓN INSTANTÁNEA DE FALTANTES
        // ===============================================
        async function actualizarFaltantesBOMInstantaneo() {
            const tbody1 = document.getElementById('tabla1BOM');
            if (!tbody1) return;
            
            const modelo = document.getElementById('salida_modelo')?.value;
            if (!modelo) {
                return;
            }
            
            
            const filas = tbody1.querySelectorAll('tr');
            const planCantidad = parseFloat(document.getElementById('plan_cantidad')?.value || 1);
            
            // Extraer números de parte de las filas existentes
            const numerosParteEnTabla = [];
            filas.forEach(fila => {
                const celdaNumeroParte = fila.querySelector('td:first-child strong');
                if (celdaNumeroParte) {
                    numerosParteEnTabla.push(celdaNumeroParte.textContent.trim());
                }
            });
            
            if (numerosParteEnTabla.length === 0) return;
            
            // 🔥 SÚPER OPTIMIZADO: Consultar inventarios directamente desde inventario_general
            const inventarioMap = new Map();
            
            // Si acabamos de procesar una salida, forzar actualización del inventario primero
            const materialRecienProcesado = window.ultimoMaterialProcesado;
            if (materialRecienProcesado && numerosParteEnTabla.includes(materialRecienProcesado)) {
                try {
                    await fetch(`/forzar_actualizacion_inventario/${encodeURIComponent(materialRecienProcesado)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    // Limpiar la variable después de usar
                    window.ultimoMaterialProcesado = null;
                } catch (error) {
                    console.error('Error forzando actualización:', error);
                }
            }
            
            const inventarioPromises = numerosParteEnTabla.map(async (numeroParte) => {
                try {
                    // Forzar cache-bust para obtener datos frescos
                    const timestamp = Date.now();
                    const response = await fetch(`/buscar_material_por_numero_parte?numero_parte=${encodeURIComponent(numeroParte)}&_t=${timestamp}`, {
                        cache: 'no-cache',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                    const data = await response.json();
                    
                    if (data.success && data.materiales && data.materiales.length > 0) {
                        // ✅ ULTRA-RÁPIDO: Usar cantidad agregada directamente
                        const material = data.materiales[0];
                        const cantidadDisponible = parseFloat(material.cantidad_actual) || 0;
                        inventarioMap.set(numeroParte, cantidadDisponible);
                    } else {
                        inventarioMap.set(numeroParte, 0);
                    }
                } catch (error) {
                    console.error(`Error INSTANTÁNEO consultando ${numeroParte}:`, error);
                    inventarioMap.set(numeroParte, 0);
                }
            });
            
            await Promise.all(inventarioPromises);
            
            // Actualizar INMEDIATAMENTE solo la columna de faltantes
            let filasActualizadas = 0;
            filas.forEach(fila => {
                const celdaNumeroParte = fila.querySelector('td:first-child strong');
                const celdaCantidadTotal = fila.querySelector('td:nth-child(3)');
                const celdaFaltantes = fila.querySelector('td:nth-child(5)');
                
                if (celdaNumeroParte && celdaCantidadTotal && celdaFaltantes) {
                    const numeroParte = celdaNumeroParte.textContent.trim();
                    const cantidadTotal = parseFloat(celdaCantidadTotal.textContent) || 0;
                    const cantidadPlanificada = cantidadTotal * planCantidad;
                    const inventarioActual = inventarioMap.get(numeroParte) || 0;
                    const faltantes = Math.max(0, cantidadPlanificada - inventarioActual);
                    
                    // Determinar color de faltantes
                    let colorFaltantes = '#e67e22';
                    if (faltantes <= 0) {
                        colorFaltantes = '#27ae60'; // Verde si no faltan
                    } else if (faltantes >= cantidadPlanificada) {
                        colorFaltantes = '#e74c3c'; // Rojo si faltan todos
                    } else if (faltantes > cantidadPlanificada * 0.5) {
                        colorFaltantes = '#f39c12'; // Naranja si faltan más del 50%
                    }
                    
                    // 🔥 ACTUALIZACIÓN VISUAL INSTANTÁNEA
                    const valorAnterior = parseFloat(celdaFaltantes.textContent) || 0;
                    
                    // Si cambió el valor, destacarlo visualmente
                    if (valorAnterior !== faltantes) {
                        celdaFaltantes.style.transition = 'all 0.3s ease';
                        celdaFaltantes.style.background = '#f1c40f';
                        celdaFaltantes.style.transform = 'scale(1.05)';
                        
                        setTimeout(() => {
                            celdaFaltantes.style.background = '';
                            celdaFaltantes.style.transform = '';
                        }, 500);
                        
                    }
                    
                    celdaFaltantes.textContent = faltantes;
                    celdaFaltantes.style.color = colorFaltantes;
                    celdaFaltantes.style.fontWeight = 'bold';
                    
                    filasActualizadas++;
                }
            });
            
        }

        // ===============================================
        // FUNCIÓN PARA ACTUALIZAR FALTANTES EN BOM
        // ===============================================
        async function actualizarFaltantesBOM() {
            const tbody1 = document.getElementById('tabla1BOM');
            if (!tbody1) return;
            
            const modelo = document.getElementById('salida_modelo')?.value;
            if (!modelo) {
                return;
            }
            
            
            // OPTIMIZACIÓN: Solo actualizar faltantes, no recargar todo el BOM
            await actualizarSoloFaltantes();
        }

        // ===============================================
        // FUNCIÓN OPTIMIZADA PARA ACTUALIZAR SOLO FALTANTES
        // ===============================================
        async function actualizarSoloFaltantes() {
            const tbody1 = document.getElementById('tabla1BOM');
            if (!tbody1) return;
            
            const filas = tbody1.querySelectorAll('tr');
            const planCantidad = parseFloat(document.getElementById('plan_cantidad')?.value || 1);
            
            
            // Extraer números de parte de las filas existentes
            const numerosParteEnTabla = [];
            filas.forEach(fila => {
                const celdaNumeroParte = fila.querySelector('td:first-child strong');
                if (celdaNumeroParte) {
                    numerosParteEnTabla.push(celdaNumeroParte.textContent.trim());
                }
            });
            
            if (numerosParteEnTabla.length === 0) return;
            
            // 🚀 OPTIMIZADO: Consultar inventarios agregados en paralelo
            const inventarioMap = new Map();
            const inventarioPromises = numerosParteEnTabla.map(async (numeroParte) => {
                try {
                    const response = await fetch(`/buscar_material_por_numero_parte?numero_parte=${encodeURIComponent(numeroParte)}`);
                    const data = await response.json();
                    
                    if (data.success && data.materiales && data.materiales.length > 0) {
                        // ✅ NUEVO: Usar la cantidad agregada directamente (ya es el total disponible)
                        const material = data.materiales[0]; // Primer resultado (agregado)
                        const cantidadDisponible = parseFloat(material.cantidad_actual) || 0;
                        inventarioMap.set(numeroParte, cantidadDisponible);
                    } else {
                        inventarioMap.set(numeroParte, 0);
                    }
                } catch (error) {
                    console.error(`Error consultando inventario para ${numeroParte}:`, error);
                    inventarioMap.set(numeroParte, 0);
                }
            });
            
            await Promise.all(inventarioPromises);
            
            // Actualizar solo la columna de faltantes en cada fila
            filas.forEach(fila => {
                const celdaNumeroParte = fila.querySelector('td:first-child strong');
                const celdaCantidadTotal = fila.querySelector('td:nth-child(3)');
                const celdaFaltantes = fila.querySelector('td:nth-child(5)');
                
                if (celdaNumeroParte && celdaCantidadTotal && celdaFaltantes) {
                    const numeroParte = celdaNumeroParte.textContent.trim();
                    const cantidadTotal = parseFloat(celdaCantidadTotal.textContent) || 0;
                    const cantidadPlanificada = cantidadTotal * planCantidad;
                    const inventarioActual = inventarioMap.get(numeroParte) || 0;
                    const faltantes = Math.max(0, cantidadPlanificada - inventarioActual);
                    
                    // Determinar color de faltantes
                    let colorFaltantes = '#e67e22'; // Naranja por defecto
                    if (faltantes <= 0) {
                        colorFaltantes = '#27ae60'; // Verde si no faltan
                    } else if (faltantes >= cantidadPlanificada) {
                        colorFaltantes = '#e74c3c'; // Rojo si faltan todos
                    } else if (faltantes > cantidadPlanificada * 0.5) {
                        colorFaltantes = '#f39c12'; // Naranja si faltan más del 50%
                    }
                    
                    // Actualizar solo la celda de faltantes
                    celdaFaltantes.textContent = faltantes;
                    celdaFaltantes.style.color = colorFaltantes;
                    
                }
            });
            
        }

        // Ejecutar inicialización simplificada
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarControlSalida);
        } else {
            setTimeout(inicializarControlSalida, 50);
        }

        // Funciones para controlar la visibilidad de la tabla
        // 🚀 Función optimizada para mostrar registro de salida con manejo de errores
        function mostrarRegistroSalida() {
            try {
                console.log('🔍 Mostrando registro de salida...');
                
                // Verificar que los elementos existan
                const tablasRegistro = document.getElementById('tablasRegistroSalida');
                const historialSection = document.getElementById('historialSection');
                const btnRegistro = document.getElementById('btnRegistroSalida');
                const btnHistorial = document.getElementById('btnHistorialSalida');
                
                if (!tablasRegistro) {
                    console.error('❌ Elemento tablasRegistroSalida no encontrado');
                    mostrarMensajeSimple('Error: Sección de registro no encontrada', 'error');
                    return;
                }
                
                // Mostrar tablas de registro (siempre visibles)
                tablasRegistro.style.display = 'flex';
                
                // Ocultar otras secciones
                if (historialSection) {
                    historialSection.style.display = 'none';
                }
                
                // Manejar clases CSS para responsive móvil
                document.body.classList.remove('historial-active');
                tablasRegistro.classList.remove('hidden', 'hidden-by-historial');
                
                // Cambiar estado visual de los botones
                if (btnRegistro) btnRegistro.style.backgroundColor = '#3498db';
                if (btnHistorial) btnHistorial.style.backgroundColor = '';
                
                console.log('✅ Registro de salida mostrado correctamente');
                
            } catch (error) {
                console.error('❌ Error al mostrar registro:', error);
                mostrarMensajeSimple('Error al mostrar registro: ' + error.message, 'error');
            }
        }

        // 🚀 Función optimizada para mostrar historial de salidas con manejo de errores
        function mostrarHistorialSalida() {
            try {
                console.log('🔍 Mostrando historial de salida...');
                
                // Verificar que los elementos existan con reintento
                const verificarElementos = () => {
                    const tablasRegistro = document.getElementById('tablasRegistroSalida');
                    const historialSection = document.getElementById('historialSection');
                    const btnHistorial = document.getElementById('btnHistorialSalida');
                    const btnRegistro = document.getElementById('btnRegistroSalida');
                    
                    if (!tablasRegistro) {
                        console.error('❌ Elemento tablasRegistroSalida no encontrado');
                        mostrarMensajeSimple('Error: Sección de registro no encontrada', 'error');
                        return false;
                    }
                    
                    if (!historialSection) {
                        console.error('❌ Elemento historialSection no encontrado');
                        mostrarMensajeSimple('Error: Sección de historial no encontrada', 'error');
                        return false;
                    }
                    
                    console.log('✅ Elementos encontrados, procediendo...');
                    
                    // Forzar ocultación de registro con máxima prioridad
                    tablasRegistro.classList.add('hide-registro', 'hidden-by-historial');
                    tablasRegistro.style.cssText = `
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                        position: absolute !important;
                        left: -9999px !important;
                        z-index: -1 !important;
                    `;
                    
                    // Forzar visibilidad del historial con máxima prioridad
                    historialSection.classList.remove('hidden', 'hidden-by-historial');
                    historialSection.classList.add('force-visible', 'debug-historial');
                    historialSection.style.cssText = `
                        display: block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        z-index: 1000 !important;
                        position: relative !important;
                        background-color: #2c3e50 !important;
                        padding: 20px !important;
                        margin: 20px 0 !important;
                        border: 2px solid #3498db !important;
                        border-radius: 8px !important;
                        min-height: 400px !important;
                        width: 100% !important;
                        max-width: 100% !important;
                    `;
                    
                    // Establecer fecha actual en los filtros de fecha
                    const hoy = new Date().toISOString().split('T')[0];
                    const fechaDesde = document.getElementById('salida_fecha_desde');
                    const fechaHasta = document.getElementById('salida_fecha_hasta');
                    
                    if (fechaDesde && !fechaDesde.value) {
                        fechaDesde.value = hoy;
                    }
                    if (fechaHasta && !fechaHasta.value) {
                        fechaHasta.value = hoy;
                    }
                    
                    // Cambiar estado visual de los botones
                    if (btnHistorial) {
                        btnHistorial.style.cssText = `
                            background-color: #3498db !important;
                            color: white !important;
                            font-weight: bold !important;
                        `;
                    }
                    if (btnRegistro) {
                        btnRegistro.style.cssText = `
                            background-color: #95a5a6 !important;
                            color: #2c3e50 !important;
                            font-weight: normal !important;
                        `;
                    }
                    
                    // Scroll inmediato al historial
                    setTimeout(() => {
                        historialSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start',
                            inline: 'nearest'
                        });
                    }, 100);
                    
                    console.log('✅ Historial de salida mostrado correctamente');
                    console.log('📊 Estado final:', {
                        historialDisplay: historialSection.style.display,
                        historialVisibility: historialSection.style.visibility,
                        registroDisplay: tablasRegistro.style.display,
                        registroVisibility: tablasRegistro.style.visibility
                    });
                    
                    mostrarMensajeSimple('✅ Historial de salida visible - Use el botón "Consultar" para cargar datos', 'info');
                    
                    return true;
                };
                
                // Intentar mostrar el historial inmediatamente
                if (verificarElementos()) {
                    return;
                }
                
                // Si falló, esperar un poco y reintentar
                console.log('⏳ Esperando elementos del DOM...');
                setTimeout(() => {
                    if (!verificarElementos()) {
                        console.error('❌ No se pudieron encontrar los elementos necesarios después del reintento');
                        mostrarMensajeSimple('Error: No se encontraron los elementos del historial', 'error');
                    }
                }, 300);
                
            } catch (error) {
                console.error('❌ Error al mostrar historial:', error);
                mostrarMensajeSimple('Error al mostrar historial: ' + error.message, 'error');
            }
        }

        // Función para cargar los modelos disponibles en el BOM
        async function cargarModelosBOM() {
            try {
                const response = await fetch('/listar_modelos_bom');
                if (!response.ok) {
                    console.warn('No se pudieron cargar modelos BOM, usando modelos por defecto');
                    return;
                }
                
                const modelos = await response.json();
                
                const dropdownList = document.getElementById('salidaDropdownList');
                if (dropdownList && Array.isArray(modelos) && modelos.length > 0) {
                    // Limpiar opciones existentes
                    dropdownList.innerHTML = '';
                    
                    // Agregar modelos del BOM
                    modelos.forEach((modelo, index) => {
                        const item = document.createElement('div');
                        item.className = 'salida-dropdown-item';
                        
                        // Manejar tanto objetos como strings
                        let modeloTexto;
                        if (typeof modelo === 'object' && modelo !== null) {
                            modeloTexto = modelo.modelo || modelo.name || modelo.id || Object.values(modelo)[0] || '';
                        } else {
                            modeloTexto = String(modelo);
                        }
                        
                        
                        if (modeloTexto && modeloTexto.trim()) {
                            item.dataset.value = modeloTexto;
                            item.textContent = modeloTexto;
                            item.onclick = () => seleccionarModeloSalida(modeloTexto);
                            dropdownList.appendChild(item);
                        }
                    });
                    
                } else {
                }
                
            } catch (error) {
                console.error('❌ DEBUG: Error al cargar modelos BOM:', error);
                // Si hay error, mantener los modelos por defecto que ya están en el HTML
            }
        }

        // Función para filtrar modelos en el dropdown searchable
        function filtrarModelosSalida() {
            const searchInput = document.getElementById('salida_modelo_search');
            const dropdownList = document.getElementById('salidaDropdownList');
            const searchTerm = searchInput.value.toLowerCase();
            
            // Mostrar el dropdown
            dropdownList.style.display = 'block';
            
            const items = dropdownList.querySelectorAll('.salida-dropdown-item');
            let hasVisibleItems = false;
            
            items.forEach(item => {
                const modeloText = item.textContent.toLowerCase();
                if (modeloText.includes(searchTerm)) {
                    item.classList.remove('hidden');
                    hasVisibleItems = true;
                } else {
                    item.classList.add('hidden');
                }
            });
            
            // Si no hay coincidencias, ocultar el dropdown
            if (!hasVisibleItems && searchTerm.length > 0) {
                dropdownList.style.display = 'none';
            }
        }

        // Función para mostrar dropdown
        function mostrarDropdownSalida() {
            const dropdownList = document.getElementById('salidaDropdownList');
            const searchInput = document.getElementById('salida_modelo_search');
            
            if (searchInput.value.trim() === '') {
                // Si el input está vacío, mostrar todos los modelos
                const items = dropdownList.querySelectorAll('.salida-dropdown-item');
                items.forEach(item => {
                    item.classList.remove('hidden');
                });
            }
            
            dropdownList.style.display = 'block';
        }

        // Función para seleccionar un modelo del dropdown
        function seleccionarModeloSalida(modelo) {
            const searchInput = document.getElementById('salida_modelo_search');
            const dropdownList = document.getElementById('salidaDropdownList');
            const hiddenInput = document.getElementById('salida_modelo');
            
            searchInput.value = modelo;
            hiddenInput.value = modelo;
            dropdownList.style.display = 'none';
            
            
            // Cargar BOM para el modelo seleccionado
            cargarBOMPorModelo(modelo);
        }

        // Event listener para cerrar dropdown cuando se hace clic fuera
        document.addEventListener('click', function(event) {
            const searchContainer = document.querySelector('.salida-search-container');
            const dropdownList = document.getElementById('salidaDropdownList');
            
            if (searchContainer && !searchContainer.contains(event.target)) {
                dropdownList.style.display = 'none';
            }
        });

        // Nueva función para cargar BOM automáticamente cuando se selecciona un modelo
        async function cargarBOMPorModelo(modelo) {
            
            if (!modelo || modelo === '' || modelo === 'SIN_MODELO') {
                // Si no hay modelo seleccionado, limpiar las tablas
                limpiarTablasBOM();
                return;
            }

            try {
                mostrarMensajeSimple(`Cargando BOM para modelo: ${modelo}...`, 'info');

                const url = `/consultar_bom?modelo=${encodeURIComponent(modelo)}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const bomData = await response.json();


                if (Array.isArray(bomData) && bomData.length > 0) {
                    actualizarTablaBOMRegistro(bomData);
                    mostrarMensajeSimple(`BOM cargado: ${bomData.length} componentes encontrados para ${modelo}`, 'success');
                } else {
                    limpiarTablasBOM();
                    mostrarMensajeSimple(`No se encontraron componentes BOM para el modelo: ${modelo}`, 'info');
                }

            } catch (error) {
                console.error('❌ DEBUG: Error al cargar BOM:', error);
                mostrarMensajeSimple('Error al cargar BOM: ' + error.message, 'error');
                limpiarTablasBOM();
            }
        }

        // Función para actualizar la primera tabla con los datos del BOM
        async function actualizarTablaBOMRegistro(bomData) {
            const tbody1 = document.getElementById('tabla1BOM');
            const tbody2 = document.getElementById('tabla2BOM');
            
            if (!tbody1) return;

            if (bomData.length === 0) {
                tbody1.innerHTML = '<tr><td colspan="5" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">No hay componentes BOM para este modelo</td></tr>';
                if (tbody2) {
                    tbody2.innerHTML = '<tr><td colspan="6" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Seleccione un componente de la tabla izquierda</td></tr>';
                }
                return;
            }

            // Obtener cantidad del plan
            const planCantidad = parseFloat(document.getElementById('plan_cantidad')?.value || 1);

            // OPTIMIZACIÓN: Consultar todos los inventarios de una sola vez
            const numerosParteUnicos = [...new Set(bomData.map(item => 
                item.numeroParte || item.numero_parte || item.part_number || ''
            ).filter(p => p))];
            
            
            // Crear un mapa de inventarios por número de parte
            const inventarioMap = new Map();
            
            try {
                // 🚀 OPTIMIZADO: Consultar inventarios agregados en paralelo
                const inventarioPromises = numerosParteUnicos.map(async (numeroParte) => {
                    if (!numeroParte) return;
                    
                    try {
                        const response = await fetch(`/buscar_material_por_numero_parte?numero_parte=${encodeURIComponent(numeroParte)}`);
                        const data = await response.json();
                        
                        if (data.success && data.materiales && data.materiales.length > 0) {
                            // ✅ NUEVO: Usar cantidad agregada directamente (ya optimizado en backend)
                            const material = data.materiales[0]; // Primer resultado (agregado)
                            const cantidadDisponible = parseFloat(material.cantidad_actual) || 0;
                            inventarioMap.set(numeroParte, cantidadDisponible);
                        } else {
                            inventarioMap.set(numeroParte, 0);
                        }
                    } catch (error) {
                        console.error(`Error consultando inventario para ${numeroParte}:`, error);
                        inventarioMap.set(numeroParte, 0);
                    }
                });
                
                // Esperar a que todas las consultas terminen
                await Promise.all(inventarioPromises);
                
            } catch (error) {
                console.error('❌ Error en consulta paralela de inventarios:', error);
            }

            let html = '';
            
            // Procesar cada item del BOM usando el mapa de inventarios
            bomData.forEach((item, index) => {
                // Obtener campos con los nombres correctos que vienen del backend
                const numeroParte = item.numeroParte || item.numero_parte || item.part_number || '';
                const especificacion = item.especificacionMaterial || item.descripcion || item.especificacion || item.description || '';
                const cantidadTotal = parseFloat(item.cantidadTotal || item.cantidad_total || item.cantidad_requerida || item.cantidad || 0);
                
                // Calcular cantidad planificada (cantidad total * plan)
                const cantidadPlanificada = cantidadTotal * planCantidad;
                
                // OBTENER INVENTARIO ACTUAL DEL MAPA (YA CONSULTADO)
                const inventarioActual = inventarioMap.get(numeroParte) || 0;
                
                // Calcular faltantes reales: cantidad planificada - inventario actual
                const faltantes = Math.max(0, cantidadPlanificada - inventarioActual);
                
                    numeroParte,
                    cantidadTotal,
                    planCantidad,
                    cantidadPlanificada,
                    inventarioActual,
                    faltantes
                });
                
                // Color de faltantes basado en la cantidad
                let colorFaltantes = '#e67e22'; // Naranja por defecto
                if (faltantes <= 0) {
                    colorFaltantes = '#27ae60'; // Verde si no faltan
                } else if (faltantes >= cantidadPlanificada) {
                    colorFaltantes = '#e74c3c'; // Rojo si faltan todos
                } else if (faltantes > cantidadPlanificada * 0.5) {
                    colorFaltantes = '#f39c12'; // Naranja si faltan más del 50%
                }
                
                html += `
                    <tr style="cursor: pointer; background-color: #2c3e50; color: #ecf0f1;" onclick="seleccionarComponenteBOM('${index}', '${numeroParte}', '${especificacion}', '${cantidadTotal}', '${cantidadPlanificada}')" onmouseover="this.style.backgroundColor='#34495e'" onmouseout="this.style.backgroundColor='#2c3e50'">
                        <td style="padding: 8px; border: 1px solid #34495e;"><strong style="color: #3498db;">${numeroParte}</strong></td>
                        <td style="padding: 8px; border: 1px solid #34495e;">${especificacion}</td>
                        <td style="padding: 8px; border: 1px solid #34495e; text-align: center; font-weight: bold; color: #95a5a6;">${cantidadTotal}</td>
                        <td style="padding: 8px; border: 1px solid #34495e; text-align: center; font-weight: bold; color: #3498db;">${cantidadPlanificada}</td>
                        <td style="padding: 8px; border: 1px solid #34495e; text-align: center; font-weight: bold; color: ${colorFaltantes};">${faltantes}</td>
                    </tr>
                `;
            });

            tbody1.innerHTML = html;
            
            // Limpiar la segunda tabla hasta que se seleccione algo
            if (tbody2) {
                tbody2.innerHTML = '<tr><td colspan="6" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Haga clic en un componente para ver detalles</td></tr>';
            }
        }

        // Función para seleccionar un componente y mostrar detalles en la segunda tabla
        async function seleccionarComponenteBOM(index, numeroParte, descripcion, cantidadRequerida, cantidadPlanificada) {
            const tbody2 = document.getElementById('tabla2BOM');
            if (!tbody2) return;

            try {
                // Buscar si existe el material en inventario
                const response = await fetch(`/buscar_material_por_numero_parte?numero_parte=${encodeURIComponent(numeroParte)}`);
                const data = await response.json();

                let html = '';
                if (data.success && data.materiales && data.materiales.length > 0) {
                    // Si hay materiales disponibles
                    data.materiales.forEach(material => {
                        const cantidadDisponible = parseFloat(material.cantidad_actual) || 0;
                        const cantidadReq = parseFloat(cantidadRequerida) || 0;
                        const suficiente = cantidadDisponible >= cantidadReq;
                        
                        html += `
                            <tr style="background-color: ${suficiente ? '#27ae60' : '#e74c3c'}; color: #ecf0f1;">
                                <td style="padding: 8px; border: 1px solid #34495e;"><strong style="color: #3498db;">${material.numero_parte || ''}</strong></td>
                                <td style="padding: 8px; border: 1px solid #34495e;">${material.especificacion || descripcion}</td>
                                <td style="padding: 8px; border: 1px solid #34495e; text-align: center; font-weight: bold; color: #ecf0f1;">
                                    ${cantidadDisponible}
                                </td>
                                <td style="padding: 8px; border: 1px solid #34495e; text-align: center; font-weight: bold; color: #f39c12;">
                                    ${cantidadReq}
                                </td>
                                <td style="padding: 8px; border: 1px solid #34495e; text-align: center;">
                                    <span style="padding: 4px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; color: #2c3e50; background-color: ${suficiente ? '#2ecc71' : '#e74c3c'};">
                                        ${suficiente ? '✓ OK' : '✗ FALTA'}
                                    </span>
                                </td>
                                <td style="padding: 8px; border: 1px solid #34495e;">${material.codigo_material || ''}</td>
                            </tr>
                        `;
                    });
                } else {
                    // Si no hay materiales disponibles
                    html = `
                        <tr style="background-color: #f39c12; color: #2c3e50;">
                            <td style="padding: 8px; border: 1px solid #34495e;"><strong>${numeroParte}</strong></td>
                            <td style="padding: 8px; border: 1px solid #34495e;">${descripcion}</td>
                            <td style="padding: 8px; border: 1px solid #34495e; text-align: center; font-weight: bold;">0</td>
                            <td style="padding: 8px; border: 1px solid #34495e; text-align: center; font-weight: bold;">${cantidadRequerida}</td>
                            <td style="padding: 8px; border: 1px solid #34495e; text-align: center;">
                                <span style="padding: 4px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; color: #2c3e50; background-color: #ffc107;">
                                    NO DISPONIBLE
                                </span>
                            </td>
                            <td style="padding: 8px; border: 1px solid #34495e;">-</td>
                        </tr>
                    `;
                }

                tbody2.innerHTML = html;

            } catch (error) {
                console.error('❌ Error al buscar material:', error);
                tbody2.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-data" style="color: #e74c3c;">
                            Error al buscar información del material
                        </td>
                    </tr>
                `;
            }
        }

        // Función para transferir componente seleccionado al formulario de registro
        function transferirComponenteAFormulario(numeroParte, descripcion) {
            // Llenar los campos del formulario
            const numeroParteInput = document.getElementById('salida_numero_parte');
            const especificacionInput = document.getElementById('salida_especificacion_material');

            if (numeroParteInput) {
                numeroParteInput.value = numeroParte;
                numeroParteInput.style.backgroundColor = '#e3f2fd';
                numeroParteInput.style.color = '#1565c0';
                numeroParteInput.style.fontWeight = 'bold';
            }

            if (especificacionInput) {
                especificacionInput.value = descripcion;
                especificacionInput.style.backgroundColor = '#e3f2fd';
                especificacionInput.style.color = '#1565c0';
                especificacionInput.style.fontWeight = 'bold';
            }

            // Enfocar el campo de código de material para continuar
            setTimeout(() => {
                const codigoInput = document.getElementById('salida_codigo_material_recibido');
                if (codigoInput) {
                    codigoInput.focus();
                }
            }, 300);

            mostrarExito(`Transferido al formulario: ${numeroParte}`);
        }

        // Función para limpiar las tablas BOM
        function limpiarTablasBOM() {
            const tbody1 = document.getElementById('tabla1BOM');
            const tbody2 = document.getElementById('tabla2BOM');
            
            if (tbody1) {
                tbody1.innerHTML = '<tr><td colspan="5" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Seleccione un modelo para ver componentes</td></tr>';
            }
            
            if (tbody2) {
                tbody2.innerHTML = '<tr><td colspan="6" class="no-data" style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">Seleccione un componente de la tabla izquierda</td></tr>';
            }
        }

        // Función para actualizar las cantidades del plan
        function actualizarCantidadesPlan() {
            
            const tbody1 = document.getElementById('tabla1BOM');
            if (!tbody1) return;
            
            const filas = tbody1.querySelectorAll('tr');
            const planCantidad = parseFloat(document.getElementById('plan_cantidad')?.value || 1);
            
            // OPTIMIZACIÓN: Actualizar solo las columnas de plan y faltantes sin recargar todo
            filas.forEach(fila => {
                const celdaCantidadTotal = fila.querySelector('td:nth-child(3)');
                const celdaCantidadPlan = fila.querySelector('td:nth-child(4)');
                const celdaFaltantes = fila.querySelector('td:nth-child(5)');
                
                if (celdaCantidadTotal && celdaCantidadPlan && celdaFaltantes) {
                    const cantidadTotal = parseFloat(celdaCantidadTotal.textContent) || 0;
                    const cantidadPlanificada = cantidadTotal * planCantidad;
                    
                    // Actualizar columna de cantidad planificada
                    celdaCantidadPlan.textContent = cantidadPlanificada;
                }
            });
            
            // 🚀 ULTRA-RÁPIDO: Usar función instantánea para faltantes
            actualizarFaltantesBOMInstantaneo();
        }

        async function buscarMaterialPorCodigo(codigo) {
            try {
                mostrarCargando('Buscando material...');
                
                const response = await fetch(`/buscar_material_por_codigo?codigo_recibido=${encodeURIComponent(codigo)}`);
                const data = await response.json();

                if (data.success && data.material) {
                    materialActual = data.material;
                    rellenarCamposMaterial(data.material);
                    // ✅ OCULTAR mensaje de carga cuando termine exitosamente
                    // (el mensaje se oculta automáticamente en rellenarCamposMaterial)
                } else {
                    limpiarCamposMaterial();
                    mostrarError(data.error || 'Material no encontrado');
                }
            } catch (error) {
                console.error('Error al buscar material:', error);
                mostrarError('Error al buscar material');
                limpiarCamposMaterial();
            }
        }

        function rellenarCamposMaterial(material) {
            // Rellenar todos los campos con los datos del material
            const campos = {
                'salida_codigo_material_original': material.codigo_material_original || '',
                'salida_codigo_material': material.codigo_material || '',
                'salida_especificacion_material': material.especificacion || '',
                'salida_numero_parte': material.numero_parte || '',
                'salida_cantidad_actual': material.cantidad_actual || '',
                'salida_numero_lote_material': material.numero_lote_material || ''
            };

            Object.keys(campos).forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = campos[id];
                    
                    // Colorear el campo de cantidad según el stock disponible
                    if (id === 'salida_cantidad_actual') {
                        const stockDisponible = parseFloat(material.cantidad_actual) || 0;
                        if (stockDisponible <= 0) {
                            input.style.backgroundColor = '#ffebee';
                            input.style.color = '#c62828';
                            input.style.fontWeight = 'bold';
                        } else if (stockDisponible <= 10) {
                            input.style.backgroundColor = '#fff3e0';
                            input.style.color = '#f57c00';
                            input.style.fontWeight = 'bold';
                        } else {
                            input.style.backgroundColor = '#e8f5e8';
                            input.style.color = '#2e7d32';
                            input.style.fontWeight = 'bold';
                        }
                    }
                    
                    // Destacar el número de lote de material cuando se llene
                    if (id === 'salida_numero_lote_material' && campos[id]) {
                        input.style.backgroundColor = '#e3f2fd';
                        input.style.color = '#1565c0';
                        input.style.fontWeight = 'bold';
                        input.style.border = '2px solid #2196f3';
                    }
                }
            });

            // Mostrar mensaje más detallado
            let mensaje = `Material encontrado. Stock disponible: ${material.cantidad_actual}`;
            
            if (material.numero_lote_material) {
                mensaje += ` | Lote: ${material.numero_lote_material}`;
            }
            
            if (material.cantidad_original && material.total_salidas !== undefined) {
                mensaje += ` (Original: ${material.cantidad_original}, Salidas: ${material.total_salidas})`;
            }
            
            if (parseFloat(material.cantidad_actual) <= 0) {
                mostrarError(`${mensaje} - NO SE PUEDEN HACER MÁS SALIDAS`);
            } else if (parseFloat(material.cantidad_actual) <= 10) {
                mostrarInfo(`${mensaje} - STOCK BAJO`);
            } else {
                mostrarExito(mensaje);
            }
        }

        function limpiarCamposMaterial() {
            // Limpiar campo de código de material recibido
            const codigoInput = document.getElementById('salida_codigo_material_recibido');
            if (codigoInput) {
                codigoInput.value = '';
            }
            
            // Limpiar todos los campos del material
            const camposALimpiar = [
                'salida_codigo_material_original',
                'salida_codigo_material', 
                'salida_especificacion_material',
                'salida_numero_parte',
                'salida_cantidad_actual',
                'salida_numero_lote_material'
            ];
            
            camposALimpiar.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = '';
                    // Resetear estilos
                    input.style.backgroundColor = '';
                    input.style.color = '';
                    input.style.fontWeight = '';
                }
            });
            
            // Limpiar verificación
            limpiarVerificacion();
            
            // Resetear variables globales
            materialActual = null;
            verificacionCompletada = false;
            
            // Enfocar nuevamente el campo de código
            setTimeout(() => {
                if (codigoInput) {
                    codigoInput.focus();
                }
            }, 100);
        }

        function reiniciarFormulario() {
            // Limpiar todos los campos del formulario
            const campos = [
                'salida_codigo_material_recibido'
            ];

            campos.forEach(campo => {
                const input = document.getElementById(campo);
                if (input) {
                    input.value = '';
                }
            });

            limpiarCamposMaterial();

            // Restablecer fecha actual
            const hoy = new Date().toISOString().split('T')[0];
            const fechaSalidaForm = document.getElementById('salida_fecha_salida_form');
            if (fechaSalidaForm) {
                fechaSalidaForm.value = hoy;
            }

            mostrarInfo('Formulario reiniciado - El modelo seleccionado se mantiene');
        }

        async function guardarSalida() {
            try {
                // Validar campos requeridos
                const codigoRecibido = document.getElementById('salida_codigo_material_recibido')?.value.trim() || '';
                const modeloSeleccionado = document.getElementById('salida_modelo')?.value || '';

                if (!codigoRecibido) {
                    mostrarError('Debe ingresar el código de material recibido');
                    return;
                }

                if (!modeloSeleccionado) {
                    mostrarError('Debe seleccionar un modelo');
                    return;
                }

                if (!materialActual) {
                    mostrarError('No se ha encontrado información del material');
                    return;
                }

                // Verificar que el material tenga número de lote
                if (!materialActual.numero_lote_material) {
                    mostrarError('El material no tiene número de lote asignado');
                    return;
                }

                // Usar automáticamente la cantidad actual como cantidad de salida
                const cantidadSalida = parseFloat(materialActual.cantidad_actual) || 0;
                
                if (cantidadSalida <= 0) {
                    mostrarError('No hay stock disponible para realizar la salida');
                    return;
                }

                mostrarCargando('Procesando salida...');

                // Preparar datos para enviar
                const datosEnvio = {
                    codigo_material_recibido: codigoRecibido,
                    cantidad_salida: cantidadSalida,
                    modelo: modeloSeleccionado,
                    numero_lote: materialActual.numero_lote_material || '', // Usar el número de lote del material
                    fecha_salida: document.getElementById('salida_fecha_salida_form')?.value || '',
                    depto_salida: 'Producción', // Valor por defecto
                    proceso_salida: 'SMT 1st SIDE' // Valor por defecto
                };

                const response = await fetch('/procesar_salida_material', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datosEnvio)
                });

                const data = await response.json();

                if (data.success) {
                    // ✅ OPTIMIZACIÓN: Mensajes más informativos según el tipo de respuesta
                    if (data.optimized) {
                        mostrarExito(`🚀 SALIDA ULTRA-RÁPIDA COMPLETADA | Stock restante: ${data.cantidad_restante || 'N/A'}`);
                        
                        // Mostrar información adicional sobre optimización
                        setTimeout(() => {
                            mostrarInfo('💡 Optimización activa: Inventario general actualizándose en segundo plano');
                        }, 1500);
                    } else {
                        mostrarExito(data.message);
                    }
                    
                    // NUEVO COMPORTAMIENTO: Ya no se eliminan registros del almacén
                    // El historial se preserva completo y el inventario se maneja en otra tabla
                    
                    if (data.nota && !data.optimized) {
                        // Mostrar información adicional sobre el nuevo comportamiento
                        setTimeout(() => {
                            mostrarInfo(data.nota);
                        }, 2000);
                    }
                    
                    // Actualizar la interfaz para mostrar la cantidad calculada (no la real del almacén)
                    if (materialActual && data.cantidad_restante !== undefined) {
                        // Actualizar cantidad mostrada (calculada)
                        const cantidadActualInput = document.getElementById('salida_cantidad_actual');
                        
                        if (cantidadActualInput) {
                            cantidadActualInput.value = data.cantidad_restante;
                            cantidadActualInput.style.color = data.cantidad_restante <= 0 ? '#e74c3c' : '#27ae60';
                        }
                        
                        // Si el stock calculado es 0 o menos, mostrar advertencia
                        if (data.cantidad_restante <= 0) {
                            setTimeout(() => {
                                mostrarInfo('Stock agotado para este lote. El historial se mantiene en almacén.');
                            }, 3000);
                        }
                    }

                    // Limpiar solo el código de material para permitir nueva búsqueda
                    // El modelo se mantiene fijo como solicitado
                    const codigoInput = document.getElementById('salida_codigo_material_recibido');
                    if (codigoInput) codigoInput.value = '';
                    
                    // Limpiar campos del material encontrado
                    limpiarCamposMaterial();

                    // ✅ OPTIMIZACIÓN: Tiempo reducido para actualización de tabla (solo si está visible)
                    const historialSection = document.getElementById('historialSection');
                    if (historialSection && historialSection.style.display !== 'none') {
                        setTimeout(() => {
                            consultarSalidas();
                        }, data.optimized ? 300 : 1000);
                    }

                } else {
                    mostrarError(data.error || 'Error al procesar la salida');
                }

            } catch (error) {
                console.error('Error al guardar salida:', error);
                mostrarError('Error interno al procesar la salida');
            }
        }

        async function consultarSalidas() {
            try {
                const codigoFiltro = document.getElementById('salida_filtro_codigo')?.value?.trim() || '';
                const fechaDesde = document.getElementById('salida_fecha_desde')?.value || '';
                const fechaHasta = document.getElementById('salida_fecha_hasta')?.value || '';

                // Validación de fechas
                if (fechaDesde && fechaHasta && fechaDesde > fechaHasta) {
                    mostrarError('La fecha desde no puede ser mayor que la fecha hasta');
                    return;
                }

                // Mostrar mensaje específico según los filtros aplicados
                let mensajeCarga = 'Consultando salidas...';
                if (fechaDesde || fechaHasta || codigoFiltro) {
                    mensajeCarga = 'Aplicando filtros y consultando...';
                }
                mostrarCargando(mensajeCarga);

                let url = '/consultar_historial_salidas';
                const params = new URLSearchParams();

                // Agregar filtro de código de material
                if (codigoFiltro) {
                    params.append('codigo_material', codigoFiltro);
                }

                // Agregar filtros de fecha
                if (fechaDesde) {
                    params.append('fecha_desde', fechaDesde);
                }
                if (fechaHasta) {
                    params.append('fecha_hasta', fechaHasta);
                }

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                // Debug: mostrar la URL que se está enviando
                    codigo: codigoFiltro,
                    fechaDesde: fechaDesde,
                    fechaHasta: fechaHasta
                });

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const salidas = await response.json();


                if (Array.isArray(salidas)) {
                    actualizarTablaSalidas(salidas);
                    const totalInfo = document.getElementById('salida_totalInfo');
                    if (totalInfo) {
                        const mensaje = `Total Rows: ${salidas.length}`;
                        const filtros = [];
                        if (codigoFiltro) {
                            filtros.push(`Código: ${codigoFiltro}`);
                        }
                        if (fechaDesde) {
                            filtros.push(`Desde: ${fechaDesde}`);
                        }
                        if (fechaHasta) {
                            filtros.push(`Hasta: ${fechaHasta}`);
                        }
                        
                        totalInfo.textContent = filtros.length > 0 ? 
                            `${mensaje} | Filtros: ${filtros.join(', ')}` : mensaje;
                    }
                    
                    // ✅ OCULTAR mensaje de carga cuando termine exitosamente
                    ocultarMensaje();
                } else {
                    console.error('❌ Error en respuesta:', salidas);
                    mostrarError(salidas.error || 'Error al consultar salidas');
                }

            } catch (error) {
                console.error('❌ Error al consultar salidas:', error);
                mostrarError('Error al consultar salidas: ' + error.message);
            }
        }

        function limpiarFiltros() {
            const codigoFiltro = document.getElementById('salida_filtro_codigo');
            const fechaDesde = document.getElementById('salida_fecha_desde');
            const fechaHasta = document.getElementById('salida_fecha_hasta');
            
            if (codigoFiltro) codigoFiltro.value = '';
            if (fechaDesde) fechaDesde.value = '';
            if (fechaHasta) fechaHasta.value = '';
            
            // Consultar automáticamente con filtros limpiados
            consultarSalidas();
            
            mostrarMensajeSimple('Filtros limpiados', 'info');
        }

        function actualizarTablaSalidas(salidas) {
            const tbody = document.querySelector('#salida_tablaSalidas tbody');
            if (!tbody) return;
            
            if (salidas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="no-data">No hay dato registrado</td></tr>';
                return;
            }

            let html = '';
            salidas.forEach(salida => {
                html += `
                    <tr>
                        <td>${salida.fecha_salida || ''}</td>
                        <td>${salida.proceso_salida || ''}</td>
                        <td>${salida.codigo_material_recibido || ''}</td>
                        <td>${salida.codigo_material || ''}</td>
                        <td>${salida.numero_parte || ''}</td>
                        <td style="text-align: center;">
                            <input type="checkbox" ${salida.disp ? 'checked' : ''} disabled>
                        </td>
                        <td style="text-align: center;">
                            <input type="checkbox" ${salida.hist ? 'checked' : ''} disabled>
                        </td>
                        <td>${salida.codigo_material_original || ''}</td>
                        <td>${salida.numero_lote || ''}</td>
                        <td>${salida.maquina_linea || ''}</td>
                        <td>${salida.departamento || ''}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function formatearFecha(fechaISO) {
            if (!fechaISO) return '';
            try {
                const fecha = new Date(fechaISO);
                return fecha.toLocaleString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return fechaISO;
            }
        }

        function exportarExcel() {
            try {
                // Obtener datos de la tabla
                const tabla = document.getElementById('salida_tablaSalidas');
                if (!tabla) {
                    mostrarError('No se encontró la tabla');
                    return;
                }

                const filas = tabla.querySelectorAll('tbody tr');
                
                if (filas.length === 1 && filas[0].querySelector('.no-data')) {
                    mostrarError('No hay datos para exportar');
                    return;
                }

                // Crear CSV
                let csv = 'Fecha de salida,Proceso de salida,Código material recibido,Código de material,Número de parte,Disp,Hist,Código material original,Número de lote,Máquina(linea),Departamento de salida\n';
                
                filas.forEach(fila => {
                    const celdas = fila.querySelectorAll('td');
                    if (celdas.length > 1) { // Evitar la fila de "no hay datos"
                        const valores = Array.from(celdas).map(celda => 
                            '"' + celda.textContent.replace(/"/g, '""') + '"'
                        );
                        csv += valores.join(',') + '\n';
                    }
                });

                // Descargar archivo
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `salidas_material_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                mostrarExito('Archivo exportado exitosamente');

            } catch (error) {
                console.error('Error al exportar:', error);
                mostrarError('Error al exportar el archivo');
            }
        }

        // Funciones de utilidad para mostrar mensajes
        function mostrarMensaje(mensaje, tipo) {
            // Buscar contenedor de mensajes existente o crear uno
            let contenedor = document.getElementById('salida-mensaje-sistema');
            if (!contenedor) {
                contenedor = document.createElement('div');
                contenedor.id = 'salida-mensaje-sistema';
                contenedor.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 5px;
                    color: white;
                    font-weight: bold;
                    z-index: 10000;
                    max-width: 400px;
                    word-wrap: break-word;
                `;
                document.body.appendChild(contenedor);
            }

            // Establecer el color según el tipo
            switch (tipo) {
                case 'exito':
                    contenedor.style.backgroundColor = '#27ae60';
                    break;
                case 'error':
                    contenedor.style.backgroundColor = '#e74c3c';
                    break;
                case 'info':
                    contenedor.style.backgroundColor = '#3498db';
                    break;
                case 'cargando':
                    contenedor.style.backgroundColor = '#f39c12';
                    break;
                default:
                    contenedor.style.backgroundColor = '#95a5a6';
            }

            contenedor.textContent = mensaje;
            contenedor.style.display = 'block';

            // Auto-ocultar después de cierto tiempo (excepto para "cargando")
            if (tipo !== 'cargando') {
                setTimeout(() => {
                    contenedor.style.display = 'none';
                }, tipo === 'error' ? 5000 : 3000);
            }
        }

        function mostrarExito(mensaje) {
            // Primero ocultar cualquier mensaje anterior (especialmente los de carga)
            ocultarMensaje();
            // Pequeña pausa para asegurar que se oculte el anterior
            setTimeout(() => {
                mostrarMensaje(mensaje, 'exito');
            }, 100);
        }

        function mostrarError(mensaje) {
            // Primero ocultar cualquier mensaje anterior (especialmente los de carga)
            ocultarMensaje();
            // Pequeña pausa para asegurar que se oculte el anterior
            setTimeout(() => {
                mostrarMensaje(mensaje, 'error');
            }, 100);
        }

        function mostrarInfo(mensaje) {
            mostrarMensaje(mensaje, 'info');
        }

        function mostrarCargando(mensaje) {
            mostrarMensaje(mensaje, 'cargando');
        }

        function ocultarMensaje() {
            const contenedor = document.getElementById('salida-mensaje-sistema');
            if (contenedor) {
                contenedor.style.display = 'none';
            }
        }

        // Función global para limpiar al cambiar de página
        window.limpiarControlSalida = function() {
            window.controlSalidaInicializado = false;
            const contenedor = document.getElementById('salida-mensaje-sistema');
            if (contenedor) {
                contenedor.remove();
            }
        };

        // Función de test de conectividad para debugging
        window.testConectividadSalida = function() {
            fetch('/consultar_historial_salidas')
                .then(response => response.ok ? response.json() : Promise.reject('Error HTTP: ' + response.status))
                .catch(error => console.error('❌ Error de conectividad:', error));
        };

        // Función global para acceso directo desde consola (debugging)
        window.debugControlSalida = function() {
            return {
                materialActual: materialActual,
                verificacionCompletada: verificacionCompletada,
                elementosDOM: {
                    codigoInput: !!document.getElementById('salida_codigo_material_recibido'),
                    verificacionInput: !!document.getElementById('salida_verificacion_codigo'),
                    tablaSalidas: !!document.getElementById('salida_tablaSalidas'),
                    checkbox: !!document.getElementById('salida_registroAutomatico'),
                    historialSection: !!document.getElementById('historialSection'),
                    tablasRegistro: !!document.getElementById('tablasRegistroSalida'),
                    btnHistorial: !!document.getElementById('btnHistorialSalida'),
                    btnRegistro: !!document.getElementById('btnRegistroSalida'),
                    modelo: document.getElementById('salida_modelo')?.value || 'No seleccionado'
                }
            };
        };

        // 🚀 Función de test para probar Enter automático
        window.testEnterAutomatico = function() {
            console.log('🧪 Probando Enter automático...');
            
            const codigoInput = document.getElementById('salida_codigo_material_recibido');
            const verificacionInput = document.getElementById('salida_verificacion_codigo');
            
            if (codigoInput) {
                console.log('✅ Campo código encontrado');
                // Simular evento Enter
                const event = new KeyboardEvent('keydown', {
                    key: 'Enter',
                    keyCode: 13,
                    bubbles: true
                });
                
                codigoInput.value = 'TEST123';
                codigoInput.dispatchEvent(event);
                console.log('🔥 Evento Enter simulado en campo código');
            }
            
            if (verificacionInput) {
                console.log('✅ Campo verificación encontrado');
            }
            
            return 'Test completado - revise la consola para resultados';
        };

        // 🚀 Función de test para botones de historial
        window.testBotonesHistorial = function() {
            console.log('🧪 Probando botones de historial...');
            
            try {
                mostrarHistorialSalida();
                setTimeout(() => {
                    mostrarRegistroSalida();
                }, 2000);
                
                return 'Test de botones iniciado - cambio automático en 2 segundos';
            } catch (error) {
                console.error('❌ Error en test de botones:', error);
                return 'Error: ' + error.message;
            }
        };

        // ===================================================================
        // 🔧 FUNCIONES DE DEBUGGING ULTRA-MEJORADAS
        // ===================================================================
        
        // Función ULTRA-ROBUSTA para forzar historial visible
        window.forzarHistorialVisible = function() {
            try {
                console.log('🔧 FORZANDO historial visible con implementación ultra-robusta...');
                
                const historialSection = document.getElementById('historialSection');
                const tablasRegistro = document.getElementById('tablasRegistroSalida');
                
                if (!historialSection) {
                    console.error('❌ historialSection no encontrado');
                    return 'Error: historialSection no encontrado';
                }
                
                if (!tablasRegistro) {
                    console.error('❌ tablasRegistroSalida no encontrado');
                    return 'Error: tablasRegistroSalida no encontrado';
                }
                
                // PASO 1: Ocultar completamente el registro
                tablasRegistro.classList.add('hide-registro', 'hidden-by-historial');
                tablasRegistro.style.cssText = `
                    display: none !important;
                    visibility: hidden !important;
                    opacity: 0 !important;
                    position: absolute !important;
                    left: -9999px !important;
                    top: -9999px !important;
                    z-index: -999 !important;
                    width: 0 !important;
                    height: 0 !important;
                    overflow: hidden !important;
                `;
                
                // PASO 2: Forzar visibilidad máxima del historial
                historialSection.classList.remove('hidden', 'hidden-by-historial');
                historialSection.classList.add('force-visible', 'debug-historial');
                historialSection.style.cssText = `
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    z-index: 10000 !important;
                    position: relative !important;
                    background-color: #2c3e50 !important;
                    color: #ecf0f1 !important;
                    padding: 25px !important;
                    margin: 20px 0 !important;
                    border: 5px solid #e74c3c !important;
                    border-radius: 10px !important;
                    min-height: 500px !important;
                    width: 100% !important;
                    max-width: 100% !important;
                    box-shadow: 0 0 20px rgba(231, 76, 60, 0.8) !important;
                `;
                
                // PASO 3: Verificar que todos los elementos internos sean visibles
                const elementosInternos = historialSection.querySelectorAll('*');
                elementosInternos.forEach(elemento => {
                    if (elemento.style.display === 'none') {
                        elemento.style.display = 'block';
                    }
                    elemento.style.visibility = 'visible';
                    elemento.style.opacity = '1';
                });
                
                // PASO 4: Configurar fechas por defecto
                const hoy = new Date().toISOString().split('T')[0];
                const fechaDesde = document.getElementById('salida_fecha_desde');
                const fechaHasta = document.getElementById('salida_fecha_hasta');
                
                if (fechaDesde && !fechaDesde.value) {
                    fechaDesde.value = hoy;
                }
                if (fechaHasta && !fechaHasta.value) {
                    fechaHasta.value = hoy;
                }
                
                // PASO 5: Actualizar botones
                const btnHistorial = document.getElementById('btnHistorialSalida');
                const btnRegistro = document.getElementById('btnRegistroSalida');
                
                if (btnHistorial) {
                    btnHistorial.style.cssText = `
                        background-color: #e74c3c !important;
                        color: white !important;
                        font-weight: bold !important;
                        border: 2px solid #c0392b !important;
                    `;
                }
                if (btnRegistro) {
                    btnRegistro.style.cssText = `
                        background-color: #95a5a6 !important;
                        color: #2c3e50 !important;
                        font-weight: normal !important;
                    `;
                }
                
                // PASO 6: Agregar indicador visual extremo
                const existingIndicator = document.getElementById('debug-indicator-extreme');
                if (existingIndicator) {
                    existingIndicator.remove();
                }
                
                const indicator = document.createElement('div');
                indicator.id = 'debug-indicator-extreme';
                indicator.style.cssText = `
                    position: fixed !important;
                    top: 10px !important;
                    right: 10px !important;
                    background-color: #e74c3c !important;
                    color: white !important;
                    padding: 15px !important;
                    border-radius: 5px !important;
                    z-index: 99999 !important;
                    font-weight: bold !important;
                    box-shadow: 0 0 10px rgba(0,0,0,0.5) !important;
                `;
                indicator.innerHTML = `
                    <div>🔥 HISTORIAL ULTRA-FORZADO 🔥</div>
                    <div>Estado: ${historialSection.style.display}</div>
                    <div><small>Haga clic en "Consultar" para datos</small></div>
                `;
                document.body.appendChild(indicator);
                
                // PASO 7: Scroll forzado con múltiples intentos
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        historialSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start',
                            inline: 'nearest'
                        });
                    }, i * 200);
                }
                
                // PASO 8: Auto-quitar indicador después de 10 segundos
                setTimeout(() => {
                    if (indicator && indicator.parentNode) {
                        indicator.remove();
                    }
                }, 10000);
                
                console.log('✅ Historial ULTRA-FORZADO con máxima visibilidad');
                console.log('📊 Estado extremo:', {
                    historialDisplay: historialSection.style.display,
                    historialVisibility: historialSection.style.visibility,
                    registroDisplay: tablasRegistro.style.display
                });
                
                return '✅ HISTORIAL ULTRA-FORZADO - Debería ser visible con borde rojo brillante';
                
            } catch (error) {
                console.error('❌ Error en forzarHistorialVisible:', error);
                return 'Error: ' + error.message;
            }
        };

        // Función para test ultra-rápido
        window.testHistorialUltraRapido = function() {
            console.log('🧪 Test ultra-rápido del historial...');
            
            const historial = document.getElementById('historialSection');
            const registro = document.getElementById('tablasRegistroSalida');
            
            if (!historial) {
                return '❌ historialSection no encontrado';
            }
            
            if (!registro) {
                return '❌ tablasRegistroSalida no encontrado';
            }
            
            // Test de visibilidad inmediata con colores extremos
            historial.style.cssText = `
                display: block !important;
                background-color: yellow !important;
                border: 10px solid red !important;
                min-height: 300px !important;
                padding: 30px !important;
                position: relative !important;
                z-index: 9999 !important;
            `;
            
            registro.style.cssText = `
                display: none !important;
                visibility: hidden !important;
            `;
            
            // Agregar texto visible
            const testText = document.createElement('div');
            testText.id = 'test-visibility-text';
            testText.style.cssText = `
                font-size: 24px !important;
                color: red !important;
                font-weight: bold !important;
                text-align: center !important;
                padding: 20px !important;
            `;
            testText.innerHTML = '🔥 SI VES ESTO, EL HISTORIAL ESTÁ VISIBLE 🔥';
            historial.appendChild(testText);
            
            setTimeout(() => {
                const existingTest = document.getElementById('test-visibility-text');
                if (existingTest) {
                    existingTest.remove();
                }
            }, 5000);
            
            return '✅ Test completado - ¿Ves una sección amarilla con borde rojo y texto?';
        };

        // Función de debugging completa
        window.debugControlSalida = function() {
            try {
                const historialSection = document.getElementById('historialSection');
                const tablasRegistro = document.getElementById('tablasRegistroSalida');
                
                const result = {
                    timestamp: new Date().toISOString(),
                    elementosDOM: {
                        historialSection: !!historialSection,
                        tablasRegistroSalida: !!tablasRegistro,
                        btnHistorial: !!document.getElementById('btnHistorialSalida'),
                        btnRegistro: !!document.getElementById('btnRegistroSalida'),
                        tablaSalidas: !!document.getElementById('salida_tablaSalidas')
                    },
                    estadoVisibilidad: {
                        historialDisplay: historialSection?.style.display || 'no encontrado',
                        historialVisibility: historialSection?.style.visibility || 'no encontrado',
                        historialComputedDisplay: historialSection ? getComputedStyle(historialSection).display : 'no encontrado',
                        registroDisplay: tablasRegistro?.style.display || 'no encontrado',
                        registroVisibility: tablasRegistro?.style.visibility || 'no encontrado'
                    },
                    funcionesDisponibles: {
                        mostrarHistorialSalida: typeof mostrarHistorialSalida === 'function',
                        mostrarRegistroSalida: typeof mostrarRegistroSalida === 'function',
                        consultarSalidas: typeof consultarSalidas === 'function',
                        forzarHistorialVisible: typeof window.forzarHistorialVisible === 'function'
                    }
                };
                
                console.log('📊 Estado completo del Control de Salida:', result);
                return result;
            } catch (error) {
                console.error('❌ Error en debugControlSalida:', error);
                return { error: error.message };
            }
        };

        console.log('✅ Funciones de debugging ultra-mejoradas cargadas:', {
            forzarHistorialVisible: typeof window.forzarHistorialVisible === 'function',
            testHistorialUltraRapido: typeof window.testHistorialUltraRapido === 'function',
            debugControlSalida: typeof window.debugControlSalida === 'function'
        });

        // ===================================================================
        // 🔧 FUNCIÓN INDEPENDIENTE PARA SOLUCIONAR HISTORIAL (LIBRE DE ERRORES)
        // ===================================================================
        
        // Función que funciona independientemente de los errores de permisos/navegación
        window.solucionarHistorialDefinitiva = function() {
            console.log('🚀 SOLUCIONANDO HISTORIAL - Independiente de errores de sistema');
            
            try {
                // PASO 1: Verificar si los elementos existen, si no los crea
                let historialSection = document.getElementById('historialSection');
                let tablasRegistro = document.getElementById('tablasRegistroSalida');
                
                if (!historialSection) {
                    console.log('⚠️ historialSection no encontrado, buscando alternativas...');
                    // Buscar por clase o crear uno nuevo
                    historialSection = document.querySelector('[id*="historial"]') || 
                                     document.querySelector('.historial-section') ||
                                     document.querySelector('[class*="historial"]');
                    
                    if (!historialSection) {
                        console.log('🔧 Creando historialSection dinámicamente...');
                        historialSection = document.createElement('div');
                        historialSection.id = 'historialSection';
                        historialSection.innerHTML = `
                            <div style="padding: 20px; background: #2c3e50; color: white; border-radius: 8px;">
                                <h3>🔥 HISTORIAL DE SALIDA FORZADO 🔥</h3>
                                <p>El historial se está mostrando de forma independiente.</p>
                                <button onclick="consultarSalidas()" style="background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                                    Consultar Salidas
                                </button>
                                <div id="salida_tablaSalidas" style="margin-top: 20px;">
                                    <table style="width: 100%; border-collapse: collapse; color: white;">
                                        <thead>
                                            <tr style="background: #34495e;">
                                                <th style="padding: 10px; border: 1px solid #7f8c8d;">Fecha</th>
                                                <th style="padding: 10px; border: 1px solid #7f8c8d;">Proceso</th>
                                                <th style="padding: 10px; border: 1px solid #7f8c8d;">Código</th>
                                                <th style="padding: 10px; border: 1px solid #7f8c8d;">Material</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="padding: 10px; border: 1px solid #7f8c8d; text-align: center;" colspan="4">
                                                    Haga clic en "Consultar Salidas" para cargar datos
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                        
                        // Buscar un contenedor donde insertar
                        const contenedor = document.querySelector('.container-fluid') || 
                                         document.querySelector('.container') ||
                                         document.querySelector('main') ||
                                         document.body;
                        contenedor.appendChild(historialSection);
                    }
                }
                
                // PASO 2: Ocultar completamente las tablas de registro (si existen)
                if (tablasRegistro) {
                    tablasRegistro.style.cssText = `
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                        position: absolute !important;
                        left: -9999px !important;
                    `;
                }
                
                // También buscar y ocultar otros elementos de registro
                const otrosRegistros = document.querySelectorAll('[id*="registro"], [class*="registro"], [id*="tabla"]');
                otrosRegistros.forEach(elemento => {
                    if (elemento !== historialSection && elemento.id !== 'salida_tablaSalidas') {
                        elemento.style.display = 'none !important';
                    }
                });
                
                // PASO 3: Forzar visibilidad extrema del historial
                historialSection.style.cssText = `
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    z-index: 99999 !important;
                    position: relative !important;
                    background-color: #2c3e50 !important;
                    color: #ecf0f1 !important;
                    padding: 30px !important;
                    margin: 20px auto !important;
                    border: 5px solid #e74c3c !important;
                    border-radius: 15px !important;
                    min-height: 400px !important;
                    width: 95% !important;
                    max-width: 1200px !important;
                    box-shadow: 0 0 30px rgba(231, 76, 60, 0.8) !important;
                    transform: scale(1.02) !important;
                `;
                
                // PASO 4: Configurar fechas automáticamente
                const hoy = new Date().toISOString().split('T')[0];
                const inputsFecha = historialSection.querySelectorAll('input[type="date"]');
                inputsFecha.forEach(input => {
                    if (!input.value) {
                        input.value = hoy;
                    }
                });
                
                // PASO 5: Actualizar botones si existen
                const btnHistorial = document.getElementById('btnHistorialSalida');
                const btnRegistro = document.getElementById('btnRegistroSalida');
                
                if (btnHistorial) {
                    btnHistorial.style.cssText = `
                        background-color: #e74c3c !important;
                        color: white !important;
                        font-weight: bold !important;
                        border: 3px solid #c0392b !important;
                        transform: scale(1.1) !important;
                    `;
                }
                if (btnRegistro) {
                    btnRegistro.style.cssText = `
                        background-color: #95a5a6 !important;
                        color: #2c3e50 !important;
                        opacity: 0.7 !important;
                    `;
                }
                
                // PASO 6: Crear indicador de éxito
                const indicador = document.createElement('div');
                indicador.id = 'historial-solucionado-indicator';
                indicador.style.cssText = `
                    position: fixed !important;
                    top: 50% !important;
                    left: 50% !important;
                    transform: translate(-50%, -50%) !important;
                    background-color: #27ae60 !important;
                    color: white !important;
                    padding: 20px !important;
                    border-radius: 10px !important;
                    z-index: 999999 !important;
                    font-weight: bold !important;
                    font-size: 18px !important;
                    text-align: center !important;
                    box-shadow: 0 0 20px rgba(0,0,0,0.7) !important;
                `;
                indicador.innerHTML = `
                    <div>✅ HISTORIAL SOLUCIONADO ✅</div>
                    <div style="margin: 10px 0;">Independiente de errores de sistema</div>
                    <div style="font-size: 14px;">Se auto-ocultará en 5 segundos</div>
                `;
                document.body.appendChild(indicador);
                
                // PASO 7: Scroll ultra-forzado al historial
                setTimeout(() => {
                    historialSection.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center',
                        inline: 'center'
                    });
                }, 100);
                
                // PASO 8: Auto-quitar indicador
                setTimeout(() => {
                    if (indicador && indicador.parentNode) {
                        indicador.remove();
                    }
                }, 5000);
                
                console.log('✅ HISTORIAL SOLUCIONADO DEFINITIVAMENTE');
                console.log('📊 Estado final:', {
                    historialEncontrado: !!historialSection,
                    historialVisible: historialSection.style.display,
                    registroOculto: tablasRegistro ? tablasRegistro.style.display : 'no existe'
                });
                
                return '✅ HISTORIAL SOLUCIONADO - Debería verse con borde rojo brillante';
                
            } catch (error) {
                console.error('❌ Error en solucionarHistorialDefinitiva:', error);
                
                // FALLBACK EXTREMO: Crear historial básico en el body
                const fallbackHistorial = document.createElement('div');
                fallbackHistorial.style.cssText = `
                    position: fixed !important;
                    top: 100px !important;
                    left: 50px !important;
                    right: 50px !important;
                    background: red !important;
                    color: white !important;
                    padding: 30px !important;
                    z-index: 999999 !important;
                    border-radius: 10px !important;
                `;
                fallbackHistorial.innerHTML = `
                    <h2>🔥 HISTORIAL FORZADO (FALLBACK) 🔥</h2>
                    <p>Si ves esto, el historial está funcionando independientemente de todos los errores.</p>
                    <p>Error original: ${error.message}</p>
                `;
                document.body.appendChild(fallbackHistorial);
                
                return 'Fallback activado - Error: ' + error.message;
            }
        };
        
        // Auto-ejecutar si hay errores de navegación detectados
        document.addEventListener('DOMContentLoaded', function() {
            // Detectar si hay errores de navegación/permisos
            setTimeout(() => {
                const hayErroresDeNavegacion = document.querySelectorAll('.error, [class*="error"]').length > 0 ||
                                             window.console.toString().includes('error') ||
                                             !document.getElementById('historialSection');
                
                if (hayErroresDeNavegacion) {
                    console.log('🔧 Errores de navegación detectados, auto-ejecutando solución...');
                    window.solucionarHistorialDefinitiva();
                }
            }, 2000);
        });
        
        console.log('✅ Solución definitiva de historial cargada - Use: solucionarHistorialDefinitiva()');

        // ===================================================================
        // � AUTO-INICIALIZACIÓN DE FUNCIONALIDAD HISTORIAL - INDEPENDIENTE
        // ===================================================================
        
        // Función principal que controla todo el historial de salidas
        function inicializarHistorialSalida() {
            console.log('� INICIALIZANDO HISTORIAL DE SALIDA - Auto-detección AJAX');
            
            // Buscar elementos principales
            const btnHistorial = document.getElementById('btnHistorialSalida');
            const btnRegistro = document.getElementById('btnRegistroSalida');
            const btnConsultar = document.querySelector('#historialSection button[onclick*="consultarSalidas"]');
            
            if (!btnHistorial || !btnRegistro) {
                console.log('⚠️ Botones no encontrados, reintentando...');
                return false;
            }
            
            console.log('✅ Elementos encontrados, configurando funcionalidad...');
            
            // FUNCIÓN: Mostrar historial
            function mostrarHistorial() {
                console.log('📊 Mostrando historial de salidas...');
                
                const historialSection = document.getElementById('historialSection');
                const tablasRegistro = document.getElementById('tablasRegistroSalida');
                
                if (!historialSection || !tablasRegistro) {
                    console.error('❌ Elementos de historial no encontrados');
                    return;
                }
                
                // Ocultar registro y mostrar historial
                tablasRegistro.style.display = 'none';
                historialSection.style.display = 'block';
                historialSection.style.visibility = 'visible';
                historialSection.style.opacity = '1';
                
                // Configurar fechas automáticamente
                const hoy = new Date().toISOString().split('T')[0];
                const fechaDesde = document.getElementById('salida_fecha_desde');
                const fechaHasta = document.getElementById('salida_fecha_hasta');
                
                if (fechaDesde && !fechaDesde.value) fechaDesde.value = hoy;
                if (fechaHasta && !fechaHasta.value) fechaHasta.value = hoy;
                
                // Actualizar estilos de botones
                btnHistorial.style.cssText = 'background-color: #e74c3c; color: white; font-weight: bold;';
                btnRegistro.style.cssText = 'background-color: #95a5a6; color: #2c3e50;';
                
                console.log('✅ HISTORIAL MOSTRADO EXITOSAMENTE');
            }
            
            // FUNCIÓN: Mostrar registro
            function mostrarRegistro() {
                console.log('📝 Mostrando registro de salidas...');
                
                const historialSection = document.getElementById('historialSection');
                const tablasRegistro = document.getElementById('tablasRegistroSalida');
                
                if (!historialSection || !tablasRegistro) {
                    console.error('❌ Elementos de registro no encontrados');
                    return;
                }
                
                // Ocultar historial y mostrar registro
                historialSection.style.display = 'none';
                tablasRegistro.style.display = 'block';
                tablasRegistro.style.visibility = 'visible';
                tablasRegistro.style.opacity = '1';
                
                // Actualizar estilos de botones
                btnRegistro.style.cssText = 'background-color: #27ae60; color: white; font-weight: bold;';
                btnHistorial.style.cssText = 'background-color: #95a5a6; color: #2c3e50;';
                
                console.log('✅ REGISTRO MOSTRADO EXITOSAMENTE');
            }
            
            // FUNCIÓN: Consultar datos
            async function consultarDatos() {
                console.log('🔍 Consultando datos de historial...');
                
                try {
                    const codigoFiltro = document.getElementById('salida_filtro_codigo')?.value?.trim() || '';
                    const fechaDesde = document.getElementById('salida_fecha_desde')?.value || '';
                    const fechaHasta = document.getElementById('salida_fecha_hasta')?.value || '';
                    
                    let url = '/consultar_historial_salidas';
                    const params = new URLSearchParams();
                    
                    if (codigoFiltro) params.append('codigo', codigoFiltro);
                    if (fechaDesde) params.append('fecha_desde', fechaDesde);
                    if (fechaHasta) params.append('fecha_hasta', fechaHasta);
                    
                    if (params.toString()) url += '?' + params.toString();
                    
                    const response = await fetch(url);
                    const salidas = await response.json();
                    
                    if (Array.isArray(salidas)) {
                        actualizarTablaSalidas(salidas);
                        mostrarExito(`Consulta exitosa: ${salidas.length} registros encontrados`);
                    } else {
                        mostrarError('Error en la consulta de datos');
                    }
                    
                } catch (error) {
                    console.error('❌ Error al consultar:', error);
                    mostrarError('Error al consultar datos: ' + error.message);
                }
            }
            
            // CONFIGURAR EVENT LISTENERS
            
            // Remover event listeners existentes
            btnHistorial.removeAttribute('onclick');
            btnRegistro.removeAttribute('onclick');
            
            // Agregar nuevos event listeners
            btnHistorial.addEventListener('click', function(e) {
                e.preventDefault();
                mostrarHistorial();
            });
            
            btnRegistro.addEventListener('click', function(e) {
                e.preventDefault();
                mostrarRegistro();
            });
            
            // Configurar botón consultar si existe
            if (btnConsultar) {
                btnConsultar.removeAttribute('onclick');
                btnConsultar.addEventListener('click', function(e) {
                    e.preventDefault();
                    consultarDatos();
                });
            }
            
            // También buscar otros botones de consultar por selector más general
            const otrosBtnConsultar = document.querySelectorAll('#historialSection button');
            otrosBtnConsultar.forEach(btn => {
                if (btn.textContent.toLowerCase().includes('consultar')) {
                    btn.removeAttribute('onclick');
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        consultarDatos();
                    });
                }
            });
            
            console.log('✅ HISTORIAL INICIALIZADO CORRECTAMENTE');
            return true;
        }
        
        // ===================================================================
        // � AUTO-REINICIALIZACIÓN DESPUÉS DE CARGAS AJAX
        // ===================================================================
        
        // Función que detecta cuando la página se ha cargado completamente
        function detectarCargaCompleta() {
            // Intentar inicializar múltiples veces para asegurar que funcione
            let intentos = 0;
            const maxIntentos = 10;
            
            const intervalos = setInterval(() => {
                intentos++;
                
                if (inicializarHistorialSalida()) {
                    clearInterval(intervalos);
                    console.log('✅ Historial inicializado en intento:', intentos);
                } else if (intentos >= maxIntentos) {
                    clearInterval(intervalos);
                    console.log('⚠️ No se pudo inicializar historial después de', maxIntentos, 'intentos');
                }
            }, 500); // Intentar cada 500ms
        }
        
        // ===================================================================
        // 🎯 HOOK PARA INTERCEPTAR CARGAS AJAX Y AUTO-REINICIALIZAR
        // ===================================================================
        
        // Interceptar cuando el contenido de este módulo se carga
        if (typeof window.cargarContenidoDinamico === 'function') {
            // Guardar la función original
            const originalCargar = window.cargarContenidoDinamico;
            
            // Sobrescribir la función para detectar cuando se carga este módulo
            window.cargarContenidoDinamico = function(containerId, templatePath, initCallback = null) {
                // Llamar a la función original
                const resultado = originalCargar.call(this, containerId, templatePath, initCallback);
                
                // Si se está cargando el módulo de salida, reinicializar
                if (templatePath && templatePath.includes('salida')) {
                    console.log('🔄 Detectada carga AJAX de Control de Salida, reinicializando...');
                    setTimeout(detectarCargaCompleta, 100);
                }
                
                return resultado;
            };
        }
        
        // ===================================================================
        // 🚀 INICIALIZACIÓN AUTOMÁTICA EN MÚLTIPLES PUNTOS
        // ===================================================================
        
        // 1. Si DOM ya está listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', detectarCargaCompleta);
        } else {
            detectarCargaCompleta();
        }
        
        // 2. Intentos adicionales por si AJAX se demora
        setTimeout(detectarCargaCompleta, 100);
        setTimeout(detectarCargaCompleta, 500);
        setTimeout(detectarCargaCompleta, 1000);
        
        // 3. Función global de debugging que siempre estará disponible
        window.debugHistorialSalida = function() {
            console.log('🧪 DEBUGGING HISTORIAL DE SALIDA');
            
            const estado = {
                elementosEncontrados: {
                    btnHistorial: !!document.getElementById('btnHistorialSalida'),
                    btnRegistro: !!document.getElementById('btnRegistroSalida'),
                    historialSection: !!document.getElementById('historialSection'),
                    tablasRegistro: !!document.getElementById('tablasRegistroSalida')
                },
                funcionesDisponibles: {
                    inicializarHistorialSalida: typeof inicializarHistorialSalida === 'function',
                    consultarSalidas: typeof consultarSalidas === 'function',
                    mostrarHistorialSalida: typeof mostrarHistorialSalida === 'function'
                }
            };
            
            console.table(estado.elementosEncontrados);
            console.table(estado.funcionesDisponibles);
            
            // Intentar reinicializar
            if (inicializarHistorialSalida()) {
                console.log('✅ Reinicialización exitosa');
            } else {
                console.log('❌ Falló la reinicialización');
            }
            
            return estado;
        };
        
        console.log('🚀 SISTEMA DE AUTO-INICIALIZACIÓN HISTORIAL CARGADO');
        console.log('💡 Use debugHistorialSalida() para debugging');

        // ===================================================================
        // 🔧 FUNCIÓN DE ACTIVACIÓN MANUAL (COMPATIBILIDAD CON VERSIÓN ANTERIOR)
        // ===================================================================
        
        window.activarHistorialDirecto = function() {
            console.log('🔄 Activación manual solicitada, redirigiendo a sistema automático...');
            return detectarCargaCompleta();
                        tablasRegistro: !!tablasRegistro
                    });
                    
                    // Si no encuentra historialSection, buscar alternativas
                    if (!historialSection) {
                        console.log('⚠️ Buscando historialSection alternativo...');
                        
                        // Buscar por query selector más amplio
                        historialSection = document.querySelector('[id*="historial"]') ||
                                         document.querySelector('.historial') ||
                                         document.querySelector('[class*="historial"]');
                        
                        if (!historialSection) {
                            console.log('🔧 Creando historialSection desde cero...');
                            
                            // Crear sección de historial completamente nueva
                            historialSection = document.createElement('div');
                            historialSection.id = 'historialSection';
                            historialSection.innerHTML = `
                                <div style="background: linear-gradient(135deg, #2c3e50, #3498db); color: white; padding: 30px; border-radius: 15px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                                    <div style="text-align: center; margin-bottom: 20px;">
                                        <h2 style="color: #ecf0f1; margin: 0; font-size: 24px;">🔥 HISTORIAL DE SALIDA ACTIVADO 🔥</h2>
                                        <p style="color: #bdc3c7; margin: 10px 0;">Sistema funcionando independientemente</p>
                                    </div>
                                    
                                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; color: #ecf0f1;">Fecha desde:</label>
                                            <input type="date" id="salida_fecha_desde" style="padding: 8px; border-radius: 5px; border: none;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; color: #ecf0f1;">Fecha hasta:</label>
                                            <input type="date" id="salida_fecha_hasta" style="padding: 8px; border-radius: 5px; border: none;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; color: #ecf0f1;">Código material:</label>
                                            <input type="text" id="salida_filtro_codigo" placeholder="Buscar..." style="padding: 8px; border-radius: 5px; border: none;">
                                        </div>
                                        <div style="display: flex; align-items: end; gap: 10px;">
                                            <button onclick="consultarSalidas()" style="background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                                🔍 Consultar
                                            </button>
                                            <button onclick="limpiarFiltros()" style="background: #e67e22; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
                                                🧹 Limpiar
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 20px;">
                                        <table id="salida_tablaSalidas" style="width: 100%; border-collapse: collapse; color: white;">
                                            <thead>
                                                <tr style="background: rgba(0,0,0,0.3);">
                                                    <th style="padding: 12px; border: 1px solid rgba(255,255,255,0.2); text-align: left;">Fecha</th>
                                                    <th style="padding: 12px; border: 1px solid rgba(255,255,255,0.2); text-align: left;">Proceso</th>
                                                    <th style="padding: 12px; border: 1px solid rgba(255,255,255,0.2); text-align: left;">Código Recibido</th>
                                                    <th style="padding: 12px; border: 1px solid rgba(255,255,255,0.2); text-align: left;">Código Material</th>
                                                    <th style="padding: 12px; border: 1px solid rgba(255,255,255,0.2); text-align: left;">Número Parte</th>
                                                    <th style="padding: 12px; border: 1px solid rgba(255,255,255,0.2); text-align: center;">Disp</th>
                                                    <th style="padding: 12px; border: 1px solid rgba(255,255,255,0.2); text-align: center;">Hist</th>
                                                    <th style="padding: 12px; border: 1px solid rgba(255,255,255,0.2); text-align: left;">Código Original</th>
                                                    <th style="padding: 12px; border: 1px solid rgba(255,255,255,0.2); text-align: left;">Lote</th>
                                                    <th style="padding: 12px; border: 1px solid rgba(255,255,255,0.2); text-align: left;">Máquina</th>
                                                    <th style="padding: 12px; border: 1px solid rgba(255,255,255,0.2); text-align: left;">Departamento</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="11" style="padding: 20px; text-align: center; color: #bdc3c7; font-style: italic;">
                                                        Haga clic en "Consultar" para cargar los datos del historial
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <div id="salida_totalInfo" style="margin-top: 10px; color: #bdc3c7; text-align: center;">Total Rows: 0</div>
                                    </div>
                                </div>
                            `;
                            
                            // Buscar dónde insertarlo
                            const contenedor = document.querySelector('main') ||
                                             document.querySelector('.container') ||
                                             document.querySelector('.app-content') ||
                                             document.body;
                            
                            contenedor.appendChild(historialSection);
                            console.log('✅ historialSection creado e insertado');
                        }
                    }
                    
                    // PASO 3: Ocultar completamente las tablas de registro
                    if (tablasRegistro) {
                        tablasRegistro.style.cssText = `
                            display: none !important;
                            visibility: hidden !important;
                            opacity: 0 !important;
                            position: absolute !important;
                            left: -9999px !important;
                        `;
                        console.log('✅ Tablas de registro ocultadas');
                    }
                    
                    // También ocultar otros elementos que puedan interferir
                    const elementosRegistro = document.querySelectorAll('[id*="registro"], [class*="registro"]');
                    elementosRegistro.forEach(elemento => {
                        if (elemento !== historialSection && elemento.id !== 'salida_tablaSalidas') {
                            elemento.style.display = 'none';
                        }
                    });
                    
                    // PASO 4: Mostrar y forzar visibilidad del historial
                    historialSection.style.cssText = `
                        display: block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        z-index: 10000 !important;
                        position: relative !important;
                        width: 100% !important;
                        max-width: 100% !important;
                    `;
                    
                    // PASO 5: Configurar fechas automáticamente
                    const hoy = new Date().toISOString().split('T')[0];
                    const fechaDesde = document.getElementById('salida_fecha_desde');
                    const fechaHasta = document.getElementById('salida_fecha_hasta');
                    
                    if (fechaDesde && !fechaDesde.value) {
                        fechaDesde.value = hoy;
                    }
                    if (fechaHasta && !fechaHasta.value) {
                        fechaHasta.value = hoy;
                    }
                    
                    // PASO 6: Actualizar estilo del botón
                    btnHistorial.style.cssText = `
                        background-color: #27ae60 !important;
                        color: white !important;
                        font-weight: bold !important;
                        border: 2px solid #2ecc71 !important;
                        transform: scale(1.05) !important;
                    `;
                    
                    // PASO 7: Scroll suave al historial
                    setTimeout(() => {
                        historialSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }, 100);
                    
                    // PASO 8: Mostrar mensaje de confirmación
                    const mensaje = document.createElement('div');
                    mensaje.style.cssText = `
                        position: fixed !important;
                        top: 20px !important;
                        right: 20px !important;
                        background: #27ae60 !important;
                        color: white !important;
                        padding: 15px 20px !important;
                        border-radius: 8px !important;
                        z-index: 99999 !important;
                        font-weight: bold !important;
                        box-shadow: 0 5px 15px rgba(0,0,0,0.3) !important;
                    `;
                    mensaje.innerHTML = `
                        <div>✅ HISTORIAL ACTIVADO</div>
                        <div style="font-size: 12px; margin-top: 5px;">Método directo funcionando</div>
                    `;
                    document.body.appendChild(mensaje);
                    
                    setTimeout(() => {
                        if (mensaje && mensaje.parentNode) {
                            mensaje.remove();
                        }
                    }, 5000);
                    
                    console.log('🎉 HISTORIAL ACTIVADO EXITOSAMENTE - Método directo');
                    
                    return false; // Prevenir comportamiento por defecto
                };
                
                // PASO 3: También agregar event listener como respaldo
                btnHistorial.addEventListener('click', btnHistorial.onclick);
                
                // PASO 4: Trigger inmediato para probar
                btnHistorial.click();
                
                return '✅ HISTORIAL ACTIVADO CON MÉTODO DIRECTO';
                
            } catch (error) {
                console.error('❌ Error en activarHistorialDirecto:', error);
                
                // FALLBACK: Crear historial directamente en el body
                const fallback = document.createElement('div');
                fallback.style.cssText = `
                    position: fixed !important;
                    top: 50px !important;
                    left: 50px !important;
                    right: 50px !important;
                    bottom: 50px !important;
                    background: red !important;
                    color: white !important;
                    padding: 30px !important;
                    z-index: 999999 !important;
                    border-radius: 15px !important;
                    overflow: auto !important;
                `;
                fallback.innerHTML = `
                    <h1>🔥 HISTORIAL FORZADO (FALLBACK EXTREMO) 🔥</h1>
                    <p>Si ves esto, el historial está funcionando a pesar de todos los errores.</p>
                    <p>Error: ${error.message}</p>
                    <button onclick="this.parentElement.remove()" style="background: white; color: red; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">
                        Cerrar
                    </button>
                `;
                document.body.appendChild(fallback);
                
                return 'Fallback extremo activado';
            }
        };
        
        // ===================================================================
        // 🔥 SOLUCIÓN ULTRA-SIMPLE - SOLO CAMBIAR DISPLAY
        // ===================================================================
        
        window.simpleHistorial = function() {
            console.log('🔥 SOLUCIÓN ULTRA-SIMPLE EJECUTADA');
            
            // PASO 1: Obtener elementos directamente
            const historial = document.getElementById('historialSection');
            const registro = document.getElementById('tablasRegistroSalida');
            const btnHistorial = document.getElementById('btnHistorialSalida');
            const btnRegistro = document.getElementById('btnRegistroSalida');
            
            console.log('📊 Elementos encontrados:', {
                historial: !!historial,
                registro: !!registro,
                btnHistorial: !!btnHistorial,
                btnRegistro: !!btnRegistro
            });
            
            if (!historial) {
                console.error('❌ historialSection no encontrado');
                alert('ERROR: historialSection no encontrado');
                return 'Error: historialSection no encontrado';
            }
            
            if (!registro) {
                console.error('❌ tablasRegistroSalida no encontrado');
                alert('ERROR: tablasRegistroSalida no encontrado');
                return 'Error: tablasRegistroSalida no encontrado';
            }
            
            // PASO 2: Cambios simples y directos
            console.log('🔧 Aplicando cambios directos...');
            
            // Ocultar registro
            registro.style.display = 'none';
            
            // Mostrar historial
            historial.style.display = 'block';
            historial.style.visibility = 'visible';
            historial.style.opacity = '1';
            
            // Configurar fechas
            const hoy = new Date().toISOString().split('T')[0];
            const fechaDesde = document.getElementById('salida_fecha_desde');
            const fechaHasta = document.getElementById('salida_fecha_hasta');
            
            if (fechaDesde) fechaDesde.value = hoy;
            if (fechaHasta) fechaHasta.value = hoy;
            
            // Cambiar colores de botones
            if (btnHistorial) {
                btnHistorial.style.backgroundColor = '#e74c3c';
                btnHistorial.style.color = 'white';
            }
            if (btnRegistro) {
                btnRegistro.style.backgroundColor = '#95a5a6';
                btnRegistro.style.color = '#2c3e50';
            }
            
            console.log('✅ HISTORIAL MOSTRADO - Estado:', {
                historialDisplay: historial.style.display,
                registroDisplay: registro.style.display
            });
            
            // Scroll suave
            historial.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            return '✅ HISTORIAL SIMPLE ACTIVADO';
        };
        
        // ===================================================================
        // 🔥 REEMPLAZAR COMPLETAMENTE EL ONCLICK DEL BOTÓN
        // ===================================================================
        
        // Esperar a que el DOM esté listo y reemplazar el onclick
        function reemplazarOnclickHistorial() {
            const btnHistorial = document.getElementById('btnHistorialSalida');
            
            if (!btnHistorial) {
                console.log('⏳ Botón historial no encontrado, reintentando...');
                setTimeout(reemplazarOnclickHistorial, 500);
                return;
            }
            
            console.log('🔧 REEMPLAZANDO ONCLICK DEL BOTÓN HISTORIAL');
            
            // Eliminar onclick existente
            btnHistorial.removeAttribute('onclick');
            
            // Remover event listeners existentes
            btnHistorial.onclick = null;
            
            // Agregar nuevo event listener SIMPLE
            btnHistorial.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('🔥 CLICK SIMPLE EN HISTORIAL');
                
                // Ejecutar función ultra-simple
                window.simpleHistorial();
                
                return false;
            });
            
            console.log('✅ ONCLICK REEMPLAZADO EXITOSAMENTE');
        }
        
        // ===================================================================
        // 🔥 SOLUCIÓN COMPATIBLE CON AJAX - PERSISTENTE Y AUTOREGISTRABLE
        // ===================================================================
        
        // PASO 1: Crear funciones persistentes en window que sobrevivan a recargas AJAX
        (function() {
            console.log('🚀 INICIANDO SOLUCIÓN ANTI-AJAX PARA HISTORIAL');
            
            // Función principal que siempre estará disponible
            window.HISTORIAL_SOLUCION = {
                activo: false,
                elementos: {},
                
                // Función principal para mostrar historial
                mostrar: function() {
                    console.log('🔥 EJECUTANDO HISTORIAL_SOLUCION.mostrar()');
                    
                    try {
                        // Buscar elementos cada vez (por si fueron recreados por AJAX)
                        this.elementos = {
                            historial: document.getElementById('historialSection'),
                            registro: document.getElementById('tablasRegistroSalida'),
                            btnHistorial: document.getElementById('btnHistorialSalida'),
                            btnRegistro: document.getElementById('btnRegistroSalida')
                        };
                        
                        console.log('📊 Elementos encontrados:', {
                            historial: !!this.elementos.historial,
                            registro: !!this.elementos.registro,
                            btnHistorial: !!this.elementos.btnHistorial,
                            btnRegistro: !!this.elementos.btnRegistro
                        });
                        
                        if (!this.elementos.historial) {
                            console.error('❌ historialSection NO ENCONTRADO');
                            alert('ERROR: No se encontró la sección de historial');
                            return false;
                        }
                        
                        if (!this.elementos.registro) {
                            console.error('❌ tablasRegistroSalida NO ENCONTRADO');
                            alert('ERROR: No se encontró la sección de registro');
                            return false;
                        }
                        
                        // CAMBIOS DIRECTOS Y SIMPLES
                        console.log('🔧 Aplicando cambios de visibilidad...');
                        
                        // Ocultar registro
                        this.elementos.registro.style.display = 'none';
                        this.elementos.registro.style.visibility = 'hidden';
                        
                        // Mostrar historial
                        this.elementos.historial.style.display = 'block';
                        this.elementos.historial.style.visibility = 'visible';
                        this.elementos.historial.style.opacity = '1';
                        
                        // Configurar fechas
                        const hoy = new Date().toISOString().split('T')[0];
                        const fechaDesde = document.getElementById('salida_fecha_desde');
                        const fechaHasta = document.getElementById('salida_fecha_hasta');
                        
                        if (fechaDesde) fechaDesde.value = hoy;
                        if (fechaHasta) fechaHasta.value = hoy;
                        
                        // Cambiar apariencia de botones
                        if (this.elementos.btnHistorial) {
                            this.elementos.btnHistorial.style.backgroundColor = '#e74c3c';
                            this.elementos.btnHistorial.style.color = 'white';
                            this.elementos.btnHistorial.style.fontWeight = 'bold';
                        }
                        if (this.elementos.btnRegistro) {
                            this.elementos.btnRegistro.style.backgroundColor = '#95a5a6';
                            this.elementos.btnRegistro.style.color = '#2c3e50';
                        }
                        
                        console.log('✅ HISTORIAL MOSTRADO EXITOSAMENTE');
                        console.log('📊 Estado final:', {
                            historialDisplay: this.elementos.historial.style.display,
                            registroDisplay: this.elementos.registro.style.display
                        });
                        
                        // Scroll al historial
                        setTimeout(() => {
                            this.elementos.historial.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start' 
                            });
                        }, 100);
                        
                        this.activo = true;
                        return true;
                        
                    } catch (error) {
                        console.error('❌ Error en HISTORIAL_SOLUCION.mostrar:', error);
                        alert('ERROR: ' + error.message);
                        return false;
                    }
                },
                
                // Función para instalar el onclick
                instalarOnclick: function() {
                    console.log('🔧 INSTALANDO ONCLICK PERSISTENTE...');
                    
                    const btn = document.getElementById('btnHistorialSalida');
                    if (!btn) {
                        console.log('⏳ Botón no encontrado, reintentando...');
                        setTimeout(() => this.instalarOnclick(), 500);
                        return;
                    }
                    
                    // Eliminar onclick anterior
                    btn.removeAttribute('onclick');
                    btn.onclick = null;
                    
                    // Instalar nuevo onclick
                    btn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('🎯 CLICK INTERCEPTADO - Ejecutando HISTORIAL_SOLUCION');
                        this.mostrar();
                        return false;
                    };
                    
                    console.log('✅ ONCLICK INSTALADO EXITOSAMENTE');
                },
                
                // Función para verificar y reparar
                verificarYReparar: function() {
                    console.log('🔍 VERIFICANDO ESTADO DEL HISTORIAL...');
                    
                    const btn = document.getElementById('btnHistorialSalida');
                    if (!btn) {
                        console.log('⚠️ Botón historial no encontrado');
                        return;
                    }
                    
                    // Verificar si el onclick está instalado
                    if (!btn.onclick || btn.onclick.toString().indexOf('HISTORIAL_SOLUCION') === -1) {
                        console.log('🔧 Onclick no instalado, instalando...');
                        this.instalarOnclick();
                    } else {
                        console.log('✅ Onclick ya está instalado correctamente');
                    }
                }
            };
            
            // Función de compatibilidad hacia atrás
            window.simpleHistorial = function() {
                return window.HISTORIAL_SOLUCION.mostrar();
            };
            
            console.log('✅ HISTORIAL_SOLUCION registrado en window');
        })();
        
        // PASO 2: Auto-instalación que funciona con AJAX
        function autoInstalarHistorial() {
            console.log('🚀 AUTO-INSTALACIÓN DE HISTORIAL...');
            
            // Verificar si ya está instalado
            if (window.HISTORIAL_SOLUCION) {
                window.HISTORIAL_SOLUCION.verificarYReparar();
            }
            
            // Programar verificaciones periódicas
            setTimeout(() => {
                if (window.HISTORIAL_SOLUCION) {
                    window.HISTORIAL_SOLUCION.verificarYReparar();
                }
            }, 1000);
            
            setTimeout(() => {
                if (window.HISTORIAL_SOLUCION) {
                    window.HISTORIAL_SOLUCION.verificarYReparar();
                }
            }, 3000);
        }
        
        // PASO 3: Múltiples puntos de entrada para diferentes estados de carga
        
        // Si el DOM ya está listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', autoInstalarHistorial);
        } else {
            autoInstalarHistorial();
        }
        
        // Instalación inmediata
        setTimeout(autoInstalarHistorial, 100);
        setTimeout(autoInstalarHistorial, 500);
        setTimeout(autoInstalarHistorial, 1000);
        setTimeout(autoInstalarHistorial, 2000);
        
        // PASO 4: Hook para después de cargas AJAX
        
        // Interceptar cargas AJAX comunes
        const originalInnerHTML = Object.getOwnPropertyDescriptor(Element.prototype, 'innerHTML');
        if (originalInnerHTML) {
            Object.defineProperty(Element.prototype, 'innerHTML', {
                set: function(value) {
                    originalInnerHTML.set.call(this, value);
                    
                    // Si se actualiza algún contenedor, reinstalar el historial
                    if (this.id && (this.id.includes('container') || this.id.includes('content'))) {
                        console.log('🔄 Contenido AJAX actualizado, reinstalando historial...');
                        setTimeout(() => {
                            if (window.HISTORIAL_SOLUCION) {
                                window.HISTORIAL_SOLUCION.verificarYReparar();
                            }
                        }, 100);
                    }
                },
                get: originalInnerHTML.get
            });
        }
        
        // PASO 5: Función de debugging persistente
        window.debugHistorial = function() {
            console.log('🐛 DEBUG HISTORIAL PERSISTENTE');
            
            if (!window.HISTORIAL_SOLUCION) {
                return '❌ HISTORIAL_SOLUCION no disponible';
            }
            
            const estado = {
                sistemaActivo: !!window.HISTORIAL_SOLUCION,
                elementosEncontrados: {},
                estadoVisibilidad: {}
            };
            
            // Verificar elementos
            const historial = document.getElementById('historialSection');
            const registro = document.getElementById('tablasRegistroSalida');
            const btnHistorial = document.getElementById('btnHistorialSalida');
            
            estado.elementosEncontrados = {
                historial: !!historial,
                registro: !!registro,
                btnHistorial: !!btnHistorial
            };
            
            if (historial) {
                estado.estadoVisibilidad.historial = {
                    display: historial.style.display,
                    visibility: historial.style.visibility,
                    computed: getComputedStyle(historial).display
                };
            }
            
            if (registro) {
                estado.estadoVisibilidad.registro = {
                    display: registro.style.display,
                    visibility: registro.style.visibility,
                    computed: getComputedStyle(registro).display
                };
            }
            
            if (btnHistorial) {
                estado.estadoVisibilidad.boton = {
                    onclick: !!btnHistorial.onclick,
                    onclickContiene: btnHistorial.onclick ? 
                        btnHistorial.onclick.toString().includes('HISTORIAL_SOLUCION') : false
                };
            }
            
            console.log('📊 Estado completo:', estado);
            return estado;
        };
        
        console.log('✅ SOLUCIÓN ANTI-AJAX COMPLETAMENTE CARGADA');
        console.log('🎯 Para usar: window.HISTORIAL_SOLUCION.mostrar() o simpleHistorial()');
        console.log('🐛 Para debug: debugHistorial()');

        // ===================================================================
        // 🚀 IMPLEMENTACIÓN DIRECTA EN AJAX - ELEGANTE Y ESPECÍFICA
        // ===================================================================
        
        // Función principal auto-ejecutable que se inicializa inmediatamente
        (function inicializarControlSalidaAJAX() {
            console.log('🚀 INICIALIZANDO CONTROL DE SALIDA - Implementación directa AJAX');
            
            // Esperar a que los elementos estén disponibles
            function esperarElementosYConfigurar() {
                const btnHistorial = document.getElementById('btnHistorialSalida');
                const btnRegistro = document.getElementById('btnRegistroSalida');
                const historialSection = document.getElementById('historialSection');
                const tablasRegistro = document.getElementById('tablasRegistroSalida');
                
                if (!btnHistorial || !btnRegistro || !historialSection || !tablasRegistro) {
                    // Reintentar después de 200ms
                    setTimeout(esperarElementosYConfigurar, 200);
                    return;
                }
                
                console.log('✅ Todos los elementos encontrados, configurando...');
                
                // ==========================================
                // FUNCIÓN: Mostrar Historial
                // ==========================================
                function mostrarHistorial() {
                    console.log('📊 Mostrando historial...');
                    
                    // Ocultar registro
                    tablasRegistro.style.display = 'none';
                    
                    // Mostrar historial
                    historialSection.style.display = 'block';
                    historialSection.style.visibility = 'visible';
                    historialSection.style.opacity = '1';
                    
                    // Configurar fechas automáticamente
                    const hoy = new Date().toISOString().split('T')[0];
                    const fechaDesde = document.getElementById('salida_fecha_desde');
                    const fechaHasta = document.getElementById('salida_fecha_hasta');
                    
                    if (fechaDesde && !fechaDesde.value) fechaDesde.value = hoy;
                    if (fechaHasta && !fechaHasta.value) fechaHasta.value = hoy;
                    
                    // Actualizar botones
                    btnHistorial.style.cssText = 'background-color: #e74c3c; color: white; font-weight: bold;';
                    btnRegistro.style.cssText = 'background-color: #95a5a6; color: #2c3e50;';
                    
                    console.log('✅ HISTORIAL MOSTRADO EXITOSAMENTE');
                }
                
                // ==========================================
                // FUNCIÓN: Mostrar Registro
                // ==========================================
                function mostrarRegistro() {
                    console.log('📝 Mostrando registro...');
                    
                    // Ocultar historial
                    historialSection.style.display = 'none';
                    
                    // Mostrar registro
                    tablasRegistro.style.display = 'block';
                    tablasRegistro.style.visibility = 'visible';
                    tablasRegistro.style.opacity = '1';
                    
                    // Actualizar botones
                    btnRegistro.style.cssText = 'background-color: #27ae60; color: white; font-weight: bold;';
                    btnHistorial.style.cssText = 'background-color: #95a5a6; color: #2c3e50;';
                    
                    console.log('✅ REGISTRO MOSTRADO EXITOSAMENTE');
                }
                
                // ==========================================
                // CONFIGURAR EVENT LISTENERS
                // ==========================================
                
                // Limpiar event listeners existentes
                btnHistorial.removeAttribute('onclick');
                btnRegistro.removeAttribute('onclick');
                
                // Agregar nuevos event listeners
                btnHistorial.addEventListener('click', function(e) {
                    e.preventDefault();
                    mostrarHistorial();
                });
                
                btnRegistro.addEventListener('click', function(e) {
                    e.preventDefault();
                    mostrarRegistro();
                });
                
                // Configurar botón consultar
                const btnConsultar = document.querySelector('#historialSection button');
                if (btnConsultar && btnConsultar.textContent.toLowerCase().includes('consultar')) {
                    btnConsultar.removeAttribute('onclick');
                    btnConsultar.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (typeof consultarSalidas === 'function') {
                            consultarSalidas();
                        } else {
                            console.log('🔍 Función consultarSalidas no disponible');
                        }
                    });
                }
                
                console.log('✅ EVENT LISTENERS CONFIGURADOS EXITOSAMENTE');
                
                // ==========================================
                // FUNCIONES GLOBALES DE DEBUGGING
                // ==========================================
                
                window.testHistorialDirecto = function() {
                    console.log('🧪 PROBANDO HISTORIAL DIRECTO...');
                    mostrarHistorial();
                    return '✅ Test completado - ¿Se muestra el historial?';
                };
                
                window.testRegistroDirecto = function() {
                    console.log('🧪 PROBANDO REGISTRO DIRECTO...');
                    mostrarRegistro();
                    return '✅ Test completado - ¿Se muestra el registro?';
                };
                
                window.estadoControlSalida = function() {
                    return {
                        elementosEncontrados: {
                            btnHistorial: !!btnHistorial,
                            btnRegistro: !!btnRegistro,
                            historialSection: !!historialSection,
                            tablasRegistro: !!tablasRegistro
                        },
                        estadoVisibilidad: {
                            historialDisplay: historialSection.style.display,
                            registroDisplay: tablasRegistro.style.display
                        },
                        timestamp: new Date().toISOString()
                    };
                };
                
                console.log('🎯 CONTROL DE SALIDA INICIALIZADO COMPLETAMENTE');
                console.log('💡 Funciones disponibles: testHistorialDirecto(), testRegistroDirecto(), estadoControlSalida()');
            }
            
            // Iniciar configuración
            esperarElementosYConfigurar();
            
        })(); // Auto-ejecutar la función inmediatamente

    </script>
</body>
</html>