<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Material - Almacén</title>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=LG+regular&display=swap" rel="stylesheet">
    
    <!-- Estilos globales -->
    <link rel="stylesheet" href="/static/css/control_material_almacen.css">
    
    <!-- Scripts necesarios -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/popper.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/fontawesome.all.min.js"></script>
    <script src="/static/js/Chart.min.js"></script>
    <script src="/static/js/jquery.dataTables.min.js"></script>
    <script src="/static/js/dataTables.bootstrap5.min.js"></script>
    <script src="/static/js/sweetalert2.all.min.js"></script>
    <script src="/static/js/moment.min.js"></script>
    <script src="/static/js/daterangepicker.js"></script>
    <script src="/static/js/select2.min.js"></script>
    <script src="/static/js/flatpickr.min.js"></script>
    <script src="/static/js/autoNumeric.min.js"></script>
    <script src="/static/js/control_material_almacen.js"></script>
    
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- QR Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <!-- QR Generator Module -->
    <script src="/static/js/qr-generator.js"></script>
    
    <!-- QR Almacén Simple - NO MODIFICA FUNCIONES EXISTENTES -->
    <script src="/static/js/qr-almacen-simple.js"></script>
    
    <!-- QR Almacén Integration - Funciones de utilidad y demostración ZPL -->
    <script src="/static/js/qr-almacen-integration.js"></script>
    
</head>
<body>
     <!-- Fila 1: SOLO Forma de material, ancho completo -->
<div class="material-container2">

    <div class="material-form-section">
        <div class="material-form-group" >
            <label>
                    Forma de material
            </label>
            <select id="forma_material">
                <option>
                    OriginCode
                </option>
            </select>
        </div>
    </div>

    <div class="material-form-section">    
        <div class="material-form-row four-column">
            <div class="material-form-group">
                <label>
                    Cliente
                </label>
                <select id="cliente">
                    <option value="">
                        Seleccionar
                    </option>
                    <option value="LG_REFRIS">
                        LG_REFRIS
                    </option>
                    <option value="LG_ESTUFAS">
                        LG_ESTUFAS
                    </option>
                </select>
            </div>
            <div class="material-form-group">
                <label>Código de material original</label>
                <div style="display: flex; align-items: center; gap: 8px; min-width: 0;">
                    <input type="text" id="codigoMaterialOriginal" style="flex: 1; min-width: 0;" placeholder="Escanear o ingresar código..." onkeydown="procesarScaneo(event)">
                    <button type="button" onclick="abrirEscanerQR()" class="material-btn" title="Escanear QR con cámara" style="padding: 5px 12px; font-size: 16px; line-height: 1;">📸</button>
                </div>
            </div>
    </div>

    <div class="material-form-row four-column">
        <div class="material-form-group">
            <label>Código de material</label>
            <div style="position: relative; min-width: 0;">
                <select id="codigoMaterialSelect" onclick="event.preventDefault(); abrirModalCodigoMaterial();" readonly style="cursor: pointer; width: 100%;">
                    <option value="">Seleccionar</option>
                </select>
                
          
                <div id="modalCodigoMaterial" class="dropdown-modal">
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar código, nombre o especificación..." onkeyup="filtrarTablaModal()">
                    <div class="dropdown-table-container">
                        <table class="dropdown-table">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Especificación</th>
                                </tr>
                            </thead>
                            <tbody id="tablaCodigosBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="material-form-group">
            <label>Material importación/local</label>
            <select id="material_importacion_local">
                <option value="Customer Supply">Customer Supply</option>
                <option value="Local">Local</option>
                <option value="Importación">Importación</option>
            </select>
        </div>
        <div class="material-form-group">
            <label>Fecha de recibo</label>
            <input type="date" id="fecha_recibo">
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
    </div>
    <div class="material-form-row four-column">
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
    </div>

    <div class="material-form-row four-column">
        <div class="material-form-group">
            <label>Fecha de fabricación</label>
            <input type="date" id="fecha_fabricacion">
        </div>
        <div class="material-form-group">
            <label>Cantidad actual:</label>
            <input type="text" id="cantidad_actual">
        </div>
        <div class="material-form-group">
            <label>Número de lote de material</label>
            <input type="text" id="numero_lote_material">
        </div>
    </div>
        </div>
        
    
<div class="material-form-section2">
    <div class="material-form-row four-column" style="align-items: center;">
        <div class="material-form-group">
            <label>Código de material recibido</label>
            <input type="text" id="codigo_material_recibido">
        </div>
        <div class="material-form-group">
            <label>Número de parte:</label>
            <input type="text" id="numero_parte_lower">
        </div>
        <div class="material-form-group">
            <label>Cantidad estandarizada</label>
            <input type="text" id="cantidad_estandarizada">
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
        
        <div class="material-form-group">
            <label>Código de material</label>
            <input type="text" id="codigo_material_lower">
        </div>
        <div class="material-form-group">
            <label>Propiedad de material</label>
            <input type="text" id="propiedad_material">
        </div>
        <div class="material-form-group">
            <label>Especificación de material</label>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="almacen_especificacion_material" readonly placeholder="Se carga automáticamente al seleccionar código" style="flex: 1;">
                <label class="checkbox-label-almacen" style="display: flex; align-items: center; gap: 8px; color: #ecf0f1; font-size: 12px; cursor: pointer; white-space: nowrap;">
                    <input type="checkbox" id="checkbox_registro_almacen" class="checkbox-almacen" style="transform: scale(1.0); accent-color: #27ae60;">
                    Registro automático
                </label>
            </div>
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
        <div class="material-form-group"></div>
        <div class="material-form-group"></div>
        <div class="material-form-group" style="justify-self: end;">
             <div style="display: flex; gap: 4px; align-items: center;">
                <button class="material-btn orange botones-almacen" id="btnGuardar" onclick="guardarFormulario()">Guardar</button>
                <button class="material-btn botones-almacen">Imprimir</button>
                <button class="material-btn" onclick="probarQRZPLDirecto()" style="background: #6f42c1; color: white;" title="Genera QR con formato ZPL">🦓 Test ZPL</button>
            </div>
        </div>
        <div class="material-form-group">
            <!-- Campo vacío para mantener estructura -->
        </div>
    </div>
</div>

        <!-- Botonera usando el diseño de CONTROL_DE_MATERIAL -->
        

        <!-- Sección de filtros usando el diseño de CONTROL_DE_MATERIAL -->
        <div class="material-toolbar">
            <div style="display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0; overflow: hidden;">
                <label style="margin: 0; color: lightgray; font-size: 11px; white-space: nowrap;">Fecha de recibo</label>
                <input type="date" id="filtro_fecha_inicio" style="width: 130px; height: 24px; font-size: 10px; font-family: sans-serif; min-width: 100px;">
                <span style="color: lightgray; font-size: 11px;">~</span>
                <input type="date" id="filtro_fecha_fin" style="width: 130px; height: 24px; font-size: 10px; min-width: 100px;">
            </div>
            <div style="display: flex; gap: 6px; flex-shrink: 0;">
                <button class="material-btn" id="btnConsultar" onclick="consultarRegistros()">Consultar</button>
                <button class="material-btn secondary" onclick="exportarExcel()">Exportar Excel</button>
                <button class="material-btn" onclick="mostrarEjemploZPLDirecto()" style="background: #6f42c1; color: white;" title="Muestra el formato ZPL actualizado para Zebra">🔍 Ver ZPL</button>
                <button class="material-btn" onclick="probarQRZPLDirecto()" style="background: #fd7e14; color: white;" title="Prueba la generación QR con el nuevo formato">🧪 Test QR</button>
                <button class="material-btn" onclick="verificarModulosQRDisponibles()" style="background: #17a2b8; color: white;" title="Verifica el estado de los módulos QR">🔧 Estado</button>
                <button class="material-btn" onclick="llenarFormularioEjemplo()" style="background: #28a745; color: white;" title="Llena el formulario con datos de ejemplo">📝 Ejemplo</button>
            </div>
        </div>

        <!-- Tabla de resultados -->
        <div class="material-table-container">
            <table class="material-table" id="tablaControlAlmacen">
                <thead>
                    <tr>
                        <th>Código de material recibido</th>
                        <th>Código de material</th>
                        <th>Número de parte</th>
                        <th>Número de lote de material</th>
                        <th>Propiedad de material</th>
                        <th>Cantidad actual</th>
                        <th>Cantidad estandarizada</th>
                        <th>Ubicación de salida</th>
                        <th>Fecha de recibo</th>
                        <th>Especificación</th>
                        <th>Material importación/local</th>
                        <th>Estado de desecho</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="12" class="no-data">
                            No hay datos para mostrar. Haga clic en "Consultar" para cargar los registros.
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <p class="total-info">Total Rows: 0</p>
        </div>

    </div>

    <script>
        let codigosMaterial = [];

        // FUNCIONES DIRECTAS PARA BOTONES DE PRUEBA ZPL
        function mostrarEjemploZPLDirecto() {
            const datosEjemplo = {
                codigoCompleto: '0RH5602C622,202507170003',
                codigoMaterial: '0RH5602C622',
                numeroSerie: '202507170003',
                fecha: '17/07/2025',
                cantidadEstandarizada: '5000',
                descripcionMaterial: '56KJ 1/10W (SMD 1608)'
            };
            
            const zplEjemplo = `CT~~CD,~CC^~CT~
^XA
~TA000
~JSN
^LT37
^MNW
^MTT
^PON
^PMN
^LH0,0
^JMA
^PR4,4
~SD15
^JUS
^LRN
^CI27
^PA0,1,1,0
^XZ
^XA
^MMT
^PW392
^LL165
^LS0
^FT168,75^A0N,16,15^FH\\^CI28^FDFecha de entrada:^FS^CI27
^FT167,122^A0N,18,18^FH\\^CI28^FDQTY:^FS^CI27
^FT5,175^BQN,2,6
^FH\\^FDLA,${datosEjemplo.codigoCompleto}^FS
^FT168,26^A0N,25,25^FH\\^CI28^FD${datosEjemplo.codigoMaterial}^FS^CI27
^FT168,57^A0N,25,25^FH\\^CI28^FD${datosEjemplo.numeroSerie}^FS^CI27
^FT168,97^A0N,21,20^FH\\^CI28^FD${datosEjemplo.fecha}^FS^CI27
^FT168,151^A0N,21,20^FH\\^CI28^FD${datosEjemplo.descripcionMaterial}^FS^CI27
^FT203,124^A0N,22,20^FH\\^CI28^FD${datosEjemplo.cantidadEstandarizada}^FS^CI27
^PQ1,0,1,Y
^XZ`;
            
            // Crear modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
                align-items: center; z-index: 10003; padding: 20px; box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 20px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
                        📋 Formato ZPL Actualizado - Zebra ZD421
                    </h3>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="color: #6f42c1; margin-bottom: 10px;">📊 Variables que se insertan automáticamente:</h4>
                        <ul style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 0;">
                            <li><strong>Código completo:</strong> ${datosEjemplo.codigoCompleto}</li>
                            <li><strong>Código material:</strong> ${datosEjemplo.codigoMaterial}</li>
                            <li><strong>Número serie:</strong> ${datosEjemplo.numeroSerie}</li>
                            <li><strong>Fecha entrada:</strong> ${datosEjemplo.fecha}</li>
                            <li><strong>Cantidad:</strong> ${datosEjemplo.cantidadEstandarizada}</li>
                            <li><strong>Descripción:</strong> ${datosEjemplo.descripcionMaterial}</li>
                        </ul>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="color: #28a745; margin-bottom: 10px;">🖨️ Comando ZPL Generado:</h4>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; border: 1px solid #dee2e6;">${zplEjemplo}</pre>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4 style="color: #dc3545; margin-bottom: 10px;">⚡ Características del formato:</h4>
                        <ul style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 0; border: 1px solid #ffeaa7;">
                            <li>✅ Compatible con Zebra ZD421</li>
                            <li>✅ Código QR automático con datos completos</li>
                            <li>✅ Variables dinámicas del formulario</li>
                            <li>✅ Formato de fecha DD/MM/YYYY</li>
                            <li>✅ Campos de cantidad y descripción configurables</li>
                        </ul>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="this.closest('div').parentNode.remove()" 
                            style="padding: 12px 30px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">
                            ✓ Entendido
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
            console.log('📋 Modal ZPL mostrado correctamente');
        }

        function probarQRZPLDirecto() {
            const codigoPrueba = '0RH5602C622,202507170003';
            console.log('🧪 Probando generación QR con código:', codigoPrueba);
            
            // Intentar usar el módulo QR si está disponible
            if (window.QRAlmacenSimple && typeof QRAlmacenSimple.generarQR === 'function') {
                console.log('✅ Usando QRAlmacenSimple');
                QRAlmacenSimple.generarQR(codigoPrueba);
            } else if (window.qrGeneratorModule && typeof qrGeneratorModule.generarQR === 'function') {
                console.log('✅ Usando qrGeneratorModule');
                qrGeneratorModule.generarQR(codigoPrueba);
            } else {
                // Fallback: crear QR básico con API externa
                console.log('⚠️ Usando fallback básico');
                mostrarQRBasico(codigoPrueba);
            }
        }

        function mostrarQRBasico(codigo) {
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(codigo)}`;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
                align-items: center; z-index: 10002;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; text-align: center; max-width: 400px;">
                    <h3>📱 Código QR - Test ZPL</h3>
                    <img src="${qrUrl}" alt="QR Code" style="max-width: 100%; margin: 20px 0;"/>
                    <p style="font-family: monospace; word-break: break-all; background: #f5f5f5; padding: 10px; border-radius: 5px;">
                        ${codigo}
                    </p>
                    <p style="color: #666; font-size: 14px;">
                        Este QR usará el nuevo formato ZPL de Zebra ZD421 cuando se imprima
                    </p>
                    <button onclick="this.closest('div').parentNode.remove()" 
                        style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Cerrar
                    </button>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }

        // Función para verificar y mostrar estado de módulos QR
        function verificarModulosQRDisponibles() {
            console.log('🔍 === VERIFICANDO MÓDULOS QR ===');
            
            const modulos = {
                'QRAlmacenSimple': window.QRAlmacenSimple,
                'qrGeneratorModule': window.qrGeneratorModule,
                'QRAlmacenIntegration': window.QRAlmacenIntegration
            };
            
            let modulosDisponibles = [];
            let modulosNoDisponibles = [];
            
            Object.entries(modulos).forEach(([nombre, modulo]) => {
                if (modulo) {
                    modulosDisponibles.push(nombre);
                    console.log(`✅ ${nombre}: Disponible`);
                } else {
                    modulosNoDisponibles.push(nombre);
                    console.log(`❌ ${nombre}: No disponible`);
                }
            });
            
            // Mostrar resumen en consola
            console.log(`📊 Módulos disponibles: ${modulosDisponibles.length}/${Object.keys(modulos).length}`);
            console.log(`✅ Disponibles: ${modulosDisponibles.join(', ')}`);
            if (modulosNoDisponibles.length > 0) {
                console.log(`❌ No disponibles: ${modulosNoDisponibles.join(', ')}`);
            }
            
            // Mostrar en modal si se llama directamente
            if (arguments.length === 0) {
                const statusColor = modulosDisponibles.length === Object.keys(modulos).length ? '#28a745' : '#ffc107';
                alert(`🔍 Estado de Módulos QR:\n\n✅ Disponibles: ${modulosDisponibles.join(', ')}\n\n${modulosNoDisponibles.length > 0 ? '❌ No disponibles: ' + modulosNoDisponibles.join(', ') : 'Todos los módulos están cargados correctamente'}\n\nRevisa la consola para más detalles.`);
            }
            
            return { disponibles: modulosDisponibles, noDisponibles: modulosNoDisponibles };
        }

        // Ejecutar verificación al cargar la página
        setTimeout(() => {
            verificarModulosQRDisponibles();
        }, 2000);

        // Función para llenar formulario con datos de ejemplo para testing
        function llenarFormularioEjemplo() {
            console.log('🎯 Llenando formulario con datos de ejemplo...');
            
            // Llenar campos básicos
            document.getElementById('forma_material').value = 'OriginCode';
            document.getElementById('cliente').value = 'LG_REFRIS';
            document.getElementById('codigoMaterialOriginal').value = '0RH5602C622-ejemplo-test';
            document.getElementById('material_importacion_local').value = 'Local';
            
            // Llenar campos de cantidad y descripción que usa el ZPL
            document.getElementById('cantidad_estandarizada').value = '5000';
            document.getElementById('numero_parte_lower').value = '56KJ 1/10W (SMD 1608)';
            document.getElementById('codigo_material_lower').value = '0RH5602C622';
            document.getElementById('codigo_material_recibido').value = '0RH5602C622,202507170003';
            document.getElementById('propiedad_material').value = '56KJ 1/10W (SMD 1608)';
            document.getElementById('cantidad_actual').value = '5000';
            
            // Resaltar campos llenados
            const campos = ['forma_material', 'cliente', 'codigoMaterialOriginal', 'cantidad_estandarizada', 
                           'numero_parte_lower', 'codigo_material_lower', 'codigo_material_recibido'];
            
            campos.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) {
                    elemento.style.backgroundColor = '#d4edda';
                    elemento.style.transition = 'background-color 0.3s';
                    setTimeout(() => {
                        elemento.style.backgroundColor = '';
                    }, 2000);
                }
            });
            
            console.log('✅ Formulario llenado con datos de ejemplo para testing ZPL');
        }

        // Función global para inicializar cuando se muestra el control de almacén
        window.inicializarControlAlmacenModule = function() {
            // Pequeño delay para asegurar que el DOM esté completamente renderizado
            setTimeout(() => {
                inicializarControlAlmacen();
                configurarListenersAdicionales();
                // Asegurar que las fechas siempre estén actuales al cambiar de módulo
                establecerFechasActuales();
            }, 100);
        };

        // Cargar códigos de material al cargar la página
        function inicializarControlAlmacen() {
            // *** TABLA VISIBLE POR DEFECTO PARA DEBUGGING ***
            const tabla = document.getElementById('tablaControlAlmacen');
            if (tabla) {
                tabla.style.display = 'table';
            }
            
            // Establecer fecha actual en todos los campos de fecha
            establecerFechasActuales();
            
            cargarCodigosMaterial();
            cargarClienteSeleccionado(); // Cargar la última selección de cliente
            cargarSiguienteSecuencial(); // Cargar el siguiente número secuencial
        }

        // Nueva función para establecer fechas actuales
        function establecerFechasActuales() {
            // Usar el mismo método que setFechasHoy() para evitar problemas de zona horaria
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const fechaHoy = `${year}-${month}-${day}`;
            
            // Establecer fecha actual en campos principales
            const fechaRecibo = document.getElementById('fecha_recibo');
            const fechaFabricacion = document.getElementById('fecha_fabricacion');
            const filtroFechaInicio = document.getElementById('filtro_fecha_inicio');
            const filtroFechaFin = document.getElementById('filtro_fecha_fin');
            
            if (fechaRecibo) fechaRecibo.value = fechaHoy;
            if (fechaFabricacion) fechaFabricacion.value = fechaHoy;
            if (filtroFechaInicio) filtroFechaInicio.value = fechaHoy;
            if (filtroFechaFin) filtroFechaFin.value = fechaHoy;
            
            console.log(`📅 Fechas establecidas a: ${fechaHoy}`);
        }

        // Verificar si el DOM ya está listo o esperar a que lo esté
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarControlAlmacen);
        } else {
            // DOM ya está listo, ejecutar inmediatamente
            inicializarControlAlmacen();
        }

        // Función para cargar la última selección de cliente
        async function cargarClienteSeleccionado() {
            try {
                const response = await fetch('/cargar_cliente_seleccionado');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.cliente) {
                        const selectCliente = document.getElementById('cliente');
                        if (selectCliente) {
                            selectCliente.value = data.cliente;
                        }
                    }
                }
            } catch (error) {
                console.error('Error al cargar cliente seleccionado:', error);
            }
        }

        // Función para guardar la selección de cliente
        async function guardarClienteSeleccionado(cliente) {
            try {
                const response = await fetch('/guardar_cliente_seleccionado', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cliente: cliente })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (!data.success) {
                        console.error('❌ Error al guardar cliente:', data.error);
                    }
                }
            } catch (error) {
                console.error('❌ Error de conexión al guardar cliente:', error);
            }
        }

        async function cargarCodigosMaterial() {
            try {
                const response = await fetch('/obtener_codigos_material');
                
                if (response.ok) {
                    codigosMaterial = await response.json();
                } else {
                    console.error('Error al cargar códigos de material, status:', response.status);
                    // Si hay error, usar datos de prueba
                    codigosMaterial = [
                        {codigo: 'M2606809020', nombre: 'M2606809020', spec: '68F 1608', cantidad_estandarizada: '1000', propiedad_material: '68F 1608'},
                        {codigo: 'M2609109005', nombre: 'M2609109005', spec: '91F 1608', cantidad_estandarizada: '2000', propiedad_material: '91F 1608'},
                        {codigo: 'NFM961W550504', nombre: 'NFM961W550504', spec: 'S7882_10.1_NOKEY_FW0F', cantidad_estandarizada: '500', propiedad_material: 'S7882_10.1_NOKEY_FW0F'}
                    ];
                }
            } catch (error) {
                console.error('Error en fetch:', error);
                // Si hay error, usar datos de prueba
                codigosMaterial = [
                    {codigo: 'M2606809020', nombre: 'M2606809020', spec: '68F 1608', cantidad_estandarizada: '1000', propiedad_material: '68F 1608'},
                    {codigo: 'M2609109005', nombre: 'M2609109005', spec: '91F 1608', cantidad_estandarizada: '2000', propiedad_material: '91F 1608'},
                    {codigo: 'NFM961W550504', nombre: 'NFM961W550504', spec: 'S7882_10.1_NOKEY_FW0F', cantidad_estandarizada: '500', propiedad_material: 'S7882_10.1_NOKEY_FW0F'}
                ];
            }
        }

        function abrirModalCodigoMaterial() {
            const modal = document.getElementById('modalCodigoMaterial');
            const tbody = document.getElementById('tablaCodigosBody');
            const searchInput = document.getElementById('searchInput');
            
            // Cerrar otros dropdowns si están abiertos
            cerrarModalCodigoMaterial();
            
            // Limpiar búsqueda
            searchInput.value = '';
            
            // Llenar la tabla
            tbody.innerHTML = '';
            
            if (codigosMaterial.length === 0) {
                // Mostrar mensaje de "no hay datos"
                const fila = tbody.insertRow();
                fila.innerHTML = '<td colspan="3" style="text-align: center; padding: 20px; color: #666;">No hay códigos disponibles</td>';
            } else {
                codigosMaterial.forEach(codigo => {
                    const fila = tbody.insertRow();
                    fila.innerHTML = `
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.codigo}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.nombre}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.spec}</td>
                    `;
                });
            }
            
            // Mostrar el modal con animación suave
            modal.style.display = 'block';
            
            // Enfocar el campo de búsqueda
            setTimeout(() => {
                searchInput.focus();
            }, 100);
        }

        function cerrarModalCodigoMaterial() {
            document.getElementById('modalCodigoMaterial').style.display = 'none';
        }

        function seleccionarCodigo(codigo) {
            const select = document.getElementById('codigoMaterialSelect');
            
            // Buscar la información completa del código seleccionado
            const codigoCompleto = codigosMaterial.find(c => c.codigo === codigo);
            
            // Actualizar el select con el código seleccionado
            select.innerHTML = `
                <option value="${codigo}" selected>${codigo}</option>
                <option value="">Seleccionar</option>
            `;
            
            // Mostrar la especificación inmediatamente al seleccionar
            if (codigoCompleto) {
                select.title = `${codigoCompleto.codigo} - ${codigoCompleto.nombre} - ${codigoCompleto.spec}`;
                
                // Llenar inmediatamente el campo de especificación
                llenarCampoPorId('almacen_especificacion_material', codigoCompleto.especificacion_material || codigoCompleto.spec || '');
                console.log(`📋 Especificación cargada inmediatamente: ${codigoCompleto.especificacion_material || codigoCompleto.spec}`);
                console.log(`📋 Número de parte disponible: ${codigoCompleto.numero_parte}`);
            }
            
            cerrarModalCodigoMaterial();
            
            // Llenar automáticamente los campos inferiores después de seleccionar
            setTimeout(() => {
                llenarCamposInferiores(codigo);
            }, 500);
        }

        function filtrarTablaModal() {
            const input = document.getElementById('searchInput');
            const filtro = input.value.toLowerCase();
            const tbody = document.getElementById('tablaCodigosBody');
            
            tbody.innerHTML = '';
            
            const codigosFiltrados = codigosMaterial.filter(codigo => 
                codigo.codigo.toLowerCase().includes(filtro) ||
                codigo.nombre.toLowerCase().includes(filtro) ||
                codigo.spec.toLowerCase().includes(filtro)
            );
            
            if (codigosFiltrados.length === 0) {
                const fila = tbody.insertRow();
                fila.innerHTML = '<td colspan="3" style="text-align: center; padding: 15px;">No se encontraron resultados</td>';
            } else {
                codigosFiltrados.forEach(codigo => {
                    const fila = tbody.insertRow();
                    fila.innerHTML = `
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.codigo}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.nombre}</td>
                        <td onclick="seleccionarCodigo('${codigo.codigo}')">${codigo.spec}</td>
                    `;
                });
            }
        }

        // Cerrar modal al hacer clic fuera de él
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalCodigoMaterial');
            const select = document.getElementById('codigoMaterialSelect');
            
            // Si se hace clic fuera del modal y del select, cerrar el modal
            if (!modal.contains(event.target) && !select.contains(event.target)) {
                cerrarModalCodigoMaterial();
            }
        });

        // Configurar listeners adicionales cuando la página esté lista
        function configurarListenersAdicionales() {
            // Agregar event listener al select de cliente
            const selectCliente = document.getElementById('cliente');
            if (selectCliente) {
                selectCliente.addEventListener('change', function() {
                    const clienteSeleccionado = this.value;
                    if (clienteSeleccionado) {
                        guardarClienteSeleccionado(clienteSeleccionado);
                        
                        // Resaltar visualmente que se guardó
                        this.style.backgroundColor = '#d4edda';
                        this.style.borderColor = '#c3e6cb';
                        setTimeout(() => {
                            this.style.backgroundColor = '';
                            this.style.borderColor = '';
                        }, 1500);
                    }
                });
            }
            
            // Agregar listener adicional al botón de consultar para asegurar que funcione
            const btnConsultar = document.getElementById('btnConsultar');
            if (btnConsultar) {
                btnConsultar.addEventListener('click', function(e) {
                    // Solo prevenir default si no hay onclick definido
                    if (!this.onclick) {
                        e.preventDefault();
                        consultarRegistros();
                    }
                });
            }
        }

        // Verificar si el DOM ya está listo para configurar listeners adicionales
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', configurarListenersAdicionales);
        } else {
            // DOM ya está listo, ejecutar inmediatamente
            configurarListenersAdicionales();
        }

        function procesarScaneo(event) {
            // Detectar Enter (cuando termina el escaneo)
            if (event.key === 'Enter') {
                event.preventDefault();
                const codigoCompleto = event.target.value.trim();
                
                if (codigoCompleto) {
                    parsearYDistribuirCodigo(codigoCompleto);
                }
            }
        }

        function procesarCodigoManual() {
            const input = document.getElementById('codigoMaterialOriginal');
            const codigoCompleto = input.value.trim();
            
            if (codigoCompleto) {
                parsearYDistribuirCodigo(codigoCompleto);
            } else {
                alert('Por favor, ingrese o escanear un código antes de procesar.');
            }
        }

        async function parsearYDistribuirCodigo(codigoCompleto) {
            try {
                // Primero intentar con las reglas de trazabilidad
                const resultado = await aplicarReglasEscaneo(codigoCompleto);
                
                if (resultado) {
                    // Si se encontró una regla que coincide, usar esos datos
                    if (resultado.partNumber) {
                        // Usar el partNumber como código de material
                        buscarYSeleccionarCodigoMaterial(resultado.partNumber);
                    }
                    
                    if (resultado.lotNumber) {
                        const inputLote = document.getElementById('numero_lote_material');
                        if (inputLote) {
                            inputLote.value = resultado.lotNumber;
                        }
                    }
                    
                    mostrarNotificacionEscaneo(resultado.partNumber, null, resultado.lotNumber);
                    return;
                }
                
                // Si no funciona con reglas, usar el método anterior como fallback
                const partes = codigoCompleto.split('-');
                
                if (partes.length < 8) {
                    alert('Formato de código inválido. No se encontró regla aplicable y no tiene el formato esperado con "/" ');
                    return;
                }
                
                // Extraer SOLO el código de material y número de lote (método anterior)
                const codigoMaterial = partes[0];           // M2124740058
                const numeroLote = partes[7];               // IA3116H14
                
                // Distribuir a los campos correspondientes
                if (codigoMaterial) {
                    buscarYSeleccionarCodigoMaterial(codigoMaterial);
                }
                
                if (numeroLote) {
                    const inputLote = document.getElementById('numero_lote_material');
                    if (inputLote) {
                        inputLote.value = numeroLote;
                    }
                }
                
                mostrarNotificacionEscaneo(codigoMaterial, null, numeroLote);
                
            } catch (error) {
                console.error('Error al procesar código escaneado:', error);
                alert('Error al procesar el código escaneado');
            }
        }

        function buscarYSeleccionarCodigoMaterial(codigo) {
            // Buscar si el código existe en la lista de materiales
            const codigoEncontrado = codigosMaterial.find(c => c.codigo === codigo);
            
            if (codigoEncontrado) {
                // Si existe, seleccionarlo automáticamente
                seleccionarCodigo(codigo);
            } else {
                // Si no existe, mostrar en el dropdown pero sin seleccionar
                const select = document.getElementById('codigoMaterialSelect');
                select.innerHTML = `
                    <option value="${codigo}" selected>${codigo} (Código escaneado - no encontrado en BD)</option>
                    <option value="">Seleccionar</option>
                `;
                select.style.backgroundColor = '#fff3cd'; // Resaltar en amarillo
                console.warn('Código de material no encontrado en la base de datos:', codigo);
                
                // También llenar campos básicos aunque no esté en BD
                llenarCamposInferiores(codigo);
                
                setTimeout(() => {
                    select.style.backgroundColor = '';
                }, 3000);
            }
        }

        function mostrarNotificacionEscaneo(codigo, cantidad, lote) {
            // Llenar automáticamente los campos inferiores
            llenarCamposInferiores(codigo);
        }

        // Contador global para números secuenciales del código de material recibido
        let contadorSecuencial = 1;
        let proximoCodigoCompleto = '';

        // Función para cargar el siguiente número secuencial desde la base de datos
        async function cargarSiguienteSecuencial(codigoMaterial = '') {
            try {
                // Construir URL con código de material si está disponible
                let url = '/obtener_siguiente_secuencial';
                if (codigoMaterial) {
                    url += `?codigo_material=${encodeURIComponent(codigoMaterial)}`;
                }
                
                console.log(`🔍 Cargando secuencial desde: ${url}`);
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`📊 Respuesta del servidor:`, data);
                    
                    if (data.success) {
                        contadorSecuencial = data.siguiente_secuencial || 1;
                        proximoCodigoCompleto = data.proximo_codigo_completo || '';
                        
                        console.log(`✅ Variables actualizadas:`);
                        console.log(`   - contadorSecuencial: ${contadorSecuencial}`);
                        console.log(`   - proximoCodigoCompleto: ${proximoCodigoCompleto}`);
                    } else {
                        contadorSecuencial = 1;
                        proximoCodigoCompleto = '';
                        console.warn(`⚠️ Respuesta sin éxito, usando valores por defecto`);
                    }
                } else {
                    contadorSecuencial = 1;
                    proximoCodigoCompleto = '';
                    console.error(`❌ Error en respuesta HTTP: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ Error de conexión al cargar secuencial:', error);
                contadorSecuencial = 1;
                proximoCodigoCompleto = '';
            }
        }

        function llenarCamposInferiores(codigoMaterial) {
            console.log(`🔍 llenarCamposInferiores llamado con: ${codigoMaterial}`);
            
            // Buscar la información completa del código de material
            const codigoCompleto = codigosMaterial.find(c => c.codigo === codigoMaterial);
            console.log(`📦 Información completa encontrada:`, codigoCompleto);
            
            // FORZAR recarga del contador específico para este código de material
            console.log(`🔄 Recargando contador para código: ${codigoMaterial}`);
            
            cargarSiguienteSecuencial(codigoMaterial).then(() => {
                console.log(`📊 Variables después de cargar:`);
                console.log(`   - contadorSecuencial: ${contadorSecuencial}`);
                console.log(`   - proximoCodigoCompleto: ${proximoCodigoCompleto}`);
                
                // USAR DIRECTAMENTE proximoCodigoCompleto del servidor
                let codigoMaterialRecibidoCompleto = proximoCodigoCompleto;
                
                // Solo como fallback si el servidor no devuelve el código completo
                if (!codigoMaterialRecibidoCompleto) {
                    const fechaActual = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                    const secuenciaFormateada = String(contadorSecuencial).padStart(4, '0');
                    codigoMaterialRecibidoCompleto = `${codigoMaterial},${fechaActual}${secuenciaFormateada}`;
                    console.warn(`⚠️ Usando código generado como fallback: ${codigoMaterialRecibidoCompleto}`);
                }
                
                console.log(`🏷️ Código material recibido final: ${codigoMaterialRecibidoCompleto}`);
                
                if (codigoCompleto) {
                    llenarCampoPorId('codigo_material_recibido', codigoMaterialRecibidoCompleto);
                    llenarCampoPorId('codigo_material_lower', codigoMaterial);
                    // ✅ CORREGIDO: Usar el verdadero número de parte de la base de datos
                    llenarCampoPorId('numero_parte_lower', codigoCompleto.numero_parte || '');
                    llenarCampoPorId('cantidad_estandarizada', codigoCompleto.cantidad_estandarizada || '');
                    llenarCampoPorId('cantidad_actual', codigoCompleto.cantidad_estandarizada || '');
                    llenarCampoPorId('propiedad_material', codigoCompleto.propiedad_material || '');
                    llenarCampoPorId('almacen_especificacion_material', codigoCompleto.especificacion_material || '');
                    llenarCampoPorId('numero_lote_material', '');
                    
                    console.log(`📋 Número de parte de DB cargado: ${codigoCompleto.numero_parte}`);
                    console.log(`📋 Especificación de material cargada: ${codigoCompleto.especificacion_material}`);
                } else {
                    llenarCampoPorId('codigo_material_recibido', codigoMaterialRecibidoCompleto);
                    llenarCampoPorId('codigo_material_lower', codigoMaterial);
                    // ✅ CORREGIDO: Si no hay información completa, dejar vacío en lugar de usar secuencial
                    llenarCampoPorId('numero_parte_lower', '');
                    llenarCampoPorId('almacen_especificacion_material', '');
                    llenarCampoPorId('numero_lote_material', '');
                }
            }).catch(error => {
                console.error('❌ Error al cargar secuencial:', error);
                // En caso de error, usar valores por defecto
                const fechaActual = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const codigoMaterialRecibidoCompleto = `${codigoMaterial},${fechaActual}0001`;
                llenarCampoPorId('codigo_material_recibido', codigoMaterialRecibidoCompleto);
                llenarCampoPorId('codigo_material_lower', codigoMaterial);
                // ✅ CORREGIDO: Si hay error, usar el número de parte de la selección (si existe)
                const codigoCompleto = codigosMaterial.find(c => c.codigo === codigoMaterial);
                llenarCampoPorId('numero_parte_lower', codigoCompleto ? (codigoCompleto.numero_parte || '') : '');
            });
        }

        function llenarCampoPorId(idCampo, valor) {
            const campo = document.getElementById(idCampo);
            if (campo && valor) {
                campo.value = valor;
                console.log(`✅ Campo ${idCampo} llenado con: ${valor}`);
                
                // Resaltar visualmente el campo que se llenó
                campo.style.backgroundColor = '#e3f2fd';
                campo.style.transition = 'background-color 0.3s';
                
                setTimeout(() => {
                    campo.style.backgroundColor = '';
                }, 2000);
                
            } else if (!campo) {
                console.warn(`❌ Campo no encontrado con ID: ${idCampo}`);
            } else if (!valor) {
                console.warn(`⚠️ Valor vacío para campo: ${idCampo}`);
            }
        }

        function llenarCampoInferior(labelTexto, valor) {
            const labels = document.querySelectorAll('label');
            let campoEncontrado = false;
            
            // Buscar desde el final hacia atrás para encontrar los campos inferiores
            for (let i = labels.length - 1; i >= 0; i--) {
                const label = labels[i];
                if (label.textContent.includes(labelTexto)) {
                    // Si es "Código de material:" tomar el último (inferior)
                    if (labelTexto === 'Código de material:' && campoEncontrado) {
                        continue; // Saltar el primero, queremos el último
                    }
                    
                    const input = label.parentNode.querySelector('input');
                    if (input) {
                        input.value = valor;
                        input.style.backgroundColor = '#e3f2fd'; // Resaltar en azul claro
                        input.style.transition = 'background-color 0.3s';
                        
                        setTimeout(() => {
                            input.style.backgroundColor = '';
                        }, 3000);
                        
                        campoEncontrado = true;
                        
                        // Para "Código de material:" solo tomar el último
                        if (labelTexto !== 'Código de material:') {
                            break;
                        }
                    }
                }
            }
            
            if (!campoEncontrado) {
                console.warn('Campo no encontrado:', labelTexto);
            }
        }

        // Función para reiniciar el contador (opcional, para usar cuando sea necesario)
        // Función para recargar el contador desde la base de datos
        function recargarContador() {
            cargarSiguienteSecuencial();
            console.log('Recargando contador secuencial desde la base de datos...');
        }

        // Función opcional para forzar recarga del contador (para testing/debug)
        function forzarRecargaContador() {
            console.log('🔄 Forzando recarga del contador secuencial...');
            cargarSiguienteSecuencial().then(() => {
                console.log(`✅ Contador recargado. Próximo secuencial: ${String(contadorSecuencial).padStart(4, '0')}`);
            });
        }

        // Función para verificar y llenar manualmente (para testing)
        function llenarCamposInferioresManual() {
            const selectCodigo = document.getElementById('codigoMaterialSelect');
            const codigoSeleccionado = selectCodigo.value;
            
            if (codigoSeleccionado) {
                llenarCamposInferiores(codigoSeleccionado);
            } else {
                alert('Por favor, seleccione primero un código de material');
            }
        }

        // FUNCIÓN DE DIAGNÓSTICO PARA DEBUGGEAR EL SECUENCIAL
        window.diagnosticarSecuencial = async function(codigoMaterial = '0RH5602C622') {
            console.log('🔬 === DIAGNÓSTICO COMPLETO DEL SECUENCIAL ===');
            console.log(`🎯 Código de material a probar: ${codigoMaterial}`);
            
            try {
                // 1. Probar el endpoint directamente
                const url = `/obtener_siguiente_secuencial?codigo_material=${encodeURIComponent(codigoMaterial)}`;
                console.log(`📡 URL de prueba: ${url}`);
                
                const response = await fetch(url);
                console.log(`📊 Status de respuesta: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`📋 Respuesta completa del servidor:`, data);
                    
                    // 2. Mostrar detalles de la respuesta
                    console.log('🔍 Detalles de la respuesta:');
                    console.log(`  - success: ${data.success}`);
                    console.log(`  - siguiente_secuencial: ${data.siguiente_secuencial}`);
                    console.log(`  - proximo_codigo_completo: ${data.proximo_codigo_completo}`);
                    console.log(`  - fecha_actual: ${data.fecha_actual}`);
                    console.log(`  - secuencial_mas_alto_encontrado: ${data.secuencial_mas_alto_encontrado}`);
                    console.log(`  - patron_busqueda: ${data.patron_busqueda}`);
                    
                    // 3. Actualizar variables globales
                    contadorSecuencial = data.siguiente_secuencial || 1;
                    proximoCodigoCompleto = data.proximo_codigo_completo || '';
                    
                    console.log('✅ Variables globales actualizadas:');
                    console.log(`  - contadorSecuencial: ${contadorSecuencial}`);
                    console.log(`  - proximoCodigoCompleto: ${proximoCodigoCompleto}`);
                    
                    // 4. Probar llenar campos
                    console.log('🔄 Probando llenar campos...');
                    llenarCamposInferiores(codigoMaterial);
                    
                } else {
                    console.error(`❌ Error HTTP: ${response.status}`);
                    const text = await response.text();
                    console.error(`❌ Respuesta de error: ${text}`);
                }
                
            } catch (error) {
                console.error('❌ Error en diagnóstico:', error);
            }
            
            console.log('🔬 === FIN DIAGNÓSTICO ===');
        };

        // FUNCIÓN PARA VERIFICAR BASE DE DATOS
        // Función para guardar el formulario
        function guardarFormulario() {
            try {
                // Recopilar todos los datos del formulario
                const formData = {
                    forma_material: document.getElementById('forma_material').value,
                    cliente: document.getElementById('cliente').value,
                    codigo_material_original: document.getElementById('codigoMaterialOriginal').value,
                    codigo_material: document.getElementById('codigoMaterialSelect').value,
                    material_importacion_local: document.getElementById('material_importacion_local').value,
                    fecha_recibo: document.getElementById('fecha_recibo').value,
                    fecha_fabricacion: document.getElementById('fecha_fabricacion').value,
                    cantidad_actual: document.getElementById('cantidad_actual').value,
                    numero_lote_material: document.getElementById('numero_lote_material').value,
                    codigo_material_recibido: document.getElementById('codigo_material_recibido').value,
                    numero_parte: document.getElementById('numero_parte_lower').value,
                    cantidad_estandarizada: document.getElementById('cantidad_estandarizada').value,
                    codigo_material_final: document.getElementById('codigo_material_lower').value,
                    propiedad_material: document.getElementById('propiedad_material').value,
                    especificacion: document.getElementById('almacen_especificacion_material').value
                };
                
                // Validar campos requeridos
                if (!formData.codigo_material_original) {
                    alert('Por favor, ingrese el código de material original');
                    return;
                }
                
                console.log('Datos a guardar:', formData);
                
                // Deshabilitar botón mientras se guarda
                const btnGuardar = document.getElementById('btnGuardar');
                btnGuardar.disabled = true;
                btnGuardar.textContent = 'Guardando...';
                
                // Enviar datos al servidor
                fetch('/guardar_control_almacen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    console.log('Save response status:', response.status);
                    console.log('Save response headers:', response.headers.get('content-type'));
                    
                    // Verificar si la respuesta es JSON
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        return response.json();
                    } else {
                        // Si no es JSON, probablemente es una redirección a login
                        throw new Error('No autenticado - redirigiendo a login');
                    }
                })
                .then(data => {
                    if (data.success) {
                        alert('Registro guardado exitosamente');
                        
                        // *** CAPTURAR DATOS ANTES DE LIMPIAR FORMULARIO ***
                        const datosParaEtiqueta = {
                            codigo: formData.codigo_material_recibido,
                            numeroLote: formData.numero_lote_material || '',
                            numeroParte: formData.numero_parte || '',
                            cantidadActual: formData.cantidad_actual || '',
                            propiedadMaterial: formData.especificacion || ''
                        };
                        
                        console.log('🏷️ Datos capturados para etiqueta:', datosParaEtiqueta);
                        
                        // *** NUEVA FUNCIONALIDAD: Impresión automática directa ***
                        const codigoMaterialRecibido = formData.codigo_material_recibido;
                        if (codigoMaterialRecibido && codigoMaterialRecibido.trim() !== '') {
                            console.log('🎯 Iniciando impresión automática para código:', codigoMaterialRecibido);
                            
                            // Imprimir directamente sin confirmaciones CON DATOS CAPTURADOS
                            setTimeout(() => {
                                imprimirZebraAutomaticoConDatos(datosParaEtiqueta);
                            }, 500);
                        }
                        
                        // IMPORTANTE: Esperar un poco y luego recargar el siguiente secuencial
                        setTimeout(async () => {
                            const codigoActual = document.getElementById('codigoMaterialSelect').value;
                            if (codigoActual) {
                                console.log(`🔄 Recargando siguiente lote para código '${codigoActual}' después de guardar...`);
                                await cargarSiguienteSecuencial(codigoActual);
                                console.log(`✅ Secuencial recargado: ${contadorSecuencial}`);
                                
                                // Después de recargar, actualizar los campos inferiores con la nueva secuencia
                                llenarCamposInferiores(codigoActual);
                            } else {
                                console.log('🔄 Recargando lote por defecto después de guardar...');
                                await cargarSiguienteSecuencial();
                            }
                        }, 500); // Esperar 500ms para asegurar que la BD se actualice
                        
                        // Limpiar formulario
                        limpiarFormulario();
                        // Recargar tabla automáticamente
                        consultarRegistros();
                    } else {
                        alert('Error al guardar: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (error.message.includes('No autenticado')) {
                        alert('Sesión expirada. Por favor, inicie sesión nuevamente.');
                        window.location.href = '/login';
                    } else {
                        alert('Error al guardar el registro: ' + error.message);
                    }
                })
                .finally(() => {
                    // Rehabilitar botón
                    btnGuardar.disabled = false;
                    btnGuardar.textContent = 'Guardar';
                });
                
            } catch (error) {
                console.error('Error al procesar formulario:', error);
                alert('Error al procesar el formulario');
            }
        }
        
        // Función para limpiar el formulario
        function limpiarFormulario() {
            document.getElementById('forma_material').selectedIndex = 0;
            document.getElementById('cliente').selectedIndex = 0;
            document.getElementById('codigoMaterialOriginal').value = '';
            document.getElementById('codigoMaterialSelect').innerHTML = '<option value="">Seleccionar</option>';
            document.getElementById('material_importacion_local').selectedIndex = 0;
            
            // Restablecer fechas a hoy
            setFechasHoy();
            
            document.getElementById('cantidad_actual').value = '';
            document.getElementById('numero_lote_material').value = '';
            document.getElementById('codigo_material_recibido').value = '';
            document.getElementById('numero_parte_lower').value = '';
            document.getElementById('cantidad_estandarizada').value = '';
            document.getElementById('codigo_material_lower').value = '';
            document.getElementById('propiedad_material').value = '';
            
            // *** OCULTAR LA TABLA AL LIMPIAR FORMULARIO ***
            const tabla = document.getElementById('tablaControlAlmacen');
            if (tabla) {
                tabla.style.display = 'none';
                console.log('✅ Tabla ocultada después de limpiar formulario');
            }
            
            // El contador secuencial se recarga desde BD después de cada guardado exitoso
            console.log('Formulario limpiado. Próximo número secuencial será:', String(contadorSecuencial).padStart(4, '0'));
        }
        
        // Establecer fechas a hoy al cargar la página
function setFechasHoy() {
    // Obtener la fecha local (no UTC) para evitar desfase de zona horaria
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hoyLocal = `${year}-${month}-${day}`;
    // También actualiza los filtros de fecha
    const fechaRecibo = document.getElementById('fecha_recibo');
    const fechaFabricacion = document.getElementById('fecha_fabricacion');
    const filtroFechaInicio = document.getElementById('filtro_fecha_inicio');
    const filtroFechaFin = document.getElementById('filtro_fecha_fin');
    if (fechaRecibo) fechaRecibo.value = hoyLocal;
    if (fechaFabricacion) fechaFabricacion.value = hoyLocal;
    if (filtroFechaInicio) filtroFechaInicio.value = hoyLocal;
    if (filtroFechaFin) filtroFechaFin.value = hoyLocal;
}
// Llamar al cargar la página
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setFechasHoy);
} else {
    setFechasHoy();
}

        // Función para consultar registros (actualizada para usar la nueva función)
        function consultarRegistros() {
            console.log('🔄 === CONSULTANDO REGISTROS (ACTUALIZADA) ===');
            console.log('🔄 Llamando a cargarDatosDesdeServidor...');
            cargarDatosDesdeServidor();
        }

        // Función principal de carga de datos (actualizada para usar la nueva función)
        function cargarDatosDesdeServidor() {
            console.log('🚀 === INICIANDO cargarDatosDesdeServidor (ACTUALIZADA) ===');
            
            const fechaInicio = document.getElementById('filtro_fecha_inicio').value;
            const fechaFin = document.getElementById('filtro_fecha_fin').value;
            
            console.log('📅 Filtros:', { fechaInicio, fechaFin });
            
            // Construir URL con parámetros
            let url = '/consultar_control_almacen';
            const params = new URLSearchParams();
            
            if (fechaInicio) params.append('fecha_inicio', fechaInicio);
            if (fechaFin) params.append('fecha_fin', fechaFin);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            console.log('📡 URL final:', url);
            
            fetch(url)
                .then(response => {
                    console.log('📨 Respuesta recibida - Status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('📊 Datos parseados:', data);
                    console.log('📊 Cantidad de registros:', data ? data.length : 0);
                    
                    console.log('🔄 Llamando a nuevaCargarDatos (función funcional)...');
                    nuevaCargarDatos(data);
                    console.log('✅ nuevaCargarDatos ejecutada');
                })
                .catch(error => {
                    console.error('❌ Error completo:', error);
                    
                    const tbody = document.querySelector('#tablaControlAlmacen tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px; color: #e74c3c;">Error al cargar los datos. Por favor, intente nuevamente.</td></tr>';
                    }
                });
            
            console.log('🚀 === FIN cargarDatosDesdeServidor (fetch iniciado) ===');
        }
        
        // Función global para acceso directo (como en CONTROL_DE_MATERIAL.html)
        window.cargarDatosDesdeServidor = cargarDatosDesdeServidor;
        
        // NUEVA FUNCIÓN FUNCIONAL PARA REEMPLAZAR cargarDatosEnTabla
        function nuevaCargarDatos(datos) {
            const tabla = document.getElementById('tablaControlAlmacen');
            const tbody = document.querySelector('#tablaControlAlmacen tbody');
            
            // *** MOSTRAR LA TABLA CUANDO SE CARGAN DATOS ***
            if (tabla) {
                tabla.style.display = 'table';
            }
            
            tbody.innerHTML = '';

            if (!datos || datos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="material-table .no-data">No hay registros disponibles.</td></tr>';
                return;
            }

            datos.forEach(item => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${item.codigo_material_recibido || ''}</td>
                    <td>${item.codigo_material || ''}</td>
                    <td>${item.numero_parte || ''}</td>
                    <td>${item.numero_lote_material || ''}</td>
                    <td>${item.propiedad_material || ''}</td>
                    <td>${item.cantidad_actual || ''}</td>
                    <td>${item.cantidad_estandarizada || ''}</td>
                    <td>${item.ubicacion_salida || ''}</td>
                    <td>${item.fecha_recibo || ''}</td>
                    <td>${item.especificacion || ''}</td>
                    <td>${item.material_importacion_local || ''}</td>
                    <td>${item.estado_desecho || ''}</td>
                `;
                tbody.appendChild(row);
            });
            
            // IMPORTANTE: Llama a actualizarTotalFilasTabla() después de actualizar los datos de la tabla
            actualizarTotalFilasTabla();
        }
        
        // Actualiza el total de filas en la tabla de resultados
        function actualizarTotalFilasTabla() {
            const tabla = document.getElementById('tablaControlAlmacen');
            const totalInfo = document.querySelector('.total-info');
            if (!tabla || !totalInfo) return;
            const tbody = tabla.querySelector('tbody');
            if (!tbody) return;
            // Contar filas que no tengan la clase 'no-data'
            const filas = Array.from(tbody.querySelectorAll('tr'));
            const filasDatos = filas.filter(tr => !tr.classList.contains('no-data'));
            totalInfo.textContent = `Total Rows: ${filasDatos.length}`;
        }
        
        // Función de test para la nueva función
        window.testNuevaFuncionFinal = function() {
            console.log('🧪 PROBANDO NUEVA FUNCIÓN FINAL');
            fetch('/consultar_control_almacen')
                .then(response => response.json())
                .then(data => {
                    console.log('📡 Datos recibidos:', data.length);
                    nuevaCargarDatos(data);
                })
                .catch(error => {
                    console.error('❌ Error:', error);
                });
        };
        
        // Función de test para verificar la funcionalidad
        window.testControlAlmacenModule = function() {
            console.log('🧪 === EJECUTANDO TEST DEL MÓDULO ===');
            
            const elementos = {
                'tablaControlAlmacen': document.getElementById('tablaControlAlmacen'),
                'btnConsultar': document.getElementById('btnConsultar'),
                'filtro_fecha_inicio': document.getElementById('filtro_fecha_inicio'),
                'filtro_fecha_fin': document.getElementById('filtro_fecha_fin'),
                'tbody': document.querySelector('#tablaControlAlmacen tbody')
            };
            
            let errores = [];
            
            Object.keys(elementos).forEach(key => {
                if (elementos[key]) {
                    console.log(`✅ ${key}: OK`);
                } else {
                    console.error(`❌ ${key}: FALTA`);
                    errores.push(key);
                }
            });
            
            // Test de funciones simplificadas
            const funciones = [
                'consultarRegistros',
                'cargarDatosDesdeServidor',
                'cargarDatosEnTabla',
                'cargarCodigosMaterial'
            ];
            
        funciones.forEach(func => {
            if (typeof window[func] === 'function' || typeof eval(func) === 'function') {
                console.log(`✅ Función ${func}: OK`);
            } else {
                console.error(`❌ Función ${func}: FALTA`);
                errores.push(`Función ${func}`);
            }
        });

        if (errores.length === 0) {
            console.log('🎉 ¡TODOS LOS TESTS PASARON!');
            console.log('✅ Módulo Control de Almacén: Todos los componentes están funcionando correctamente');
            
            // Test adicional: Intentar cargar datos
            console.log('🔄 Ejecutando test de carga de datos...');
            cargarDatosDesdeServidor();
            
        } else {
            console.error('❌ ERRORES ENCONTRADOS:', errores);
            console.warn('❌ Errores en el módulo: ' + errores.join(', '));
        }
        
        return errores.length === 0;
    };

        // Funciones de test simples para diagnóstico rápido
        window.testCargarDatos = function() {
            console.log('🧪 TEST: Probando carga de datos...');
            cargarDatosDesdeServidor();
        };
        
        window.testConectividad = function() {
            console.log('🔗 TEST: Conectividad básica...');
            testConectividadAlmacen();
        };

        // Función de test específica para diagnosticar el problema de la tabla
        window.testTablaEspecifico = function() {
            console.log('🔬 === TEST ESPECÍFICO DE TABLA ===');
            
            // 1. Verificar elementos DOM
            const tabla = document.getElementById('tablaControlAlmacen');
            const tbody = document.querySelector('#tablaControlAlmacen tbody');
            const btnConsultar = document.getElementById('btnConsultar');
            
            console.log('🔍 Verificación DOM:');
            console.log('- Tabla:', tabla);
            console.log('- Tbody:', tbody);
            console.log('- Botón consultar:', btnConsultar);
            
            // 2. Test directo con datos simulados
            console.log('🧪 Probando con datos simulados...');
            const datosSimulados = [
                {
                    id: 1,
                    codigo_material_recibido: 'TEST001/20250708001',
                    codigo_material: 'TEST001',
                    numero_parte: '0001',
                    numero_lote_material: 'LOTE001',
                    propiedad_material: 'Prueba',
                    cantidad_actual: '1000',
                    cantidad_estandarizada: '1000',
                    ubicacion_salida: 'A1',
                    fecha_recibo: '2025-07-08',
                    material_importacion_local: 'Local',
                    estado_desecho: 0
                }
            ];
            
            console.log('📋 Datos simulados:', datosSimulados);
            cargarDatosEnTabla(datosSimulados);
            
            // 3. Test con datos reales del servidor
            console.log('🌐 Probando con datos reales del servidor...');
            setTimeout(() => {
                cargarDatosDesdeServidor();
            }, 2000);
        };
        
        // Función para limpiar tabla y probar desde cero
        window.limpiarYProbar = function() {
            console.log('🧹 Limpiando tabla y probando...');
            const tbody = document.querySelector('#tablaControlAlmacen tbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px;">Tabla limpiada - ejecutando test...</td></tr>';
                setTimeout(() => {
                    testTablaEspecifico();
                }, 1000);
            }
        };

        // Función de test para la nueva versión ultra simple
        window.testNuevaFuncion = function() {
            console.log('🚀 === PROBANDO NUEVA FUNCIÓN ===');
            
            const datosTest = [
                {
                    id: 1,
                    codigo_material_recibido: 'TEST001/20250708001',
                    codigo_material: 'TEST001',
                    numero_parte: '0001',
                    numero_lote_material: 'LOTE001',
                    propiedad_material: 'Material de Prueba',
                    cantidad_actual: '1000',
                    cantidad_estandarizada: '1000',
                    ubicacion_salida: 'A1-01',
                    fecha_recibo: '2025-07-08',
                    material_importacion_local: 'Local',
                    estado_desecho: 0
                },
                {
                    id: 2,
                    codigo_material_recibido: 'TEST002/20250708002',
                    codigo_material: 'TEST002',
                    numero_parte: '0002',
                    numero_lote_material: 'LOTE002',
                    propiedad_material: 'Material de Prueba 2',
                    cantidad_actual: '2000',
                    cantidad_estandarizada: '2000',
                    ubicacion_salida: 'B1-01',
                    fecha_recibo: '2025-07-08',
                    material_importacion_local: 'Importación',
                    estado_desecho: 1
                }
            ];
            
            console.log('📋 Datos de test:', datosTest);
            console.log('🔄 Llamando a cargarDatosEnTabla...');
            cargarDatosEnTabla(datosTest);
        };
        
        // Función para probar con datos reales del servidor
        window.testConDatosReales = function() {
            console.log('🌐 === PROBANDO CON DATOS REALES ===');
            
            fetch('/consultar_control_almacen')
                .then(response => {
                    console.log('📡 Respuesta:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('📊 Datos del servidor:', data);
                    console.log('📊 Cantidad:', data.length);
                    console.log('📊 Primer elemento:', data[0]);
                    
                    console.log('🔄 Llamando a la nueva función...');
                    cargarDatosEnTabla(data);
                })
                .catch(error => {
                    console.error('❌ Error:', error);
                });
        };

        // FUNCIÓN DE PRUEBA ULTRA BÁSICA - SOLO PARA VERIFICAR QUE FUNCIONA
        function mostrarDatosBasico(datos) {
            console.log('🟢🟢🟢 FUNCIÓN BÁSICA INICIADA');
            console.log('🟢 Datos recibidos:', datos);
            
            const tbody = document.querySelector('#tablaControlAlmacen tbody');
            console.log('🟢 Tbody encontrado:', tbody);
            
            if (!tbody) {
                console.error('❌ NO SE ENCONTRÓ TBODY');
                return;
            }
            
            // PASO 1: Mostrar mensaje de prueba visible
            tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 30px; background-color: lime; color: black; font-size: 16px; font-weight: bold;">✅ FUNCIÓN EJECUTADA - DATOS: ' + (datos ? datos.length : 0) + '</td></tr>';
            console.log('🟢 MENSAJE VERDE INSERTADO');
            
            // PASO 2: Actualizar el contador
            const totalInfo = document.querySelector('.total-info');
            if (totalInfo) {
                totalInfo.textContent = 'FUNCIÓN EJECUTADA ✅ - Total: ' + (datos ? datos.length : 0);
                totalInfo.style.color = 'lime';
                totalInfo.style.fontSize = '16px';
                totalInfo.style.fontWeight = 'bold';
            }
            
            console.log('🟢🟢🟢 FUNCIÓN BÁSICA TERMINADA');
            console.log('✅ Función básica ejecutada - Datos: ' + (datos ? datos.length : 0));
        }
        
        // FUNCIÓN DE PRUEBA INMEDIATA
        window.probarFuncionBasica = function() {
            console.log('🚀 INICIANDO PRUEBA BÁSICA');
            
            const datosTest = [
                { id: 1, codigo_material: 'TEST1', cantidad_actual: '100' },
                { id: 2, codigo_material: 'TEST2', cantidad_actual: '200' }
            ];
            
            mostrarDatosBasico(datosTest);
        };
        
        // FUNCIÓN PARA PROBAR CON DATOS REALES
        window.probarConDatosReales = function() {
            console.log('🌐 PROBANDO CON DATOS REALES');
            
            fetch('/consultar_control_almacen')
                .then(response => response.json())
                .then(data => {
                    console.log('📊 Datos del servidor:', data);
                    mostrarDatosBasico(data);
                })
                .catch(error => {
                    console.error('❌ Error:', error);
                    console.warn('❌ Error: ' + error.message);
                });
        };

        // Función de test para verificar que el botón consultar funcione
        window.testBotonConsultar = function() {
            console.log('🧪 === PROBANDO BOTÓN CONSULTAR ===');
            
            // Verificar que la función consultarRegistros esté disponible
            if (typeof consultarRegistros === 'function') {
                console.log('✅ consultarRegistros disponible');
            } else {
                console.error('❌ consultarRegistros NO disponible');
                return;
            }
            
            // Verificar que la función cargarDatosDesdeServidor esté disponible
            if (typeof cargarDatosDesdeServidor === 'function') {
                console.log('✅ cargarDatosDesdeServidor disponible');
            } else {
                console.error('❌ cargarDatosDesdeServidor NO disponible');
                return;
            }
            
            // Verificar que la función nuevaCargarDatos esté disponible
            if (typeof nuevaCargarDatos === 'function') {
                console.log('✅ nuevaCargarDatos disponible');
            } else {
                console.error('❌ nuevaCargarDatos NO disponible');
                return;
            }
            
            // Verificar que el botón exista
            const btnConsultar = document.getElementById('btnConsultar');
            if (btnConsultar) {
                console.log('✅ Botón consultar encontrado');
                console.log('✅ Onclick:', btnConsultar.onclick);
                console.log('✅ Atributo onclick:', btnConsultar.getAttribute('onclick'));
            } else {
                console.error('❌ Botón consultar NO encontrado');
                return;
            }
            
            console.log('🚀 Ejecutando consultarRegistros() directamente...');
            consultarRegistros();
        };
        
        // Función para verificar el flujo completo
        window.verificarFlujoCompleto = function() {
            console.log('🔍 === VERIFICANDO FLUJO COMPLETO ===');
            console.log('1. consultarRegistros -> cargarDatosDesdeServidor -> nuevaCargarDatos');
            
            console.log('🔗 Paso 1: consultarRegistros');
            console.log('🔗 Paso 2: cargarDatosDesdeServidor');
            console.log('🔗 Paso 3: nuevaCargarDatos');
            
            testBotonConsultar();
        };

        // Función para aplicar reglas de escaneo desde rules.json
        async function aplicarReglasEscaneo(texto) {
            try {
                console.log('=== APLICANDO REGLAS DE ESCANEO ===');
                console.log('Texto escaneado:', texto);
                console.log('Longitud del texto:', texto.length);
                
                // Obtener las reglas del servidor
                const response = await fetch('/obtener_reglas_escaneo');
                if (!response.ok) {
                    console.warn('No se pudieron obtener las reglas de escaneo');
                    return null;
                }
                
                const reglas = await response.json();
                console.log('Reglas de escaneo cargadas:', reglas);
                
                // Probar cada regla hasta encontrar una que coincida
                for (const [proveedor, regla] of Object.entries(reglas)) {
                    console.log(`\n--- Probando regla para proveedor: ${proveedor} ---`);
                    console.log('Tipo de regla:', regla.creation_mode || 'no especificado');
                    
                    const resultado = aplicarRegla(texto, regla);
                    if (resultado) {
                        console.log(`✅ REGLA ${proveedor} APLICADA EXITOSAMENTE:`);
                        console.log('- Proveedor:', proveedor);
                        console.log('- Part Number:', resultado.partNumber);
                        console.log('- Lot Number:', resultado.lotNumber);
                        console.log('- Part Number length:', resultado.partNumber.length);
                        console.log('- Lot Number length:', resultado.lotNumber.length);
                        
                        return {
                            supplier: proveedor,
                            partNumber: resultado.partNumber,
                            lotNumber: resultado.lotNumber
                        };
                    } else {
                        console.log(`❌ Regla ${proveedor} no coincide`);
                    }
                }
                
                console.log('❌ Ninguna regla coincide con el texto escaneado');
                return null;
                
            } catch (error) {
                console.error('Error al aplicar reglas de escaneo:', error);
                return null;
            }
        }
        
        // Función para aplicar una regla específica
        function aplicarRegla(texto, regla) {
            try {
                console.log('Aplicando regla:', regla);
                
                // Manejar diferentes tipos de reglas según tu rules.json
                if ('sequence_pattern' in regla) {
                    return aplicarReglaSecuencias(texto, regla);
                } else if ('character_pattern' in regla) {
                    return aplicarReglaCaracteres(texto, regla);
                } else if ('pattern' in regla) {
                    return aplicarReglaRegex(texto, regla);
                } else {
                    console.warn('Tipo de regla no soportado:', regla);
                    return null;
                }
            } catch (error) {
                console.error('Error aplicando regla:', error);
                return null;
            }
        }
        
        // Función para aplicar regla de secuencias (como ROHM)
        function aplicarReglaSecuencias(texto, regla) {
            try {
                console.log('Aplicando regla de secuencias para:', texto);
                console.log('Regla:', regla);
                
                const secuencias = regla.sequence_pattern;
                const indicePart = regla.partNumberIndex;
                const indiceLote = regla.lotNumberIndex;
                const maxLongitudPart = regla.partNumberMaxLength;
                const maxLongitudLote = regla.lotNumberMaxLength;
                
                // Dividir el texto según las secuencias
                let partes = [texto];
                
                for (const secuencia of secuencias) {
                    let nuevasPartes = [];
                    
                    for (const parte of partes) {
                        if (secuencia.type === 'spaces') {
                            // Dividir por la cantidad exacta de espacios consecutivos
                            const espacios = ' '.repeat(secuencia.count);
                            const subpartes = parte.split(espacios); // Dividir por todos los separadores
                            nuevasPartes.push(...subpartes);
                        } else if (secuencia.type === 'tabs') {
                            const tabs = '\t'.repeat(secuencia.count);
                            const subpartes = parte.split(tabs);
                            nuevasPartes.push(...subpartes);
                        } else if (secuencia.type === 'newlines') {
                            const newlines = '\n'.repeat(secuencia.count);
                            const subpartes = parte.split(newlines);
                            nuevasPartes.push(...subpartes);
                        } else if (secuencia.type === 'custom') {
                            const custom = (secuencia.separator || '').repeat(secuencia.count);
                            const subpartes = parte.split(custom);
                            nuevasPartes.push(...subpartes);
                        } else {
                            nuevasPartes.push(parte);
                        }
                    }
                    
                    partes = nuevasPartes;
                }
                
                console.log('Partes divididas:', partes);
                
                // Verificar que tengamos suficientes partes
                if (partes.length <= Math.max(indicePart, indiceLote)) {
                    console.log('No suficientes partes para extraer datos');
                    return null;
                }
                
                let partNumber = (partes[indicePart] || '').trim();
                let lotNumber = (partes[indiceLote] || '').trim();
                
                // Aplicar longitudes máximas si están definidas (como en Python)
                if (maxLongitudPart && partNumber.length > maxLongitudPart) {
                    partNumber = partNumber.substring(0, maxLongitudPart);
                }
                if (maxLongitudLote && lotNumber.length > maxLongitudLote) {
                    lotNumber = lotNumber.substring(0, maxLongitudLote);
                }
                
                // *** NUEVA FUNCIONALIDAD: Extracción específica del lote ***
                if (regla.lotNumberStart !== undefined && regla.lotNumberLength !== undefined) {
                    const startPos = regla.lotNumberStart;
                    const length = regla.lotNumberLength;
                    
                    console.log('🎯 Aplicando extracción específica del lote:');
                    console.log('- Lote original:', lotNumber);
                    console.log('- Posición inicio:', startPos);
                    console.log('- Longitud:', length);
                    console.log('- Lote original length:', lotNumber.length);
                    
                    if (lotNumber.length >= startPos + length) {
                        lotNumber = lotNumber.substring(startPos, startPos + length).trim();
                        console.log('- Lote extraído:', lotNumber);
                    } else {
                        console.log('❌ Lote muy corto para extracción específica');
                    }
                }
                
                console.log('Datos extraídos por secuencias:');
                console.log('- Part Number:', partNumber);
                console.log('- Lot Number:', lotNumber);
                console.log('- Part Number length:', partNumber.length);
                console.log('- Lot Number length:', lotNumber.length);
                
                return {
                    partNumber: partNumber,
                    lotNumber: lotNumber
                };
                
            } catch (error) {
                console.error('Error en aplicarReglaSecuencias:', error);
                return null;
            }
        }
        
        // Función para aplicar regla de regex (como LEGACY)
        function aplicarReglaRegex(texto, regla) {
            try {
                console.log('Aplicando regla regex para:', texto);
                
                const patron = new RegExp(regla.pattern);
                const indicePart = regla.partNumberIndex;
                const indiceLote = regla.lotNumberIndex;
                
                const coincidencia = texto.match(patron);
                
                if (!coincidencia) {
                    console.log('El texto no coincide con el patrón regex');
                    return null;
                }
                
                console.log('Coincidencias regex:', coincidencia);
                
                const partNumber = coincidencia[indicePart]?.trim() || '';
                const lotNumber = coincidencia[indiceLote]?.trim() || '';
                
                console.log('Datos extraídos por regex:');
                console.log('- Part Number:', partNumber);
                console.log('- Lot Number:', lotNumber);
                
                return {
                    partNumber: partNumber,
                    lotNumber: lotNumber
                };
                
            } catch (error) {
                console.error('Error en aplicarReglaRegex:', error);
                return null;
            }
        }
        
        // Función para aplicar regla de patrón de caracteres
        function aplicarReglaCaracteres(texto, regla) {
            try {
                const patronCaracteres = regla.character_pattern;
                const inicioPartNumber = regla.partNumberStart;
                const longitudPartNumber = regla.partNumberLength;
                const inicioLotNumber = regla.lotNumberStart;
                const longitudLotNumber = regla.lotNumberLength;
                
                console.log('Aplicando regla de caracteres:');
                console.log('- Patrón:', patronCaracteres);
                console.log('- Texto:', texto);
                console.log('- Texto length:', texto.length);
                console.log('- Patrón length:', patronCaracteres.length);
                console.log('- Part Number: posición', inicioPartNumber, 'longitud', longitudPartNumber);
                console.log('- Lot Number: posición', inicioLotNumber, 'longitud', longitudLotNumber);
                
                // Verificar longitud mínima (igual que Python)
                const longitudMinima = Math.max(inicioPartNumber + longitudPartNumber, inicioLotNumber + longitudLotNumber);
                if (texto.length < longitudMinima) {
                    console.log(`❌ Texto muy corto. Esperado: ${longitudMinima}, Actual: ${texto.length}`);
                    return null;
                }
                
                // VALIDACIÓN ESTRICTA DE PATRÓN (igual que Python)
                if (texto.length !== patronCaracteres.length) {
                    console.log(`❌ Longitud no coincide. Patrón: ${patronCaracteres.length}, Texto: ${texto.length}`);
                    return null;
                }
                
                // Verificar patrón carácter por carácter (igual que Python)
                for (let i = 0; i < texto.length; i++) {
                    const charTexto = texto[i];
                    const charPatron = patronCaracteres[i];
                    
                    if (charPatron === 'X') {
                        // X = cualquier carácter
                        continue;
                    } else if (charPatron === 'N') {
                        // N = cualquier número
                        if (!/\d/.test(charTexto)) {
                            console.log(`❌ Carácter en posición ${i} no es número. Esperado: N, Actual: "${charTexto}"`);
                            return null;
                        }
                    } else if (charPatron === 'A') {
                        // A = cualquier letra
                        if (!/[a-zA-Z]/.test(charTexto)) {
                            console.log(`❌ Carácter en posición ${i} no es letra. Esperado: A, Actual: "${charTexto}"`);
                            return null;
                        }
                   
                    } else if (charPatron === 'AN') {
                        // AN = alfanumérico
                        if (!/[a-zA-Z0-9]/.test(charTexto)) {
                            console.log(`❌ Carácter en posición ${i} no es alfanumérico. Esperado: AN, Actual: "${charTexto}"`);
                            return null;
                        }
                    } else {
                        // Carácter específico debe coincidir exactamente
                        if (charTexto !== charPatron) {
                            console.log(`❌ Carácter en posición ${i} no coincide. Esperado: "${charPatron}", Actual: "${charTexto}"`);
                            return null;
                        }
                    }
                }
                
                console.log('✅ Patrón validado correctamente');
                
                // Extraer partNumber y lotNumber según las posiciones EXACTAS (igual que Python)
                const partNumber = texto.substring(inicioPartNumber, inicioPartNumber + longitudPartNumber).trim();
                const lotNumber = texto.substring(inicioLotNumber, inicioLotNumber + longitudLotNumber).trim();
                
                console.log('Extracción exacta:');
                console.log(`- Part Number extraído: "${partNumber}" (de posición ${inicioPartNumber} a ${inicioPartNumber + longitudPartNumber})`);
                console.log(`- Lot Number extraído: "${lotNumber}" (de posición ${inicioLotNumber} a ${inicioLotNumber + longitudLotNumber})`);
                console.log('- Part Number length extraído:', partNumber.length);
                console.log('- Lot Number length extraído:', lotNumber.length);
                
                console.log('✅ Datos finales extraídos:');
                console.log('- Part Number final:', partNumber);
                console.log('- Lot Number final:', lotNumber);
                
                return {
                    partNumber: partNumber,
                    lotNumber: lotNumber
                };
                
            } catch (error) {
                console.error('Error en aplicarReglaCaracteres:', error);
                return null;
            }
        }

        function exportarExcel() {
            try {
                alert('Generando archivo Excel, por favor espere...');
                fetch('/exportar_excel', {
                    method: 'GET'
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Error en el servidor');
                    }
                    return response.blob();
                })
                .then(function(blob) {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `materiales_export_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    alert('Archivo Excel descargado exitosamente');
                })
                .catch(function(error) {
                    console.error('Error al exportar Excel:', error);
                    alert('Error al exportar el archivo Excel: ' + error.message);
                });
            } catch (error) {
                console.error('Error al exportar Excel:', error);
                alert('Error al exportar el archivo Excel');
            }
        }

        // === AUTOCOMPLETADO PARA CONTROL DE ALMACÉN ===
        // Configurar autocompletado en el campo "codigo_material_recibido"
        function configurarAutocompletadoAlmacen() {
            const codigoRecibidoInput = document.getElementById('codigo_material_recibido');
            if (codigoRecibidoInput) {
                console.log('✅ ALMACÉN: Campo codigo_material_recibido encontrado y configurado');
                
                // Función para buscar el código en la base de datos
                async function buscarCodigoRecibidoAlmacen() {
                    const codigo = codigoRecibidoInput.value.trim();
                    console.log(`🔍 ALMACÉN: Buscando código: "${codigo}"`);
                    
                    if (!codigo) {
                        console.log('⚠️ ALMACÉN: Código vacío, no se ejecuta búsqueda');
                        return;
                    }
                    
                    console.log('📡 ALMACÉN: Enviando petición al servidor...');
                    
                    try {
                        const url = `/buscar_codigo_recibido?codigo_material_recibido=${encodeURIComponent(codigo)}`;
                        console.log(`🌐 ALMACÉN: URL: ${url}`);
                        
                        const response = await fetch(url);
                        console.log(`📡 ALMACÉN: Respuesta del servidor: Status ${response.status}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('📦 ALMACÉN: Datos recibidos:', data);
                            
                            if (data.success && data.registro) {
                                console.log('✅ ALMACÉN: Código encontrado, llenando campos...');
                                
                                // Llenar campos con la información encontrada
                                if (data.registro.numero_lote_material) {
                                    document.getElementById('numero_lote_material').value = data.registro.numero_lote_material;
                                }
                                if (data.registro.codigo_material_original) {
                                    document.getElementById('codigoMaterialOriginal').value = data.registro.codigo_material_original;
                                }
                                if (data.registro.codigo_material) {
                                    document.getElementById('codigo_material_lower').value = data.registro.codigo_material;
                                }
                                if (data.registro.numero_parte) {
                                    document.getElementById('numero_parte_lower').value = data.registro.numero_parte;
                                }
                                if (data.registro.cantidad_actual) {
                                    document.getElementById('cantidad_actual').value = data.registro.cantidad_actual;
                                }
                                if (data.registro.cantidad_estandarizada) {
                                    document.getElementById('cantidad_estandarizada').value = data.registro.cantidad_estandarizada;
                                }
                                if (data.registro.propiedad_material) {
                                    document.getElementById('propiedad_material').value = data.registro.propiedad_material;
                                }
                                
                                // Resaltar campos que se llenaron automáticamente
                                const campos = ['numero_lote_material', 'codigoMaterialOriginal', 'codigo_material_lower', 
                                              'numero_parte_lower', 'cantidad_actual', 'cantidad_estandarizada', 'propiedad_material'];
                                campos.forEach(id => {
                                    const campo = document.getElementById(id);
                                    if (campo && campo.value) {
                                        campo.style.backgroundColor = '#d4edda';
                                        campo.style.borderColor = '#c3e6cb';
                                        setTimeout(() => {
                                            campo.style.backgroundColor = '';
                                            campo.style.borderColor = '';
                                        }, 3000);
                                    }
                                });
                                
                                console.log('✅ ALMACÉN: Autocompletado exitoso');
                                alert('Código encontrado y campos completados automáticamente');
                            } else {
                                console.log('❌ ALMACÉN: Código no encontrado en respuesta');
                                alert('Código de material recibido no encontrado en el almacén');
                            }
                        } else {
                            console.error(`❌ ALMACÉN: Error del servidor: ${response.status}`);
                            const errorText = await response.text();
                            console.error('Error text:', errorText);
                            alert(`Error del servidor: ${response.status}`);
                        }
                    } catch (error) {
                        console.error('💥 ALMACÉN: Error al buscar código recibido:', error);
                        alert('Error al buscar el código en la base de datos');
                    }
                }
                
                // Evento para cuando se pierde el foco del campo (change)
                codigoRecibidoInput.addEventListener('change', function() {
                    console.log('🎯 ALMACÉN: Evento "change" activado');
                    buscarCodigoRecibidoAlmacen();
                });
                
                // Evento para cuando se presiona Enter
                codigoRecibidoInput.addEventListener('keypress', function(event) {
                    console.log(`⌨️ ALMACÉN: Tecla presionada: ${event.key}`);
                    if (event.key === 'Enter') {
                        console.log('🎯 ALMACÉN: Enter presionado, ejecutando búsqueda');
                        event.preventDefault();
                        buscarCodigoRecibidoAlmacen();
                    }
                });
                
            } else {
                console.error('❌ ALMACÉN: Campo codigo_material_recibido NO encontrado en el DOM');
            }
        }

        // Inicializar autocompletado cuando se carga la página
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', configurarAutocompletadoAlmacen);
        } else {
            configurarAutocompletadoAlmacen();
        }

        // FUNCIÓN DE DIAGNÓSTICO PARA CONSECUTIVOS
        window.diagnosticarConsecutivos = async function(codigoMaterial = '0RH5602C622') {
            console.log('🩺 === DIAGNÓSTICO DE CONSECUTIVOS ===');
            console.log(`📋 Código de material a usar: ${codigoMaterial}`);
            
            try {
                // 1. Probar endpoint directamente
                const url = `/obtener_siguiente_secuencial?codigo_material=${encodeURIComponent(codigoMaterial)}`;
                console.log(`🌐 URL a llamar: ${url}`);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('📊 Respuesta del servidor:');
                console.log('   ✅ success:', data.success);
                console.log('   🔢 siguiente_secuencial:', data.siguiente_secuencial);
                console.log('   📅 fecha_actual:', data.fecha_actual);
                console.log('   📦 codigo_material:', data.codigo_material);
                console.log('   📈 secuencial_mas_alto_encontrado:', data.secuencial_mas_alto_encontrado);
                console.log('   🔍 patron_busqueda:', data.patron_busqueda);
                console.log('   📝 proximo_codigo_completo:', data.proximo_codigo_completo);
                
                // 2. Verificar variables globales
                console.log('🔧 Variables globales actuales:');
                console.log('   contadorSecuencial:', contadorSecuencial);
                console.log('   proximoCodigoCompleto:', proximoCodigoCompleto);
                
                // 3. Probar cargar función
                console.log('🔄 Probando cargarSiguienteSecuencial...');
                await cargarSiguienteSecuencial(codigoMaterial);
                
                console.log('🔧 Variables después de cargar:');
                console.log('   contadorSecuencial:', contadorSecuencial);
                console.log('   proximoCodigoCompleto:', proximoCodigoCompleto);
                
                // 4. Probar generar código fallback
                const fechaHoy = new Date().toISOString().slice(0,10).replace(/-/g,'')
                const codigoFallback = `${codigoMaterial},${fechaHoy}${String(contadorSecuencial).padStart(4, '0')}`;
                console.log(`📝 Código fallback generado: ${codigoFallback}`);
                
                return data;
                
            } catch (error) {
                console.error('❌ Error en diagnóstico:', error);
                return null;
            }
            
            console.log('🩺 === FIN DIAGNÓSTICO ===');
        };

        // FUNCIÓN PARA VERIFICAR REGISTROS EN LA BASE DE DATOS
        window.verificarRegistrosConsecutivos = async function() {
            console.log('📋 === VERIFICANDO REGISTROS EN BD ===');
            
            try {
                // Consultar registros recientes
                const response = await fetch('/consultar_control_almacen?fecha_desde=2025-07-11&fecha_hasta=2025-07-11');
                const data = await response.json();
                
                console.log(`📊 Registros encontrados: ${data.length}`);
                
                data.forEach((registro, index) => {
                    console.log(`📝 Registro ${index + 1}:`);
                    console.log(`   🆔 ID: ${registro.id}`);
                    console.log(`   📦 codigo_material_recibido: "${registro.codigo_material_recibido}"`);
                    console.log(`   📅 fecha_registro: ${registro.fecha_registro}`);
                    console.log(`   🏷️ codigo_material: ${registro.codigo_material}`);
                });
                
                return data;
                
            } catch (error) {
                console.error('❌ Error al verificar registros:', error);
                return null;
            }
            
            console.log('📋 === FIN VERIFICACIÓN ===');
        };

        // ==================== QR SCANNER FUNCTIONALITY ====================
        let html5QrCode = null;

        // Función para abrir el escáner QR
        function abrirEscanerQR() {
            // Si ya existe un modal, lo eliminamos para recrearlo
            const existingModal = document.getElementById('modalQRScanner');
            if (existingModal) {
                existingModal.remove();
            }

            // Crear el contenido del modal
            const modalHTML = `
                <div id="modalQRScanner" style="display: flex; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;">
                    <div style="position: relative; padding: 20px; width: 90%; max-width: 500px; background-color: #fff; border-radius: 8px; text-align: center;">
                        <button onclick="cerrarEscanerQR()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        <h3 style="margin-bottom: 20px;">Escanear Código QR</h3>
                        <p style="margin-bottom: 20px;">Tome una foto del código QR para escanearlo.</p>
                        
                        <!-- Botón estilizado que activa el input de archivo -->
                        <button onclick="document.getElementById('qr-input-file').click()" style="padding: 12px 24px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            📸 Tomar Foto
                        </button>
                        
                        <!-- Input de archivo oculto -->
                        <input type="file" id="qr-input-file" accept="image/*" capture="environment" style="display: none;">
                        
                        <div id="qr-status" style="margin-top: 20px; font-weight: bold;"></div>
                        <img id="qr-image-preview" style="max-width: 100%; max-height: 200px; margin-top: 15px; display: none;" />
                    </div>
                </div>
            `;

            // Añadir el modal al body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Configurar el listener para el input de archivo
            const qrInput = document.getElementById('qr-input-file');
            qrInput.addEventListener('change', handleFileSelect);

            // Pequeño delay para la animación de entrada
            setTimeout(() => {
                const modal = document.getElementById('modalQRScanner');
                if(modal) modal.style.opacity = '1';
            }, 10);
        }

        // Función para cerrar el escáner QR
        function cerrarEscanerQR() {
            const modal = document.getElementById('modalQRScanner');
            if (modal) {
                modal.remove();
            }
        }

        // Función para manejar la selección de archivo (foto tomada)
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const statusDiv = document.getElementById('qr-status');
            const imagePreview = document.getElementById('qr-image-preview');
            
            statusDiv.textContent = 'Procesando imagen...';
            statusDiv.style.color = '#007bff';
            imagePreview.style.display = 'block';
            imagePreview.src = URL.createObjectURL(file);

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-status", { verbose: false });
            }

            try {
                const decodedText = await html5QrCode.scanFile(file, false);
                onScanSuccess(decodedText);
            } catch (err) {
                console.error('Error al escanear la imagen:', err);
                statusDiv.textContent = '❌ No se pudo detectar un código QR. Intente de nuevo.';
                statusDiv.style.color = 'red';
                imagePreview.style.display = 'none';
            }
        }

        // Función llamada cuando se escanea exitosamente
        function onScanSuccess(decodedText) {
            console.log('✅ QR escaneado:', decodedText);
            
            const statusDiv = document.getElementById('qr-status');
            if (statusDiv) {
                statusDiv.textContent = '✅ ¡Código escaneado exitosamente!';
                statusDiv.style.color = 'green';
            }
            
            // Llenar el campo de texto con el código escaneado
            const inputCodigo = document.getElementById('codigoMaterialOriginal');
            if (inputCodigo) {
                inputCodigo.value = decodedText;
                
                // Resaltar el campo
                inputCodigo.style.backgroundColor = '#d4edda';
                inputCodigo.style.borderColor = '#28a745';
            }
            
            // Procesar el código automáticamente y cerrar el modal
            setTimeout(() => {
                parsearYDistribuirCodigo(decodedText);
                cerrarEscanerQR();
                
                // Restaurar estilos del campo después de un tiempo
                if (inputCodigo) {
                    setTimeout(() => {
                        inputCodigo.style.backgroundColor = '';
                        inputCodigo.style.borderColor = '';
                    }, 3000);
                }
            }, 1000);
        }

        // Cerrar modal al hacer clic fuera de él (si se necesita)
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modalQRScanner');
            if (modal && event.target === modal) {
                cerrarEscanerQR();
            }
        });
        // ==================== FIN QR SCANNER FUNCTIONALITY ====================

    </script>

    <!-- Script para QR automático después de guardar - NO MODIFICA FUNCIONES EXISTENTES -->
    <script>
        // Función simple para generar QR cuando se llame explícitamente
        window.generarQRMaterialRecibido = function() {
            // Obtener el código de material recibido
            const codigoMaterialRecibido = document.getElementById('codigo_material_recibido');
            
            if (codigoMaterialRecibido && codigoMaterialRecibido.value.trim() !== '') {
                console.log('🎯 Generando QR para código:', codigoMaterialRecibido.value.trim());
                
                // Usar el generador QR simple
                if (window.QRAlmacenSimple && typeof QRAlmacenSimple.generarQR === 'function') {
                    QRAlmacenSimple.generarQR(codigoMaterialRecibido.value.trim());
                } else {
                    console.warn('⚠️ Generador QR no disponible');
                }
            } else {
                console.warn('⚠️ No hay código de material recibido para generar QR');
            }
        };

        console.log('✅ Función QR manual disponible: generarQRMaterialRecibido()');
        
        // Función para mostrar estado de configuración de impresora al cargar
        function mostrarEstadoImpresora() {
            const config = localStorage.getItem('zebra_config');
            if (config) {
                const cfg = JSON.parse(config);
                const tipoTexto = cfg.tipo === 'simple' ? 'Simple' : 'Completa';
                const metodoTexto = cfg.metodo === 'usb' ? 'USB' : `Red ${cfg.ip}`;
                console.log(`🦓 ZT230 configurada: ${metodoTexto} (${tipoTexto}) - Impresión automática activada`);
                
                // Configuración activada - no hay botón que actualizar
            } else {
                console.log('⚠️ ZT230 no configurada - QR se mostrará en modal');
            }
        }
        
        // Ejecutar al cargar la página
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', mostrarEstadoImpresora);
        } else {
            mostrarEstadoImpresora();
        }

        // ============= FUNCIÓN DE IMPRESIÓN AUTOMÁTICA DIRECTA =============
        
        /**
         * Función para imprimir directamente en Zebra sin confirmaciones
         * Se ejecuta automáticamente después de guardar un material
         */
        async function imprimirZebraAutomatico(codigo) {
            console.log('🦓 === IMPRESIÓN AUTOMÁTICA ZEBRA (WIN32) ===');
            console.log('📋 Código a imprimir:', codigo);
            
            try {
                // 1. Verificar configuración de impresora
                const config = localStorage.getItem('zebra_config');
                // 🌐 CONFIGURACIÓN DE SERVIDORES
                // Cambiar estas URLs según donde esté hospedado el sistema
                let configuracion = {
                    ip: '192.168.1.100',
                    tipo: 'material',
                    metodo: 'usb',
                    // Servidor principal (aplicación web) - CAMBIAR SEGÚN NECESIDAD
                    server_url: 'http://localhost:5000',        // Para desarrollo local
                    // server_url: 'https://mi-dominio.com',    // Para dominio web
                    // server_url: 'http://192.168.0.211:5000', // Para servidor específico
                    
                    // Servicio de impresión (SIEMPRE local en cada PC)
                    service_url: 'http://localhost:5003'
                };
                
                // 🔧 FUNCIONES HELPER PARA URLs
                function getServerUrl(endpoint = '') {
                    // Si el endpoint ya es absoluto, devolverlo como está
                    if (endpoint.startsWith('http://') || endpoint.startsWith('https://')) {
                        return endpoint;
                    }
                    
                    // Si es una ruta relativa, usar la URL base configurada
                    const baseUrl = configuracion.server_url.replace(/\/$/, ''); // Quitar / final si existe
                    return baseUrl + endpoint;
                }
                
                function getPrintServiceUrl(endpoint = '') {
                    const baseUrl = configuracion.service_url.replace(/\/$/, '');
                    return baseUrl + endpoint;
                }
                
                if (config) {
                    configuracion = { ...configuracion, ...JSON.parse(config) };
                    console.log('🔧 Configuración cargada:', configuracion);
                } else {
                    console.log('⚠️ Sin configuración previa, usando valores por defecto');
                    // Guardar configuración por defecto
                    localStorage.setItem('zebra_config', JSON.stringify(configuracion));
                }
                
                // 2. Generar comando ZPL según el tipo configurado
                const comandoZPL = generarComandoZPLDirecto(codigo, configuracion.tipo);
                console.log('📝 Comando ZPL generado:', comandoZPL);
                
                // 3. Mostrar notificación de inicio
                mostrarNotificacionImpresion('🔄 Enviando a impresora Zebra ZT230...', 'info');
                
                // 4. Enviar al servicio de impresión Win32
                await enviarAServicioWin32(comandoZPL, codigo, configuracion);
                
            } catch (error) {
                console.error('❌ Error en impresión automática:', error);
                mostrarNotificacionImpresion('❌ Error al imprimir: ' + error.message, 'error');
                
                // Fallback: Usar método anterior
                console.log('🔄 Fallback: Usando método anterior...');
                try {
                    await enviarPorBackendAnterior(comandoZPL, codigo, configuracion);
                } catch (fallbackError) {
                    console.error('❌ Fallback también falló:', fallbackError);
                    // Último fallback: Mostrar QR en modal
                    if (window.QRAlmacenSimple && typeof QRAlmacenSimple.generarQR === 'function') {
                        QRAlmacenSimple.generarQR(codigo);
                    }
                }
            }
        }
        
        /**
         * NUEVA FUNCIÓN: Impresión automática con datos específicos
         * Esta función recibe directamente los datos en lugar de leerlos del formulario
         */
        async function imprimirZebraAutomaticoConDatos(datosEtiqueta) {
            console.log('🦓 === IMPRESIÓN AUTOMÁTICA CON DATOS ESPECÍFICOS ===');
            console.log('📋 Datos recibidos:', datosEtiqueta);
            
            try {
                // 1. Verificar configuración de impresora
                const config = localStorage.getItem('zebra_config');
                let configuracion = {
                    ip: '192.168.1.100',
                    tipo: 'material',
                    metodo: 'usb',
                    server_url: 'http://localhost:5000',
                    service_url: 'http://localhost:5003'
                };
                
                if (config) {
                    configuracion = { ...configuracion, ...JSON.parse(config) };
                    console.log('🔧 Configuración cargada:', configuracion);
                } else {
                    console.log('⚠️ Sin configuración previa, usando valores por defecto');
                    localStorage.setItem('zebra_config', JSON.stringify(configuracion));
                }
                
                // 2. Generar comando ZPL usando la función principal
                const comandoZPL = generarComandoZPLDirecto(datosEtiqueta.codigo, configuracion.tipo);
                console.log('📝 Comando ZPL generado:', comandoZPL);
                
                // 3. Mostrar notificación de inicio
                mostrarNotificacionImpresion('🔄 Enviando a impresora Zebra ZT230...', 'info');
                
                // 4. Enviar al servicio de impresión Win32
                await enviarAServicioWin32(comandoZPL, datosEtiqueta.codigo, configuracion);
                
            } catch (error) {
                console.error('❌ Error en impresión automática con datos:', error);
                mostrarNotificacionImpresion('❌ Error al imprimir: ' + error.message, 'error');
                
                // Fallback: Usar método anterior con código solamente
                console.log('🔄 Fallback: Usando método sin datos específicos...');
                try {
                    await imprimirZebraAutomatico(datosEtiqueta.codigo);
                } catch (fallbackError) {
                    console.error('❌ Fallback también falló:', fallbackError);
                    // Último fallback: Mostrar QR en modal
                    if (window.QRAlmacenSimple && typeof QRAlmacenSimple.generarQR === 'function') {
                        QRAlmacenSimple.generarQR(datosEtiqueta.codigo);
                    }
                }
            }
        }
        
        /**
         * Función para enviar al servicio Win32 de impresión
         */
        async function enviarAServicioWin32(comandoZPL, codigo, configuracion) {
            const serviceUrl = configuracion.service_url || 'http://localhost:5003';
            
            try {
                console.log(`🌐 Conectando al servicio Win32: ${serviceUrl}`);
                
                // Verificar si el servicio está disponible
                const statusResponse = await fetch(`${serviceUrl}/`, {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (!statusResponse.ok) {
                    throw new Error(`Servicio no disponible (${statusResponse.status})`);
                }
                
                const statusData = await statusResponse.json();
                console.log('📊 Estado del servicio:', statusData);
                
                if (!statusData.zebra_printer) {
                    throw new Error('No se detectó impresora Zebra ZT230 en el servicio');
                }
                
                // Enviar comando ZPL para impresión
                const printResponse = await fetch(`${serviceUrl}/print`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        zpl: comandoZPL,
                        codigo: codigo,
                        source: 'ILSAN_MES_Control_Almacen'
                    })
                });
                
                const printResult = await printResponse.json();
                
                if (printResponse.ok && printResult.status === 'printed') {
                    console.log('✅ Impresión exitosa via Win32:', printResult);
                    mostrarNotificacionImpresion(`✅ Etiqueta impresa en ${printResult.printer}`, 'success');
                    
                    // Log adicional
                    console.log(`📊 Detalles: ${printResult.bytes} bytes enviados a ${printResult.printer}`);
                    
                } else {
                    throw new Error(printResult.error || 'Error desconocido en impresión');
                }
                
            } catch (error) {
                console.error('❌ Error en servicio Win32:', error);
                
                // Verificar si es error de conexión al servicio
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    throw new Error('Servicio de impresión no disponible. Verifique que print_service.py esté ejecutándose.');
                } else {
                    throw error;
                }
            }
        }
        
        /**
         * Función fallback para usar el método anterior
         */
        async function enviarPorBackendAnterior(comandoZPL, codigo, configuracion) {
            console.log('🔄 Usando método fallback (backend anterior)...');
            
            try {
                const response = await fetch('/imprimir_etiqueta_qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        comando_zpl: comandoZPL,
                        metodo: configuracion.metodo,
                        ip: configuracion.ip
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ Fallback exitoso:', result.metodo);
                    mostrarNotificacionImpresion('✅ Etiqueta procesada (método fallback)', 'success');
                } else {
                    throw new Error(result.error || 'Error en método fallback');
                }
                
            } catch (error) {
                console.error('❌ Error en método fallback:', error);
                throw error;
            }
        }
        
        /**
         * Función para generar comando ZPL optimizado para impresión directa
         */
        function generarComandoZPLDirecto(codigo, tipo = 'material') {
            const fechaHora = new Date().toLocaleString('es-ES');
            const fecha = new Date().toLocaleDateString('es-ES');
            
            console.log('🏷️ Generando comando ZPL para:', codigo);
            console.log('📊 Tipo de etiqueta:', tipo);
            
            // Obtener información adicional del material desde los campos del formulario
            const numeroLote = document.getElementById('numero_lote_material')?.value || '';
            const numeroParte = document.getElementById('numero_parte_lower')?.value || '';
            const cantidadActual = document.getElementById('cantidad_actual')?.value || '';
            const propiedad = document.getElementById('almacen_especificacion_material')?.value || '';
            
            // === DEBUG: VERIFICAR VALORES DE LOS CAMPOS ===
            console.log('🔍 === VERIFICACIÓN DE CAMPOS PARA ETIQUETA ===');
            console.log('📦 Código:', codigo);
            console.log('🏷️ Número de lote:', `'${numeroLote}' (longitud: ${numeroLote.length})`);
            console.log('🔧 Número de parte:', `'${numeroParte}' (longitud: ${numeroParte.length})`);
            console.log('📊 Cantidad actual:', `'${cantidadActual}' (longitud: ${cantidadActual.length})`);
            console.log('⚙️ Especificación material:', `'${propiedad}' (longitud: ${propiedad.length})`);
            
            // Verificar si los campos críticos están vacíos
            if (!cantidadActual || cantidadActual.trim() === '') {
                console.warn('⚠️ ADVERTENCIA: Campo cantidad_actual está VACÍO');
                console.log('💡 Elemento cantidad_actual existe:', document.getElementById('cantidad_actual') ? 'SÍ' : 'NO');
                if (document.getElementById('cantidad_actual')) {
                    console.log('💡 Valor directo del elemento:', document.getElementById('cantidad_actual').value);
                }
            }
            
            if (!propiedad || propiedad.trim() === '') {
                console.warn('⚠️ ADVERTENCIA: Campo almacen_especificacion_material está VACÍO');
                console.log('💡 Elemento almacen_especificacion_material existe:', document.getElementById('almacen_especificacion_material') ? 'SÍ' : 'NO');
                if (document.getElementById('almacen_especificacion_material')) {
                    console.log('💡 Valor directo del elemento:', document.getElementById('almacen_especificacion_material').value);
                }
            }
            console.log('🔍 === FIN VERIFICACIÓN ===');
            
            // Crear datos para el QR con información COMPACTA para evitar "STRING TOO LONG"
            const datosQR = {
                c: codigo.substring(0, 15),  // Código acortado
                f: fecha.substring(0, 10),   // Solo fecha, sin hora
                l: numeroLote.substring(0, 8), // Lote acortado
                p: numeroParte.substring(0, 8), // Parte acortado
                q: cantidadActual.substring(0, 6), // Cantidad acortada
                m: propiedad.substring(0, 6), // Material acortado
                s: 'OK',  // Estado simplificado
                e: 'ILSAN' // Empresa acortada
            };
            
            // Convertir a JSON ultra compacto para el QR
            const textoQR = JSON.stringify(datosQR).replace(/"/g, '').replace(/:/g, '=').replace(/,/g, '|');
            
            console.log('📋 Datos para QR (COMPACTOS):', datosQR);
            console.log('📱 Texto QR generado (COMPACTO):', textoQR);
            console.log('📏 Longitud del QR:', textoQR.length, 'caracteres');
            
            let comandoZPL;
            
            if (tipo === 'simple') {
                // Etiqueta simple optimizada para 33.2mm x 14mm
                comandoZPL = `^XA
^PW264^LL112
^FO25,5^BQN,2,2^FDQA,${codigo}^FS
^FO70,8^ADN,8,5^FD${codigo}^FS
^FO70,25^ADN,6,4^FD${fechaHora}^FS
^FO25,45^ADN,5,3^FDMAT.REC^FS
^FO25,60^ADN,5,3^FDILSAN^FS
^XZ`;
            } else {
                // Etiqueta usando PLANTILLA PROFESIONAL del usuario, ajustada según requerimientos
                comandoZPL = `CT~~CD,~CC^~CT~
^XA
~TA000
~JSN
^LT37
^MNW
^MTT
^PON
^PMN
^LH0,0
^JMA
^PR4,4
~SD15
^JUS
^LRN
^CI27
^PA0,1,1,0
^XZ
^XA
^MMT
^PW392
^LL224
^LS0
^FT33,160^BQN,2,4
^FH\\^FDLA,${textoQR}^FS
^FT180,41^A0N,16,15^FH\\^CI28^FDCodigo de material recibido:^FS^CI27
^FT180,62^A0N,16,16^FH\\^CI28^FD${codigo}^FS^CI27
^FT180,83^A0N,15,15^FH\\^CI28^FDFecha de entrada: ${fecha}^FS^CI27
^FT180,104^A0N,14,14^FH\\^CI28^FD${numeroLote} ${numeroParte}^FS^CI27
^FT180,125^A0N,14,14^FH\\^CI28^FDQTY: ${cantidadActual}^FS^CI27
^FT180,140^A0N,14,14^FH\\^CI28^FD${propiedad}^FS^CI27
^PQ1,0,1,Y
^XZ`;
            }
            
            console.log('📝 Comando ZPL generado:');
            console.log(comandoZPL);
            
            return comandoZPL;
        }
        
        /**
         * Envío por USB (método principal para impresoras conectadas localmente)
         */
        async function enviarPorUSB(comandoZPL, codigo) {
            console.log('🔌 Enviando por USB...');
            
            // Método principal: Usar el nuevo endpoint optimizado
            try {
                const response = await fetch('/imprimir_etiqueta_qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        comando_zpl: comandoZPL,
                        metodo: 'usb'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ Impreso exitosamente por USB:', result.metodo);
                    mostrarNotificacionImpresion('✅ Etiqueta impresa correctamente', 'success');
                    return;
                } else {
                    throw new Error(result.error || 'Error de impresión USB');
                }
                
            } catch (error) {
                console.error('❌ Error de impresión USB:', error);
                throw new Error('Error de impresión USB: ' + error.message);
            }
        }
        
        /**
         * Envío por red (para impresoras con IP fija)
         */
        async function enviarPorRed(comandoZPL, ip, codigo) {
            console.log('🌐 Enviando por red a IP:', ip);
            
            try {
                // Usar el nuevo endpoint optimizado para red
                const response = await fetch('/imprimir_etiqueta_qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        codigo: codigo,
                        comando_zpl: comandoZPL,
                        metodo: 'red',
                        ip: ip
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ Impreso exitosamente por red');
                    mostrarNotificacionImpresion('✅ Etiqueta enviada a impresora de red', 'success');
                } else {
                    throw new Error(result.error || 'Error de comunicación con impresora');
                }
                
            } catch (error) {
                console.error('❌ Error de red:', error);
                throw new Error('Error de comunicación de red: ' + error.message);
            }
        }
        
        /**
         * Función para mostrar notificaciones de impresión
         */
        function mostrarNotificacionImpresion(mensaje, tipo) {
            // Remover notificación anterior
            const notifAnterior = document.getElementById('print-notification');
            if (notifAnterior) {
                notifAnterior.remove();
            }
            
            const colores = {
                info: '#17a2b8',
                success: '#28a745', 
                error: '#dc3545'
            };
            
            const iconos = {
                info: '🔄',
                success: '✅',
                error: '❌'
            };
            
            const notificacion = document.createElement('div');
            notificacion.id = 'print-notification';
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colores[tipo]};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10010;
                font-family: Arial, sans-serif;
                font-size: 14px;
                max-width: 350px;
                animation: slideInFromRight 0.3s ease-out;
            `;
            
            notificacion.innerHTML = `${iconos[tipo]} ${mensaje}`;
            
            // Añadir estilos de animación
            if (!document.getElementById('print-notification-styles')) {
                const styles = document.createElement('style');
                styles.id = 'print-notification-styles';
                styles.textContent = `
                    @keyframes slideInFromRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(notificacion);
            
            // Auto-remover según el tipo
            const duracion = tipo === 'error' ? 8000 : 4000;
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.style.animation = 'slideInFromRight 0.3s ease-in reverse';
                    setTimeout(() => {
                        if (notificacion.parentNode) {
                            notificacion.remove();
                        }
                    }, 300);
                }
            }, duracion);
        }
        
        // Función para configurar automáticamente la impresora si no está configurada
        function configurarImpresoraAutomatica() {
            const config = localStorage.getItem('zebra_config');
            
            if (!config) {
                console.log('🔧 Configurando impresora automáticamente...');
                
                // Configuración por defecto para ZT230 con servicio Win32
                const configDefault = {
                    ip: '192.168.1.100',
                    tipo: 'material',
                    metodo: 'usb',
                    service_url: 'http://localhost:5003',
                    use_win32_service: true
                };
                
                localStorage.setItem('zebra_config', JSON.stringify(configDefault));
                
                console.log('✅ Impresora configurada automáticamente:', configDefault);
                
                // Configuración automática completada - no hay botón que actualizar
                
                return configDefault;
            }
            
            const configActual = JSON.parse(config);
            
            // Actualizar configuración existente para incluir servicio Win32
            if (!configActual.service_url) {
                configActual.service_url = 'http://localhost:5003';
                configActual.use_win32_service = true;
                localStorage.setItem('zebra_config', JSON.stringify(configActual));
                console.log('🔄 Configuración actualizada con servicio Win32 local');
            }
            
            return configActual;
        }
        
        // Función para mostrar instrucciones de instalación del servicio
        window.mostrarInstruccionesServicio = function() {
            const instrucciones = `
🖨️ SERVICIO DE IMPRESIÓN AUTOMÁTICA ZEBRA ZT230

📋 INSTRUCCIONES DE INSTALACIÓN:

1️⃣ PREPARACIÓN:
   • Asegúrese de que Python 3.8+ esté instalado
   • Conecte la impresora Zebra ZT230 por USB
   • Verifique que la impresora esté configurada en Windows

2️⃣ INSTALACIÓN:
   • Navegue a la carpeta del proyecto ILSAN_MES
   • Ejecute el archivo: start_print_service.bat
   • El servicio se instalará automáticamente

3️⃣ VERIFICACIÓN:
   • Ejecute: testServicioWin32() en la consola
   • Debe mostrar la impresora ZT230 detectada
   • Se ejecutará un test de impresión automático

4️⃣ USO:
   • Una vez configurado, la impresión será automática
   • Al guardar un material se imprimirá sin confirmaciones
   • No se necesitan más configuraciones

🔧 TROUBLESHOOTING:
   • Si hay error: pip install flask pywin32
   • Verificar nombre de impresora en Panel de Control
   • Verificar que puerto 5000 esté libre

💡 VENTAJAS:
   ✅ Impresión totalmente automática
   ✅ Sin diálogos ni confirmaciones
   ✅ Detección automática de impresora
   ✅ Logs detallados para diagnóstico
   ✅ Fallback a métodos anteriores
            `;
            
            console.log(instrucciones);
            alert(instrucciones);
        };
        
        // Configurar impresora automáticamente al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            configurarImpresoraAutomatica();
            
            // Verificar servicio en background (sin bloquear)
            setTimeout(async () => {
                try {
                    const response = await fetch(configuracion.server_url + '/', { 
                        method: 'GET',
                        signal: AbortSignal.timeout(3000) // Timeout de 3 segundos
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('🖨️ Servicio Win32 detectado:', data.zebra_printer);
                        
                        // Servicio detectado - ya no hay botón que actualizar
                    }
                } catch (error) {
                    console.log('⚠️ Servicio Win32 no disponible (normal si no está iniciado)');
                }
            }, 2000);
        });
        
        console.log('✅ Sistema de impresión automática directa configurado (Win32)');
        
        // ============= FUNCIONES DE PRUEBA Y DIAGNÓSTICO =============
        
        /**
         * Función para probar la generación de comando ZPL
         */
        window.testGenerarZPL = function(codigo = 'TEST-12345', tipo = 'material') {
            console.log('🧪 === PROBANDO GENERACIÓN DE ZPL ===');
            console.log(`📋 Código: ${codigo}`);
            console.log(`🏷️ Tipo: ${tipo}`);
            
            const comandoZPL = generarComandoZPLDirecto(codigo, tipo);
            
            console.log('📝 Comando ZPL generado:');
            console.log('------- INICIO ZPL -------');
            console.log(comandoZPL);
            console.log('------- FIN ZPL -------');
            
            console.log('📊 Detalles del comando:');
            console.log(`   📏 Longitud: ${comandoZPL.length} caracteres`);
            console.log(`   📄 Líneas: ${comandoZPL.split('\n').length}`);
            console.log(`   🔤 Contiene código: ${comandoZPL.includes(codigo) ? '✅' : '❌'}`);
            console.log(`   📅 Contiene fecha: ${comandoZPL.includes(new Date().toLocaleDateString('es-ES')) ? '✅' : '❌'}`);
            
            return comandoZPL;
        };
        
        /**
         * Función para probar impresión completa (sin imprimir realmente)
         */
        window.testImpresionCompleta = function(codigo = 'TEST-67890') {
            console.log('🧪 === PROBANDO FLUJO COMPLETO DE IMPRESIÓN ===');
            console.log(`📋 Código de prueba: ${codigo}`);
            
            // 1. Verificar configuración
            const config = localStorage.getItem('zebra_config');
            console.log('🔧 Configuración actual:', config ? JSON.parse(config) : 'No configurado');
            
            // 2. Generar comando ZPL
            const comandoZPL = testGenerarZPL(codigo);
            
            // 3. Simular envío al servicio
            console.log('📡 Simulando envío al servicio Win32...');
            console.log('🌐 URL destino: http://localhost:5003/print');
            console.log('📦 Datos a enviar:');
            console.log({
                zpl: comandoZPL,
                codigo: codigo,
                source: 'ILSAN_MES_Control_Almacen'
            });
            
            console.log('✅ Test de flujo completo finalizado');
            console.log('💡 Para probar impresión real use: testImpresionReal()');
        };
        
        /**
         * Función para probar impresión real (¡CUIDADO: SÍ IMPRIME!)
         */
        window.testImpresionReal = async function(codigo = 'TEST-REAL-' + Date.now()) {
            console.log('🚨 === PRUEBA DE IMPRESIÓN REAL ===');
            console.log('⚠️ ¡ESTA FUNCIÓN SÍ VA A IMPRIMIR EN LA ZEBRA!');
            console.log(`📋 Código: ${codigo}`);
            
            try {
                await imprimirZebraAutomatico(codigo);
                console.log('✅ Prueba de impresión real completada');
            } catch (error) {
                console.error('❌ Error en prueba real:', error);
            }
        };
        
        /**
         * Función para verificar el servicio Win32
         */
        window.testServicioWin32 = async function() {
            console.log('🔧 === VERIFICANDO SERVICIO WIN32 ===');
            
            try {
                const response = await fetch('http://localhost:5003/', {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Servicio Win32 disponible');
                    console.log('📊 Estado del servicio:', data);
                    console.log(`🖨️ Impresora Zebra: ${data.zebra_printer ? '✅ Detectada' : '❌ No detectada'}`);
                    console.log(`📦 Impresoras totales: ${data.total_printers}`);
                    
                    if (data.zebra_printer) {
                        console.log('🎯 ¿Quiere hacer una prueba de impresión? Ejecute:');
                        console.log('   testImpresionReal()');
                    }
                    
                    return data;
                } else {
                    console.error(`❌ Error del servicio: ${response.status}`);
                    return null;
                }
                
            } catch (error) {
                console.error('❌ Error conectando al servicio Win32:', error);
                console.log('💡 Soluciones:');
                console.log('   1. Ejecute: start_print_service.bat');
                console.log('   2. Verifique que Python esté instalado');
                console.log('   3. Verifique que el puerto 5002 esté libre');
                return null;
            }
        };
        
        /**
         * Función de diagnóstico completo
         */
        window.diagnosticoCompleto = async function() {
            console.log('🩺 === DIAGNÓSTICO COMPLETO DEL SISTEMA ===');
            
            console.log('\n1️⃣ Verificando configuración...');
            const config = localStorage.getItem('zebra_config');
            if (config) {
                console.log('✅ Configuración encontrada:', JSON.parse(config));
            } else {
                console.log('⚠️ No hay configuración guardada');
            }
            
            console.log('\n2️⃣ Probando generación ZPL...');
            testGenerarZPL('DIAG-TEST-001');
            
            console.log('\n3️⃣ Verificando servicio Win32...');
            const servicioData = await testServicioWin32();
            
            console.log('\n4️⃣ Resumen del diagnóstico:');
            console.log(`   📝 Configuración: ${config ? '✅' : '❌'}`);
            console.log(`   🏷️ Generación ZPL: ✅`);
            console.log(`   🔧 Servicio Win32: ${servicioData ? '✅' : '❌'}`);
            console.log(`   🖨️ Zebra detectada: ${servicioData?.zebra_printer ? '✅' : '❌'}`);
            
            if (config && servicioData?.zebra_printer) {
                console.log('\n🎉 ¡Sistema listo para impresión automática!');
                console.log('💡 Pruebe guardando un material para ver la impresión automática');
            } else {
                console.log('\n⚠️ Sistema no está completamente configurado');
                console.log('💡 Ejecute: mostrarInstruccionesServicio() para obtener ayuda');
            }
            
            return {
                configuracion: !!config,
                servicioWin32: !!servicioData,
                zebraDetectada: !!servicioData?.zebra_printer
            };
        };
        
        /**
         * Función para probar QR completo con información real
         */
        window.testQRCompleto = function(codigo = 'TEST-QR-COMPLETO-' + Date.now()) {
            console.log('🧪 === TEST QR COMPLETO CON INFORMACIÓN ===');
            console.log(`📋 Código de prueba: ${codigo}`);
            
            // Simular datos del formulario
            const datosSimulados = {
                codigo: codigo,
                lote: 'L2025001',
                parte: 'P12345',
                cantidad: '100',
                propiedad: 'RESISTOR'
            };
            
            // Llenar temporalmente los campos para la prueba
            const campos = {
                'numero_lote_material': datosSimulados.lote,
                'numero_parte_lower': datosSimulados.parte,
                'cantidad_actual': datosSimulados.cantidad,
                'propiedad_material': datosSimulados.propiedad
            };
            
            console.log('📝 Llenando campos temporalmente para la prueba:');
            Object.keys(campos).forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.value = campos[id];
                    console.log(`   ✅ ${id}: ${campos[id]}`);
                } else {
                    console.log(`   ⚠️ ${id}: Campo no encontrado`);
                }
            });
            
            // Generar comando ZPL con QR completo
            const comandoZPL = generarComandoZPLDirecto(codigo, 'material');
            
            // Mostrar información del QR
            console.log('📱 Información que se incluirá en el QR:');
            console.log(`   • Código: ${codigo}`);
            console.log(`   • Fecha: ${new Date().toLocaleDateString('es-ES')}`);
            console.log(`   • Lote: ${datosSimulados.lote}`);
            console.log(`   • Parte: ${datosSimulados.parte}`);
            console.log(`   • Cantidad: ${datosSimulados.cantidad}`);
            console.log(`   • Propiedad: ${datosSimulados.propiedad}`);
            console.log(`   • Estado: ACTIVO`);
            console.log(`   • Empresa: ILSAN_ELECTRONICS`);
            
            console.log('🎯 ¿Desea imprimir esta etiqueta de prueba?');
            console.log('💡 Para imprimir ejecute: testImpresionReal("' + codigo + '")');
            
            return comandoZPL;
        };
        
        /**
         * Función para probar etiqueta pequeña (33.2mm x 14mm)
         */
        window.testEtiquetaPequena = function(codigo = 'TEST-PEQUENA-' + Date.now()) {
            console.log('🏷️ === TEST ETIQUETA PEQUEÑA (33.2mm x 14mm) ===');
            console.log(`📋 Código de prueba: ${codigo}`);
            console.log('📏 Medidas: 33.2mm ancho x 14mm alto');
            console.log('🖨️ Optimizado para: Zebra ZT230 - 300dpi');
            
            // Simular datos del formulario
            const datosSimulados = {
                codigo: codigo,
                lote: 'L2025001',
                parte: 'P12345',
                cantidad: '100',
                propiedad: 'RESISTOR'
            };
            
            // Llenar campos temporalmente
            const campos = {
                'numero_lote_material': datosSimulados.lote,
                'numero_parte_lower': datosSimulados.parte,
                'cantidad_actual': datosSimulados.cantidad,
                'propiedad_material': datosSimulados.propiedad
            };
            
            Object.keys(campos).forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.value = campos[id];
                    console.log(`   ✅ ${id}: ${campos[id]}`);
                }
            });
            
            // Generar comando ZPL optimizado para etiqueta pequeña
            const comandoZPL = generarComandoZPLDirecto(codigo, 'material');
            
            console.log('📊 Detalles del comando ZPL:');
            console.log(`   📏 Ancho de página: ^PW264 (33.2mm a 300dpi)`);
            console.log(`   📏 Alto de etiqueta: ^LL112 (14mm a 300dpi)`);
            console.log(`   📱 QR: 2x3 (tamaño pequeño pero legible)`);
            console.log(`   🔤 Fuentes: Reducidas para ajustar al espacio`);
            console.log(`   📐 Posiciones: Optimizadas para etiqueta pequeña`);
            
            console.log('💡 Para imprimir esta etiqueta pequeña ejecute:');
            console.log(`   testImpresionReal("${codigo}")`);
            
            return comandoZPL;
        };

        /**
         * Función para mostrar layout de etiqueta pequeña
         */
        window.mostrarLayoutPequeno = function() {
            console.log('📐 === LAYOUT ETIQUETA PEQUEÑA MEJORADO (33.2mm x 14mm) ===');
            console.log('');
            console.log('┌──────────────────────────────────┐');
            console.log('│ ██ 0RH5602C622,20250716001       │'); 
            console.log('│ ██ 16/07/2025                    │');
            console.log('│ ██ ILSAN                         │');
            console.log('│ QR L:L202501    RESIST           │');
            console.log('│    P:P12345     ACTIVO           │');
            console.log('│    Q:100        OK               │');
            console.log('└──────────────────────────────────┘');
            console.log('');
            console.log('📏 Especificaciones técnicas MEJORADAS:');
            console.log('   • Ancho: 33.2mm = 264 dots a 300dpi');
            console.log('   • Alto: 14mm = 112 dots a 300dpi');
            console.log('   • QR: Tamaño 2x4 (más grande y legible)');
            console.log('   • Fuentes: ADN,5,3 a ADN,9,6 (más grandes)');
            console.log('   • Distribución: 3 columnas para mejor aprovechamiento');
            console.log('');
            console.log('🎯 Contenido del QR (JSON compacto):');
            console.log('   • Toda la información del material');
            console.log('   • 8 campos de datos completos');
            console.log('   • Trazabilidad total en espacio mínimo');
        };

        /**
         * Función para mostrar resumen de la nueva funcionalidad QR
         */
        window.mostrarResumenQR = function() {
            const resumen = `
🎯 === NUEVA FUNCIONALIDAD: QR CON INFORMACIÓN COMPLETA ===

📋 ¿QUÉ SE AGREGÓ?
   ✅ QR ahora incluye TODA la información del material
   ✅ Generación automática de JSON con todos los datos
   ✅ Compatibilidad con etiquetas simples y completas
   ✅ Optimización para etiquetas pequeñas (33.2mm x 14mm)
   ✅ Funciones de prueba y diagnóstico

📱 INFORMACIÓN INCLUIDA EN EL QR:
   • Código del material (completo con consecutivo)
   • Fecha de creación
   • Número de lote
   • Número de parte
   • Cantidad actual
   • Propiedad del material
   • Estado (ACTIVO)
   • Empresa (ILSAN_ELECTRONICS)

🔧 FUNCIONES NUEVAS DISPONIBLES:
   • testQRCompleto() - Prueba con datos simulados
   • testEtiquetaPequena() - Optimizada para 33.2mm x 14mm
   • mostrarLayoutPequeno() - Visualización del diseño
   • verificarQRCompleto() - Muestra contenido del QR

📊 TIPOS DE ETIQUETA:
   🏷️ SIMPLE: QR básico + texto esencial (para etiquetas pequeñas)
   🏷️ MATERIAL: QR completo + información detallada

📏 OPTIMIZACIÓN PARA MEDIDAS REALES:
   • 33.2mm x 14mm = 264 x 112 dots a 300dpi
   • QR compacto pero con información completa
   • Fuentes escaladas para máxima legibilidad
   • Aprovechamiento total del espacio disponible

🎮 CÓMO PROBAR:
   1. testEtiquetaPequena() - Etiqueta optimizada para medidas reales
   2. mostrarLayoutPequeno() - Ver diseño de la etiqueta
   3. testImpresionReal() - Imprimir etiqueta real (¡CUIDADO!)

📱 AL ESCANEAR EL QR OBTENDRÁS:
   Un JSON con toda la información que puedes procesar automáticamente
   
💡 BENEFICIOS:
   ✅ Trazabilidad completa del material
   ✅ Información accesible sin conectividad
   ✅ Compatibilidad con sistemas externos
   ✅ Backup de información en la etiqueta física
   ✅ Optimizado para etiquetas de tamaño real
            `;
            
            console.log(resumen);
            alert(resumen);
        };
        
        console.log('🧪 Funciones de prueba disponibles:');
        console.log('   - testGenerarZPL()');
        console.log('   - testImpresionCompleta()');  
        console.log('   - testImpresionReal()');
        console.log('   - testServicioWin32()');
        console.log('   - diagnosticoCompleto()');
        console.log('   - testQRCompleto()');
        console.log('   - testEtiquetaPequena() ← Para 33.2mm x 14mm');
        console.log('   - testEtiquetaOptimizada() ← Sin STRING TOO LONG');
        console.log('   - testMedidasEspecificas() ← NUEVO: Con ^XFR:si.ZPL^FS');
        console.log('   - mostrarLayoutPequeno() ← Ver diseño optimizado');
        console.log('   - verificarQRCompleto()');
        console.log('   - mostrarResumenQR()');
        
        /**
         * Función para probar etiqueta con fuentes GRANDES (solucionando texto pequeño)
         */
        window.testFuentesGrandes = function(codigo = 'TEST-GRANDE-' + Date.now()) {
            console.log('🔤 === TEST FUENTES MÁS GRANDES (SOLUCIÓN TEXTO PEQUEÑO) ===');
            console.log(`📋 Código de prueba: ${codigo}`);
            console.log('📏 Medidas: 33.2mm x 14mm con fuentes GRANDES');
            console.log('🖨️ Incluye: ^XFR:si.ZPL^FS y ^PQ1,0,1');
            console.log('🎯 SOLUCIÓN: Texto MUCHO más grande y legible');
            
            // Simular datos del formulario
            const datosSimulados = {
                codigo: codigo,
                lote: 'L202501',
                parte: 'P12345',
                cantidad: '100',
                propiedad: 'RESIST'
            };
            
            // Llenar campos temporalmente
            const campos = {
                'numero_lote_material': datosSimulados.lote,
                'numero_parte_lower': datosSimulados.parte,
                'cantidad_actual': datosSimulados.cantidad,
                'propiedad_material': datosSimulados.propiedad
            };
            
            Object.keys(campos).forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.value = campos[id];
                    console.log(`   ✅ ${id}: ${campos[id]}`);
                } else {
                    console.log(`   ⚠️ ${id}: Campo no encontrado`);
                }
            });
            
            // Generar comando ZPL con fuentes GRANDES
            const comandoZPL = generarComandoZPLDirecto(codigo, 'material');
            
            console.log('📊 NUEVOS TAMAÑOS DE FUENTE (MÁS GRANDES):');
            console.log(`   📏 Código: ADN,12,8 (MUCHO MÁS GRANDE)`);
            console.log(`   📏 Fecha: ADN,10,6 (MÁS GRANDE)`);
            console.log(`   📏 Empresa: ADN,8,5 (GRANDE)`);
            console.log(`   📏 Detalles: ADN,6,4 (LEGIBLE)`);
            console.log(`   � QR: BQN,2,4 (MÁS GRANDE)`);
            console.log(`   � Longitud total ZPL: ${comandoZPL.length} caracteres`);
            
            console.log('📊 INCREMENTO DE TAMAÑO:');
            console.log(`   • Código: +71% más grande`);
            console.log(`   • Fecha: +100% más grande`);
            console.log(`   • Empresa: +100% más grande`);
            console.log(`   • Detalles: +100% más grande`);
            console.log(`   • QR: +33% más grande`);
            
            // Extraer y mostrar información del QR
            const qrMatch = comandoZPL.match(/\^FDQA,(.+?)\^FS/);
            if (qrMatch) {
                const textoQR = qrMatch[1];
                console.log(`   📱 Longitud QR: ${textoQR.length} caracteres`);
                console.log(`   ✅ QR compacto sin STRING TOO LONG`);
            }
            
            // Verificar comandos específicos
            if (comandoZPL.includes('^XFR:si.ZPL^FS')) {
                console.log('   ✅ Comando ^XFR:si.ZPL^FS incluido');
            }
            
            if (comandoZPL.includes('^PQ1,0,1')) {
                console.log('   ✅ Comando ^PQ1,0,1 incluido');
            }
            
            console.log('💡 Para imprimir con fuentes GRANDES ejecute:');
            console.log(`   testImpresionReal("${codigo}")`);
            console.log('🎯 ¡Ahora el texto debería verse MUCHO más grande!');
            
            return comandoZPL;
        };

        /**
         * Función para mostrar comparación antes/después de la optimización
         */
        window.mostrarComparacionOptimizacion = function() {
            console.log('📊 === COMPARACIÓN: ANTES vs DESPUÉS ===');
            console.log('');
            console.log('❌ ANTES (con STRING TOO LONG):');
            console.log('   📱 QR JSON: {"codigo":"0RH5602C622,20250716001","fecha":"16/07/2025"...}');
            console.log('   📏 Longitud QR: 180+ caracteres');
            console.log('   🔤 Fuentes: ADN,9,6 (muy grandes)');
            console.log('   📱 QR size: BQN,2,4');
            console.log('   ❌ Resultado: STRING TOO LONG!');
            console.log('');
            console.log('✅ DESPUÉS (optimizado):');
            console.log('   📱 QR compacto: {c=0RH5602C622|202|f=16/07/25|l=L202501...}');
            console.log('   📏 Longitud QR: 77 caracteres');
            console.log('   🔤 Fuentes: ADN,4,2 a ADN,8,5 (balanceadas)');
            console.log('   📱 QR size: BQN,2,3');
            console.log('   ✅ Resultado: Impresión exitosa');
            console.log('');
            console.log('🎯 BENEFICIOS DE LA OPTIMIZACIÓN:');
            console.log('   ✅ Sin errores STRING TOO LONG');
            console.log('   ✅ QR más pequeño pero legible');
            console.log('   ✅ Información completa preservada');
            console.log('   ✅ Mejor distribución en etiqueta pequeña');
            console.log('   ✅ Compatibilidad total con ZT230');
        };
        
        /**
         * Función para probar PLANTILLA PROFESIONAL del usuario
         */
        window.testPlantillaProfesional = function(codigo = 'TEST-PROF-' + Date.now()) {
            console.log('🏆 === TEST PLANTILLA PROFESIONAL (NUEVA) ===');
            console.log(`📋 Código de prueba: ${codigo}`);
            console.log('🎯 Usando plantilla ZPL profesional del usuario');
            console.log('📏 Características de la plantilla:');
            console.log('   • Tamaño: 392x224 dots (MÁS GRANDE)');
            console.log('   • QR: BQN,2,8 (MUCHO MÁS GRANDE)');
            console.log('   • Fuentes: A0N,18,18 y A0N,20,20 (GRANDES)');
            console.log('   • Codificación: CI28 (Unicode)');
            console.log('   • Layout: Profesional con etiquetas descriptivas');
            
            // Simular datos del formulario
            const datosSimulados = {
                codigo: codigo,
                lote: 'L202501',
                parte: 'P12345',
                cantidad: '100',
                propiedad: 'RESIST'
            };
            
            // Llenar campos temporalmente
            const campos = {
                'numero_lote_material': datosSimulados.lote,
                'numero_parte_lower': datosSimulados.parte,
                'cantidad_actual': datosSimulados.cantidad,
                'propiedad_material': datosSimulados.propiedad
            };
            
            Object.keys(campos).forEach(id => {
                const campo = document.getElementById(id);
                if (campo) {
                    campo.value = campos[id];
                    console.log(`   ✅ ${id}: ${campos[id]}`);
                } else {
                    console.log(`   ⚠️ ${id}: Campo no encontrado`);
                }
            });
            
            // Generar comando ZPL con plantilla profesional
            const comandoZPL = generarComandoZPLDirecto(codigo, 'material');
            
            console.log('🎯 VENTAJAS DE LA PLANTILLA PROFESIONAL:');
            console.log('   ✅ Etiqueta MÁS GRANDE (392x224 vs 264x112)');
            console.log('   ✅ QR MUCHO MÁS GRANDE (BQN,2,8)');
            console.log('   ✅ Texto con etiquetas descriptivas');
            console.log('   ✅ Fuentes grandes y legibles');
            console.log('   ✅ Codificación Unicode (CI28)');
            console.log('   ✅ Layout profesional y claro');
            console.log('   ✅ Configuración avanzada de impresora');
            
            console.log(`📏 Longitud total ZPL: ${comandoZPL.length} caracteres`);
            
            // Extraer y mostrar información del QR
            const qrMatch = comandoZPL.match(/\\^FDLA,(.+?)\\^FS/);
            if (qrMatch) {
                const textoQR = qrMatch[1];
                console.log(`📱 QR: ${textoQR.length} caracteres`);
                console.log(`📱 Contenido: ${textoQR}`);
            }
            
            console.log('💡 Para imprimir con PLANTILLA PROFESIONAL:');
            console.log(`   testImpresionReal("${codigo}")`);
            console.log('🏆 ¡Esta plantilla debería dar el MEJOR resultado!');
            
            return comandoZPL;
        };
    </script>

</body>
</html>