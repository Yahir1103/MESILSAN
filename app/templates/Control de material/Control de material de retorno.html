<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Devolución de material</title>
  <link rel="stylesheet" href="/static/css/Control_retorno.css">
</head>
<body>
<div class="dm-wrap">

  <!-- Bloque 1: Solo “Código de material recibido” -->
  <div class="dm-card dm-top-only">
    <label class="dm-label">Código de material recibido</label>
    <input class="dm-input" type="text" id="cod_material_recibido">
  </div>

  <!-- Bloque 2: Form principal con layout ajustado -->
  <div class="dm-card">
    <div class="dm-form-main">
      
      <!-- Primera fila: Código de material y Especificación con botón -->
      <div class="dm-row-2">
        <div class="dm-col">
          <label class="dm-label">Código de material</label>
          <input class="dm-input" type="text" id="codigo_material">
        </div>
        <div class="dm-col">
          <label class="dm-label">Especificación de material</label>
          <input class="dm-input" type="text" id="especificacion_material">
        </div>
        <div class="dm-buttons-inline">
          <button class="dm-btn dm-btn-ghost">Confi. de impresora</button>
        </div>
      </div>

      <!-- Segunda fila: Número de parte con botón -->
      <div class="dm-row-1">
        <div class="dm-col">
          <label class="dm-label">Número de parte</label>
          <input class="dm-input" type="text" id="numero_parte">
        </div>
        <div class="dm-col-empty"></div>
        <div class="dm-buttons-inline">
          <button class="dm-btn dm-btn-orange">Guardar</button>
        </div>
      </div>

      <!-- Tercera fila: Las tres cantidades -->
      <div class="dm-row-3">
        <div class="dm-col">
          <label class="dm-label">Cantidad estandarizada</label>
          <input class="dm-input" type="number" id="cantidad_estandarizada" value="0">
        </div>
        <div class="dm-col">
          <label class="dm-label">Cantidad de remanente</label>
          <input class="dm-input" type="number" id="cantidad_remanente" value="0">
        </div>
        <div class="dm-col">
          <label class="dm-label">Cantidad de retorno</label>
          <input class="dm-input" type="number" id="cantidad_retorno" value="0">
        </div>
      </div>

    </div>
  </div>

  <!-- Bloque 3: Barra de fechas y acciones -->
  <div class="dm-card dm-bar">
    <label style="display:flex;align-items:center;gap:8px;">
      <input type="checkbox" id="chk_fecha_retorno">
      <span>Fecha de retorno</span>
    </label>

    <!-- Si prefieres selects, reemplaza estos date inputs -->
    <input class="dm-date" type="date" id="fecha_desde">
    <span>~</span>
    <input class="dm-date" type="date" id="fecha_hasta">

    <div class="dm-spacer"></div>

    <button class="dm-btn">Consultar</button>
    <button class="dm-btn dm-btn-green">Exportar el excel</button>
    <button class="dm-btn dm-btn-ghost">Reimprimir</button>
  </div>

  <!-- Bloque 4: Tabla de resultados -->
  <div class="dm-card">
    <div style="padding: 10px;">
      <h3 style="margin: 0 0 10px 0; color: var(--c-text); font-size: 16px;">Historial de Devoluciones</h3>
      <table class="dm-table">
        <thead>
          <tr>
            <th style="width:40px">Sel</th>
            <th>Fecha Recibido</th>
            <th>Recibido Por</th>
            <th>Código Material</th>
            <th>Parte</th>
            <th>Lote</th>
            <th style="width:80px">Std</th>
            <th style="width:80px">Retorno</th>
            <th style="width:80px">Pérdida</th>
            <th>Especificación</th>
          </tr>
        </thead>
        <tbody id="tabla-body">
          <!-- Los datos se cargan dinámicamente -->
        </tbody>
      </table>
      <div class="dm-table-footer" id="tabla-footer">
        Total Rows : 0
      </div>
    </div>
  </div>

</div>

<script>
  // ------- formato de número --------
  function fmt(n){
    return (n||0).toLocaleString('es-MX');
  }

  // ------- datos de ejemplo --------
  const rows = [];
  const codRec = ['PRODTECNICO1','MANAGER','PRODTECH2','SUPERVISOR1','ADMIN'];
  const codMat = ['A12345678','B98765432','C11223344','D55667788','E99887766'];
  const partes = ['Resistor 1k','Capacitor 10uF','LED Red','Connector','Switch'];
  const lotes = ['LOT001','LOT002','LOT003','LOT004','LOT005'];
  const spec = ['Spec A','Spec B','Spec C','Spec D','Spec E'];

  function pad(n){return n<10?'0'+n:n}
  
  for(let i=0; i<50; i++){
    const d = new Date(2024, 0, 1 + Math.floor(Math.random()*365));
    d.setHours(Math.floor(Math.random()*24));
    d.setMinutes(Math.floor(Math.random()*60));
    d.setSeconds(Math.floor(Math.random()*60));
    
    rows.push({
      fecha: `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`,
      recibido: codRec[i%codRec.length],
      codigo: codMat[i%codMat.length],
      parte: partes[i%partes.length],
      lote: lotes[i%lotes.length],
      std: [0,150,864,2000,4000,10000][i%6],
      retorno: [0,100,150,864,200,3000,4000,1500,600,100][i%10],
      perdida: [0,26,200,500,799,0,1,1921,0][i%9]*(i%3===0?-1:1),
      espec: spec[i%spec.length]
    });
  }

  // ------- render tabla --------
  function renderTabla(data){
    const body = document.getElementById('tabla-body');
    body.innerHTML = '';
    data.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="dm-checkbox"></td>
        <td>${r.fecha}</td>
        <td title="${r.recibido}">${r.recibido}</td>
        <td>${r.codigo}</td>
        <td>${r.parte}</td>
        <td>${r.lote||''}</td>
        <td class="num">${fmt(r.std)}</td>
        <td class="num">${fmt(r.retorno)}</td>
        <td class="num">${fmt(r.perdida)}</td>
        <td title="${r.espec}">${r.espec}</td>
      `;
      body.appendChild(tr);
    });
    document.getElementById('tabla-footer').textContent = `Total Rows : ${data.length}`;
  }
  
  // Cargar datos iniciales
  renderTabla(rows);

  // ------- eventos --------
  document.addEventListener('DOMContentLoaded', function() {
    // Establecer fechas por defecto
    const today = new Date();
    const lastMonth = new Date(today);
    lastMonth.setMonth(today.getMonth() - 1);
    
    document.getElementById('fecha_desde').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('fecha_hasta').value = today.toISOString().split('T')[0];

    // Evento consultar
    document.querySelector('.dm-bar .dm-btn').addEventListener('click', function() {
      const useDate = document.getElementById('chk_fecha_retorno').checked;
      if(!useDate) return renderTabla(rows);
      
      const d1 = new Date(document.getElementById('fecha_desde').value + 'T00:00:00');
      const d2 = new Date(document.getElementById('fecha_hasta').value + 'T23:59:59');
      
      const filtered = rows.filter(r=>{
        const dt = new Date(r.fecha.replace(' ','T'));
        return dt>=d1 && dt<=d2;
      });
      renderTabla(filtered);
    });

    // Evento exportar
    document.querySelector('.dm-btn-green').addEventListener('click', function() {
      alert('Funcionalidad de exportación a Excel se implementará próximamente.');
    });

    // Evento guardar
    document.querySelector('.dm-btn-orange').addEventListener('click', function() {
      const codMaterialRecibido = document.getElementById('cod_material_recibido').value;
      const codigoMaterial = document.getElementById('codigo_material').value;
      const especificacion = document.getElementById('especificacion_material').value;
      const numeroParte = document.getElementById('numero_parte').value;
      const cantEstandarizada = document.getElementById('cantidad_estandarizada').value;
      const cantRemanente = document.getElementById('cantidad_remanente').value;
      const cantRetorno = document.getElementById('cantidad_retorno').value;

      if (!codMaterialRecibido || !codigoMaterial) {
        alert('Por favor complete al menos el código de material recibido y el código de material.');
        return;
      }

      // Simular guardado
      alert('Registro guardado correctamente.');
      
      // Limpiar formulario
      document.getElementById('cod_material_recibido').value = '';
      document.getElementById('codigo_material').value = '';
      document.getElementById('especificacion_material').value = '';
      document.getElementById('numero_parte').value = '';
      document.getElementById('cantidad_estandarizada').value = '0';
      document.getElementById('cantidad_remanente').value = '0';
      document.getElementById('cantidad_retorno').value = '0';
    });
  });
</script>
