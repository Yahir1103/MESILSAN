<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Inventario General</title>
    <link rel="stylesheet" href="/static/css/control_retorno_material.css">
    <link rel="stylesheet" href="/static/css/control_retorno_material_responsive.css">
</head>
<body>
    <div id="control-retorno-container">
        <!-- Formulario de filtros -->
        <div class="material-form-section">
            <div class="material-form-row single">
                <div class="material-form-group">
                    <label for="inventario_buscar_material">Buscar material (Código o Número de Parte)</label>
                    <input type="text" class="material-form-control" id="inventario_buscar_material" placeholder="Escanear código o buscar..." onkeydown="procesarBusquedaInventario(event)" autocomplete="off">
                </div>
            </div>
            
            <div class="material-form-row three-column">
                <div class="material-form-group">
                    <label for="inventario_propiedad">Filtrar por Propiedad</label>
                    <select class="material-form-control" id="inventario_propiedad">
                        <option value="">Todas las propiedades</option>
                        <option value="CUSTOMER PROPERTY">CUSTOMER PROPERTY</option>
                        <option value="ISEMM PROPERTY">ISEMM PROPERTY</option>
                        <option value="COMMON USE">COMMON USE</option>
                    </select>
                </div>
                <div class="material-form-group">
                    <label for="inventario_cantidad_min">Cantidad mínima</label>
                    <input type="number" class="material-form-control" id="inventario_cantidad_min" placeholder="0" min="0" step="0.01">
                </div>
                <div class="material-form-group">
                    <label for="inventario_cantidad_max">Cantidad máxima</label>
                    <input type="number" class="material-form-control" id="inventario_cantidad_max" placeholder="Sin límite" min="0" step="0.01">
                </div>
            </div>
        </div>
        
        <!-- Sección de controles y botones -->
        <div class="material-toolbar">
            <div class="date-range-container">
                <label>Consulta de Inventario General</label>
                <div class="inventory-stats">
                    <span id="inventario_total_items">Total de productos: 0</span>
                    <span id="inventario_total_valor">Valor total: $ 0.00</span>
                </div>
            </div>
            
            <div class="material-action-buttons">
                <button class="material-btn material-btn-info" id="inventario_btn_consultar">
                    <i class="fas fa-search"></i> Consultar Inventario
                </button>
                <button class="material-btn material-btn-success" id="inventario_btn_exportar">
                    <i class="fas fa-file-excel"></i> Exportar Excel
                </button>
                <input type="file" id="importarExcelRetorno" onchange="importarExcelRetorno()" style="display:none" accept=".xlsx,.xls" />
                <button class="material-btn material-btn-success" onclick="document.getElementById('importarExcelRetorno').click()">
                    <i class="fas fa-file-excel"></i> Importar Excel
                </button>
                <button class="material-btn material-btn-warning" id="inventario_btn_actualizar">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>
        </div>
        
        <!-- Tabla de inventario -->
        <div class="material-table-container">
            <div class="material-table-wrapper">
                <table class="material-data-table" id="inventario_data_table">
                    <thead>
                        <tr>
                            <th class="checkbox-col">
                                <input type="checkbox" id="inventario_select_all_checkbox" onchange="toggleAllInventario(this)">
                            </th>
                            <th>Número de Parte</th>
                            <th>Código de Material</th>
                            <th>Propiedad</th>
                            <th>Especificación</th>
                            <th class="cantidad-col">Cantidad Total</th>
                            <th class="cantidad-col">Total Lotes</th>
                            <th class="cantidad-col">Disponible</th>
                            <th>Último Recibo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventario_table_body">
                        <tr>
                            <td colspan="10" class="no-data">
                                <i class="fas fa-box-open"></i>
                                Haga clic en "Consultar Inventario" para cargar los datos
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Footer con contador -->
        <div class="material-table-footer">
            <div class="table-info">
                <span id="inventario_row_counter">Total de registros: 0</span>
            </div>
            <div class="table-pagination">
                <div class="pagination-info">
                    <span id="inventario_pagination_info">Mostrando 0 de 0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Función de inicialización del módulo
        function initControlRetorno() {
            
            // Configurar eventos de los botones
            setupInventarioEventListeners();
            
            // Cargar datos iniciales
            cargarDatosInventario();
            
        }

        function setupInventarioEventListeners() {
            // Botón Consultar
            const btnConsultar = document.getElementById('inventario_btn_consultar');
            if (btnConsultar) {
                btnConsultar.addEventListener('click', consultarInventario);
            }

            // Botón Exportar
            const btnExportar = document.getElementById('inventario_btn_exportar');
            if (btnExportar) {
                btnExportar.addEventListener('click', exportarInventario);
            }

            // Botón Actualizar
            const btnActualizar = document.getElementById('inventario_btn_actualizar');
            if (btnActualizar) {
                btnActualizar.addEventListener('click', actualizarInventario);
            }

            // Configurar filtros automáticos
            setupFiltrosInventario();
        }

        function procesarBusquedaInventario(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                consultarInventario();
            }
        }

        function consultarInventario() {
            
            const filtros = {
                numeroParte: document.getElementById('inventario_buscar_material').value.trim(),
                propiedad: document.getElementById('inventario_propiedad').value,
                cantidadMinima: document.getElementById('inventario_cantidad_min').value
            };

            // Mostrar loader
            mostrarLoaderInventario();
            
            // Llamada real a la API
            fetch('/api/inventario/consultar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(filtros)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderizarTablaInventario(data.inventario);
                    actualizarEstadisticas({
                        totalItems: data.total,
                        valorTotal: 0 // Por ahora no calculamos valor total
                    });
                } else {
                    mostrarError('Error al consultar inventario: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarError('Error de conexión al consultar inventario');
            });
        }

        function cargarDatosEjemplo() {
            
            const datosEjemplo = [
                {
                    id: 1,
                    numero_parte: 'P001-RES-10K',
                    codigo_material: 'MAT001',
                    propiedad_material: 'ISEMM PROPERTY',
                    especificacion: 'Resistencia 10K Ohm 1% 1/4W',
                    cantidad_entradas: 1500.00,
                    cantidad_salidas: 1200.00,
                    cantidad_total: 300.00,
                    fecha_actualizacion: '2025-07-21 14:30:00'
                },
                {
                    id: 2,
                    numero_parte: 'P002-CAP-100UF',
                    codigo_material: 'MAT002',
                    propiedad_material: 'CUSTOMER PROPERTY',
                    especificacion: 'Capacitor Electrolítico 100uF 25V',
                    cantidad_entradas: 800.00,
                    cantidad_salidas: 750.00,
                    cantidad_total: 50.00,
                    fecha_actualizacion: '2025-07-21 13:15:00'
                },
                {
                    id: 3,
                    numero_parte: 'P003-IC-MCU',
                    codigo_material: 'MAT003',
                    propiedad_material: 'COMMON USE',
                    especificacion: 'Microcontrolador ARM Cortex-M4',
                    cantidad_entradas: 200.00,
                    cantidad_salidas: 180.00,
                    cantidad_total: 20.00,
                    fecha_actualizacion: '2025-07-21 12:00:00'
                }
            ];
            
            renderizarTablaInventario(datosEjemplo);
            
            const estadisticas = {
                totalItems: datosEjemplo.length,
                valorTotal: 15750.50
            };
            actualizarEstadisticas(estadisticas);
        }

        function renderizarTablaInventario(datos) {
            const tbody = document.getElementById('inventario_table_body');
            const contador = document.getElementById('inventario_row_counter');
            
            if (!tbody) return;

            if (datos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="no-data">
                            <i class="fas fa-search"></i>
                            No se encontraron registros con los filtros aplicados
                        </td>
                    </tr>
                `;
                if (contador) contador.textContent = 'Total de registros: 0';
                return;
            }

            tbody.innerHTML = datos.map(item => {
                // Usar los campos correctos del nuevo endpoint
                const cantidad_total = item.cantidad_total || 0;
                const total_lotes = item.total_lotes || 0;
                const claseRemanente = cantidad_total <= 0 ? 'cantidad-baja' : cantidad_total < 50 ? 'cantidad-media' : 'cantidad-ok';
                
                return `
                    <tr>
                        <td class="checkbox-col">
                            <input type="checkbox" value="${item.id}">
                        </td>
                        <td class="numero-parte">${item.numero_parte}</td>
                        <td>${item.codigo_material}</td>
                        <td><span class="propiedad-badge ${item.propiedad_material.toLowerCase().replace(/\s+/g, '-')}">${item.propiedad_material}</span></td>
                        <td class="especificacion" title="${item.especificacion}">${item.especificacion}</td>
                        <td class="cantidad-col cantidad-entradas">${formatearNumero(cantidad_total)}</td>
                        <td class="cantidad-col cantidad-salidas">${total_lotes} lotes</td>
                        <td class="cantidad-col ${claseRemanente}">${formatearNumero(cantidad_total)}</td>
                        <td class="fecha">${formatearFecha(item.fecha_ultimo_recibo)}</td>
                        <td class="acciones">
                            <button class="material-btn material-btn-small material-btn-info" onclick="verDetalleInventario(${item.id})" title="Ver Lotes Disponibles">
                                <i class="fas fa-boxes"></i>
                            </button>
                            <button class="material-btn material-btn-small material-btn-warning" onclick="verMovimientos(${item.id})" title="Ver Historial Completo">
                                <i class="fas fa-history"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            if (contador) {
                contador.textContent = `Total de registros: ${datos.length}`;
            }

            // Actualizar información de paginación
            const paginationInfo = document.getElementById('inventario_pagination_info');
            if (paginationInfo) {
                paginationInfo.textContent = `Mostrando ${datos.length} de ${datos.length}`;
            }
        }

        function actualizarEstadisticas(estadisticas) {
            const totalItems = document.getElementById('inventario_total_items');
            const totalValor = document.getElementById('inventario_total_valor');
            
            if (totalItems) {
                totalItems.textContent = `Total de productos: ${estadisticas.totalItems || 0}`;
            }
            
            if (totalValor) {
                totalValor.textContent = `Valor total: $${formatearNumero(estadisticas.valorTotal || 0)}`;
            }
        }

        function mostrarLoaderInventario() {
            const tbody = document.getElementById('inventario_table_body');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="loading-message">
                            <i class="fas fa-spinner fa-spin"></i>
                            Consultando inventario...
                        </td>
                    </tr>
                `;
            }
        }

        function mostrarError(mensaje) {
            const tbody = document.getElementById('inventario_table_body');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${mensaje}
                        </td>
                    </tr>
                `;
            }
        }

        function exportarInventario() {
            const checkboxes = document.querySelectorAll('#inventario_table_body input[type="checkbox"]:checked');
            const ids = Array.from(checkboxes).map(cb => cb.value);
            
            
            // Crear parámetros de exportación
            const params = new URLSearchParams({
                tipo: 'inventario_general',
                formato: 'excel',
                ids: ids.length > 0 ? ids.join(',') : 'todos'
            });
            
            // Abrir descarga
            window.open(`/api/inventario/exportar?${params}`, '_blank');
            
            // Simulación temporal
            alert('� Exportación iniciada. El archivo se descargará pronto.');
        }

        function actualizarInventario() {
            
            fetch('/api/inventario/actualizar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ Inventario actualizado exitosamente');
                    consultarInventario(); // Recargar datos
                } else {
                    alert('❌ Error al actualizar inventario: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('✅ Inventario actualizado (simulado)');
                consultarInventario();
            });
        }

        function setupFiltrosInventario() {
            // Filtros automáticos al cambiar valores
            const filtros = ['inventario_propiedad', 'inventario_cantidad_min', 'inventario_cantidad_max'];
            
            filtros.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.addEventListener('change', () => {
                        // Auto-consultar después de un pequeño delay
                        setTimeout(consultarInventario, 300);
                    });
                }
            });
        }

        function toggleAllInventario(checkbox) {
            const checkboxes = document.querySelectorAll('#inventario_table_body input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        function verDetalleInventario(id) {
            // Obtener el número de parte del elemento actual
            const fila = event.target.closest('tr');
            const numeroParte = fila.querySelector('.numero-parte').textContent.trim();
            
            // Consultar lotes disponibles
            fetch('/api/inventario/lotes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ numero_parte: numeroParte })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarModalLotes(numeroParte, data.lotes);
                } else {
                    alert(`❌ Error al consultar lotes: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Error al consultar lotes');
            });
        }

        function verMovimientos(id) {
            // Obtener el número de parte del elemento actual
            const fila = event.target.closest('tr');
            const numeroParte = fila.querySelector('.numero-parte').textContent.trim();
            
            // Consultar historial completo
            fetch('/api/inventario/historial', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ numero_parte: numeroParte })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarModalHistorial(numeroParte, data.historial, data.balance_actual);
                } else {
                    alert(`❌ Error al consultar historial: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Error al consultar historial');
            });
        }

        function mostrarModalLotes(numeroParte, lotes) {
            // Crear modal de lotes
            const modalContent = `
                <div class="trazabilidad-modal-overlay" onclick="cerrarModal(event)">
                    <div class="trazabilidad-modal-content" onclick="event.stopPropagation()">
                        <div class="trazabilidad-modal-header">
                            <h3>� Lotes Disponibles - ${numeroParte}</h3>
                            <button class="close-btn" onclick="cerrarModal()">&times;</button>
                        </div>
                        <div class="trazabilidad-modal-body">
                            ${lotes.length > 0 ? `
                                <div class="table-responsive">
                                    <table class="material-table">
                                        <thead>
                                            <tr>
                                                <th>Número de Lote</th>
                                                <th>Cantidad Original</th>
                                                <th>Total Salidas</th>
                                                <th>Cantidad Disponible</th>
                                                <th>Fecha Recibo</th>
                                                <th>Ubicación</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${lotes.map(lote => `
                                                <tr>
                                                    <td><strong>${lote.numero_lote}</strong></td>
                                                    <td class="cantidad-col">${formatearNumero(lote.cantidad_original)}</td>
                                                    <td class="cantidad-col cantidad-salidas">${formatearNumero(lote.total_salidas)}</td>
                                                    <td class="cantidad-col ${lote.cantidad_disponible > 0 ? 'cantidad-ok' : 'cantidad-baja'}">${formatearNumero(lote.cantidad_disponible)}</td>
                                                    <td class="fecha">${formatearFecha(lote.fecha_recibo)}</td>
                                                    <td>${lote.ubicacion_salida || 'No especificada'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="modal-summary">
                                    <p><strong>Total de lotes:</strong> ${lotes.length}</p>
                                    <p><strong>Cantidad total disponible:</strong> ${formatearNumero(lotes.reduce((sum, lote) => sum + lote.cantidad_disponible, 0))}</p>
                                </div>
                            ` : `
                                <div class="no-data">
                                    <i class="fas fa-box-open"></i>
                                    <p>No se encontraron lotes disponibles para este número de parte</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        function mostrarModalHistorial(numeroParte, historial, balanceActual) {
            // Crear modal de historial
            const modalContent = `
                <div class="trazabilidad-modal-overlay" onclick="cerrarModal(event)">
                    <div class="trazabilidad-modal-content" onclick="event.stopPropagation()" style="max-width: 1200px;">
                        <div class="trazabilidad-modal-header">
                            <h3>📈 Historial de Movimientos - ${numeroParte}</h3>
                            <button class="close-btn" onclick="cerrarModal()">&times;</button>
                        </div>
                        <div class="trazabilidad-modal-body">
                            ${historial.length > 0 ? `
                                <div class="modal-summary" style="margin-bottom: 20px;">
                                    <p><strong>Balance actual:</strong> <span class="${balanceActual > 0 ? 'cantidad-ok' : 'cantidad-baja'}">${formatearNumero(balanceActual)}</span></p>
                                    <p><strong>Total de movimientos:</strong> ${historial.length}</p>
                                </div>
                                <div class="table-responsive">
                                    <table class="material-table">
                                        <thead>
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Fecha</th>
                                                <th>Lote</th>
                                                <th>Cantidad</th>
                                                <th>Balance</th>
                                                <th>Detalle</th>
                                                <th>Especificación</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${historial.map(mov => `
                                                <tr>
                                                    <td>
                                                        <span class="tipo-movimiento ${mov.tipo_movimiento.toLowerCase()}">
                                                            ${mov.tipo_movimiento === 'ENTRADA' ? '📥' : '📤'} ${mov.tipo_movimiento}
                                                        </span>
                                                    </td>
                                                    <td class="fecha">${formatearFecha(mov.fecha_movimiento)}</td>
                                                    <td><code>${mov.lote}</code></td>
                                                    <td class="cantidad-col ${mov.cantidad >= 0 ? 'cantidad-entradas' : 'cantidad-salidas'}">
                                                        ${mov.cantidad >= 0 ? '+' : ''}${formatearNumero(mov.cantidad)}
                                                    </td>
                                                    <td class="cantidad-col ${mov.balance_acumulado > 0 ? 'cantidad-ok' : 'cantidad-baja'}">
                                                        ${formatearNumero(mov.balance_acumulado)}
                                                    </td>
                                                    <td class="detalle-movimiento">${mov.detalle_movimiento}</td>
                                                    <td class="especificacion" title="${mov.especificacion}">${mov.especificacion}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <div class="no-data">
                                    <i class="fas fa-history"></i>
                                    <p>No se encontró historial para este número de parte</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        function cerrarModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.querySelector('.trazabilidad-modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        function formatearNumero(numero) {
            return parseFloat(numero || 0).toLocaleString('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatearFecha(fecha) {
            if (!fecha) return '-';
            const date = new Date(fecha);
            return date.toLocaleDateString('es-ES') + ' ' + date.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function cargarDatosInventario() {
            // Cargar datos iniciales
            setTimeout(() => {
                consultarInventario();
            }, 500);
        }

        // Función de importación AJAX con fetch
        function importarExcelRetorno() {
            const fileInput = document.getElementById('importarExcelRetorno');
            const file = fileInput.files[0];
            
            if (!file) {
                alert("Por favor selecciona un archivo Excel.");
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
                alert("Por favor selecciona un archivo Excel válido (.xlsx o .xls)");
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            alert("Procesando archivo, por favor espere...");
            
            fetch('/importar_excel_retorno', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message + " Haga clic en 'Consultar Inventario' para ver los datos actualizados.");
                    fileInput.value = ''; // Limpiar input
                } else {
                    alert("Error al importar: " + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error al importar el archivo");
            });
        }

        // Hacer la función de inicialización disponible globalmente
        window.initControlRetorno = initControlRetorno;
    </script>
</body>
</html>