<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Permisos de Dropdowns</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            padding-top: 2rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        
        .card-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1.5rem;
        }
        
        .btn-custom {
            border-radius: 25px;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
        }
        
        .permission-item {
            padding: 1rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
        }
        
        .permission-active {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .role-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .role-card:hover {
            transform: translateY(-5px);
            border-color: #4facfe;
        }
        
        .role-card.selected {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .dropdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            margin: 0.3rem 0;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-enabled {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .page-group {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
        }
        
        .section-group {
            border-left: 3px solid #4facfe;
            padding-left: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .page-group h6 {
            margin-bottom: 1rem;
        }
        
        .section-group h6 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-shield-alt me-2"></i>
                            Gestión de Permisos de Dropdowns
                        </h3>
                        <p class="mb-0 mt-2 opacity-75">Administra los permisos de información básica para cada rol</p>
                    </div>
                    <div class="card-body">
                        <!-- Sección de Roles -->
                        <div class="row">
                            <div class="col-md-4">
                                <h5><i class="fas fa-users me-2"></i>Roles Disponibles</h5>
                                <div id="rolesContainer" class="loading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <p class="mt-2">Cargando roles...</p>
                                </div>
                            </div>
                            
                            <!-- Sección de Permisos -->
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5><i class="fas fa-list-check me-2"></i>Permisos de Dropdowns</h5>
                                    <div>
                                        <button class="btn btn-custom btn-success btn-sm" onclick="enableAllPermissions()">
                                            <i class="fas fa-check-double me-1"></i>Habilitar Todos
                                        </button>
                                        <button class="btn btn-custom btn-danger btn-sm" onclick="disableAllPermissions()">
                                            <i class="fas fa-times me-1"></i>Deshabilitar Todos
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Barra de búsqueda y filtros -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="searchPermissions" 
                                                   placeholder="Buscar permisos..." onkeyup="filterPermissions()">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <select class="form-select" id="categoryFilter" onchange="filterByCategory()">
                                            <option value="">Todas las categorías</option>
                                            <option value="LISTA_CONTROL">LISTA_CONTROL</option>
                                            <option value="LISTA_INFORMACION">LISTA_INFORMACION</option>
                                            <option value="Control de">Control de</option>
                                            <option value="Información">Información</option>
                                            <option value="Configuración">Configuración</option>
                                            <option value="Gestión">Gestión</option>
                                            <option value="Análisis">Análisis</option>
                                            <option value="Administracion">Administración</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Contador de permisos -->
                                <div class="mb-3">
                                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="fas fa-info-circle me-2"></i>
                                            Mostrando <span id="visibleCount">0</span> de <span id="totalCount">0</span> permisos
                                        </span>
                                        <span id="enabledCount" class="badge bg-success">0 habilitados</span>
                                    </div>
                                </div>
                                
                                <div id="permissionsContainer">
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-hand-pointer fa-3x mb-3"></i>
                                        <p>Selecciona un rol para ver y editar sus permisos</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Éxito</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successMessage"></div>
        </div>
        
        <div id="errorToast" class="toast" role="alert">
            <div class="toast-header bg-danger text-white">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="errorMessage"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentRole = null;
        let allRoles = [];
        let allDropdowns = [];
        let rolePermissions = {};

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            loadRoles();
            loadDropdowns();
        });

        // Cargar roles disponibles
        async function loadRoles() {
            try {
                const response = await fetch('/admin/api/roles');
                const roles = await response.json();
                allRoles = roles;
                renderRoles(roles);
            } catch (error) {
                showError('Error cargando roles: ' + error.message);
            }
        }

        // Cargar dropdowns disponibles
        async function loadDropdowns() {
            try {
                const response = await fetch('/admin/api/dropdowns');
                const dropdowns = await response.json();
                allDropdowns = dropdowns;
            } catch (error) {
                showError('Error cargando dropdowns: ' + error.message);
            }
        }

        // Renderizar lista de roles
        function renderRoles(roles) {
            const container = document.getElementById('rolesContainer');
            container.innerHTML = '';
            
            roles.forEach(role => {
                const roleCard = document.createElement('div');
                roleCard.className = 'role-card card mb-2';
                roleCard.onclick = () => selectRole(role.nombre);
                
                roleCard.innerHTML = `
                    <div class="card-body p-3">
                        <h6 class="card-title mb-1">${role.nombre}</h6>
                        <small class="text-muted">${role.descripcion}</small>
                        <div class="mt-2">
                            <span class="badge bg-primary" id="count-${role.nombre}">
                                <i class="fas fa-spinner fa-spin"></i>
                            </span>
                        </div>
                    </div>
                `;
                
                container.appendChild(roleCard);
                
                // Cargar contador de permisos
                loadRolePermissionCount(role.nombre);
            });
        }

        // Cargar contador de permisos para un rol
        async function loadRolePermissionCount(roleName) {
            try {
                const response = await fetch(`/admin/api/role-permissions/${roleName}`);
                const permissions = await response.json();
                rolePermissions[roleName] = permissions;
                
                const countBadge = document.getElementById(`count-${roleName}`);
                countBadge.innerHTML = `${permissions.length} permisos`;
            } catch (error) {
                const countBadge = document.getElementById(`count-${roleName}`);
                countBadge.innerHTML = `<i class="fas fa-exclamation-triangle"></i>`;
            }
        }

        // Seleccionar un rol
        async function selectRole(roleName) {
            // Actualizar UI
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            currentRole = roleName;
            await loadRolePermissions(roleName);
        }

        // Cargar permisos de un rol específico
        async function loadRolePermissions(roleName) {
            const container = document.getElementById('permissionsContainer');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando permisos para ${roleName}...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`/admin/api/role-permissions/${roleName}`);
                const permissions = await response.json();
                rolePermissions[roleName] = permissions;
                renderPermissions(permissions);
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error cargando permisos: ${error.message}
                    </div>
                `;
            }
        }

        // Renderizar permisos
        function renderPermissions(permissions) {
            const container = document.getElementById('permissionsContainer');
            container.innerHTML = '';
            
            // Crear mapa de permisos activos por key
            const activePermissions = new Set();
            permissions.forEach(p => activePermissions.add(p.key));
            
            // Actualizar contadores
            document.getElementById('totalCount').textContent = allDropdowns.length;
            document.getElementById('enabledCount').textContent = permissions.length;
            
            // Agrupar dropdowns por página
            const groupedByPage = {};
            allDropdowns.forEach(dropdown => {
                if (!groupedByPage[dropdown.pagina]) {
                    groupedByPage[dropdown.pagina] = {};
                }
                if (!groupedByPage[dropdown.pagina][dropdown.seccion]) {
                    groupedByPage[dropdown.pagina][dropdown.seccion] = [];
                }
                groupedByPage[dropdown.pagina][dropdown.seccion].push(dropdown);
            });
            
            // Renderizar por grupos
            Object.keys(groupedByPage).sort().forEach(pagina => {
                const pageGroup = document.createElement('div');
                pageGroup.className = 'page-group mb-4';
                pageGroup.innerHTML = `
                    <h6 class="fw-bold text-primary mb-2">
                        <i class="fas fa-folder me-2"></i>${pagina}
                    </h6>
                `;
                
                Object.keys(groupedByPage[pagina]).sort().forEach(seccion => {
                    const sectionGroup = document.createElement('div');
                    sectionGroup.className = 'section-group ms-3 mb-3';
                    sectionGroup.innerHTML = `
                        <h6 class="fw-semibold text-secondary mb-2">
                            <i class="fas fa-layer-group me-2"></i>${seccion}
                        </h6>
                    `;
                    
                    groupedByPage[pagina][seccion].forEach(dropdown => {
                        const hasPermission = activePermissions.has(dropdown.key);
                        
                        const dropdownItem = document.createElement('div');
                        dropdownItem.className = 'dropdown-item permission-row ms-3';
                        dropdownItem.setAttribute('data-permission', dropdown.key);
                        dropdownItem.setAttribute('data-pagina', dropdown.pagina);
                        dropdownItem.setAttribute('data-seccion', dropdown.seccion);
                        dropdownItem.setAttribute('data-boton', dropdown.boton);
                        dropdownItem.innerHTML = `
                            <div>
                                <strong>${dropdown.boton}</strong>
                                <br>
                                <small class="text-muted">${dropdown.descripcion}</small>
                            </div>
                            <div>
                                <span class="status-badge ${hasPermission ? 'status-enabled' : 'status-disabled'}">
                                    ${hasPermission ? 'Habilitado' : 'Deshabilitado'}
                                </span>
                                <button class="btn btn-sm ${hasPermission ? 'btn-danger' : 'btn-success'} ms-2"
                                        onclick="togglePermission('${dropdown.key}', ${hasPermission})">
                                    <i class="fas ${hasPermission ? 'fa-times' : 'fa-check'}"></i>
                                </button>
                            </div>
                        `;
                        
                        sectionGroup.appendChild(dropdownItem);
                    });
                    
                    pageGroup.appendChild(sectionGroup);
                });
                
                container.appendChild(pageGroup);
            });
            
            // Aplicar filtros actuales
            filterPermissions();
        }

        // Filtrar permisos por búsqueda
        function filterPermissions() {
            const searchTerm = document.getElementById('searchPermissions').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const permissionRows = document.querySelectorAll('.permission-row');
            
            let visibleCount = 0;
            
            permissionRows.forEach(row => {
                const pagina = row.getAttribute('data-pagina')?.toLowerCase() || '';
                const seccion = row.getAttribute('data-seccion')?.toLowerCase() || '';
                const boton = row.getAttribute('data-boton')?.toLowerCase() || '';
                const permissionText = row.textContent.toLowerCase();
                
                const matchesSearch = searchTerm === '' || 
                                    pagina.includes(searchTerm) ||
                                    seccion.includes(searchTerm) ||
                                    boton.includes(searchTerm) ||
                                    permissionText.includes(searchTerm);
                
                const matchesCategory = categoryFilter === '' || 
                                      pagina.includes(categoryFilter.toLowerCase()) ||
                                      seccion.includes(categoryFilter.toLowerCase()) ||
                                      boton.startsWith(categoryFilter);
                
                if (matchesSearch && matchesCategory) {
                    row.style.display = 'flex';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Mostrar/ocultar grupos vacíos
            document.querySelectorAll('.page-group').forEach(pageGroup => {
                const visibleItems = pageGroup.querySelectorAll('.permission-row[style*="flex"]');
                pageGroup.style.display = visibleItems.length > 0 ? 'block' : 'none';
            });
            
            document.getElementById('visibleCount').textContent = visibleCount;
        }

        // Filtrar por categoría
        function filterByCategory() {
            filterPermissions();
        }

        // Alternar permiso
        async function togglePermission(permissionKey, currentStatus) {
            if (!currentRole) return;
            
            try {
                const action = currentStatus ? 'remove' : 'add';
                const response = await fetch('/admin/api/toggle-permission', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        role: currentRole,
                        permission_key: permissionKey,
                        action: action
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`Permiso ${currentStatus ? 'removido' : 'asignado'} correctamente`);
                    await loadRolePermissions(currentRole);
                    await loadRolePermissionCount(currentRole);
                } else {
                    showError(result.error || 'Error actualizando permiso');
                }
            } catch (error) {
                showError('Error de comunicación: ' + error.message);
            }
        }

        // Habilitar todos los permisos
        async function enableAllPermissions() {
            if (!currentRole) {
                showError('Selecciona un rol primero');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/enable-all-permissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: currentRole })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Todos los permisos habilitados');
                    await loadRolePermissions(currentRole);
                    await loadRolePermissionCount(currentRole);
                } else {
                    showError(result.error || 'Error habilitando permisos');
                }
            } catch (error) {
                showError('Error de comunicación: ' + error.message);
            }
        }

        // Deshabilitar todos los permisos
        async function disableAllPermissions() {
            if (!currentRole) {
                showError('Selecciona un rol primero');
                return;
            }
            
            if (!confirm(`¿Estás seguro de deshabilitar TODOS los permisos para ${currentRole}?`)) {
                return;
            }
            
            try {
                const response = await fetch('/admin/api/disable-all-permissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: currentRole })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Todos los permisos deshabilitados');
                    await loadRolePermissions(currentRole);
                    await loadRolePermissionCount(currentRole);
                } else {
                    showError(result.error || 'Error deshabilitando permisos');
                }
            } catch (error) {
                showError('Error de comunicación: ' + error.message);
            }
        }

        // Mostrar mensaje de éxito
        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            toast.show();
        }

        // Mostrar mensaje de error
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('errorToast'));
            toast.show();
        }
    </script>
</body>
</html>
