<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="autocomplete" content="off">
    <title>Control de Embarque - PO de Compra</title>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=LG+regular&display=swap" rel="stylesheet">
    
    <!-- Estilos específicos para Control de Embarque -->
    <link rel="stylesheet" href="/static/css/control_embarque.css">
    
    <!-- Scripts necesarios -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/popper.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/fontawesome.all.min.js"></script>
    <script src="/static/js/Chart.min.js"></script>
    <script src="/static/js/jquery.dataTables.min.js"></script>
    <script src="/static/js/dataTables.bootstrap5.min.js"></script>
    <script src="/static/js/sweetalert2.all.min.js"></script>
    <script src="/static/js/moment.min.js"></script>
    <script src="/static/js/daterangepicker.js"></script>
    <script src="/static/js/select2.min.js"></script>
    <script src="/static/js/flatpickr.min.js"></script>
    <script src="/static/js/autoNumeric.min.js"></script>
    
</head>
<body>

<!-- Modal de Registro de PO de Embarque -->
<div id="embarque-modal-po" class="embarque-modal">
    <div class="embarque-modal-content">
        <h2>Registrar Nuevo PO de Embarque</h2>
        <p>Ingrese los datos del PO de compra de embarque:</p>
        
        <form autocomplete="off">
        <div class="embarque-field">
            <label for="embarque-po-codigo">Código de PO:</label>
            <input type="text" id="embarque-po-codigo" placeholder="Ej: PO-EMB-2024-001" autocomplete="off">
        </div>
        
        <div class="embarque-field">
            <label for="embarque-proveedor">Proveedor:</label>
            <input type="text" id="embarque-proveedor" placeholder="Nombre del proveedor" autocomplete="off">
        </div>
        
        <div class="embarque-field">
            <label for="embarque-fecha-embarque">Fecha de Embarque:</label>
            <input type="date" id="embarque-fecha-embarque" autocomplete="off">
        </div>
        
        <div class="embarque-field">
            <label for="embarque-destino">Destino:</label>
            <input type="text" id="embarque-destino" placeholder="Puerto/Ciudad de destino" autocomplete="off">
        </div>
        </form>
        
        <div class="embarque-buttons">
            <button class="embarque-btn danger" onclick="cerrarModalEmbarquePO()">Cancelar</button>
            <button class="embarque-btn primary" onclick="guardarPOEmbarque()">Registrar PO</button>
        </div>
    </div>
</div>

<!-- Modal de Asignación de Materiales -->
<div id="embarque-modal-asignacion" class="embarque-modal">
    <div class="embarque-modal-content-large">
        <h2>Asignación de Materiales al Embarque</h2>
        <div class="embarque-info-header">
            <p>Asigne los materiales al PO de embarque escaneando:</p>
            <div class="embarque-contador">
                <span class="embarque-asignados">Asignados: <span id="embarque-contador-asignados">0</span></span> / 
                <span class="embarque-total">Total: <span id="embarque-contador-total">0</span></span>
            </div>
        </div>
        
        <div class="embarque-escaneo-section">
            <div class="embarque-escaneo-grid">
                <div>
                    <label class="embarque-label-po">1. Escanear PO de Embarque:</label>
                    <input type="text" id="embarque-escaneo-po" placeholder="Escanee el código del PO..." 
                           class="embarque-input-escaneo"
                           onkeydown="procesarEscaneoPOEmbarque(event)"
                           oninput="detectarEscaneoPOAutomatico(event)">
                </div>
                <div>
                    <label class="embarque-label-material">2. Escanear Material:</label>
                    <input type="text" id="embarque-escaneo-material" placeholder="Escanee el material a asignar..." 
                           class="embarque-input-material"
                           onkeydown="procesarEscaneoMaterialEmbarque(event)" 
                           oninput="detectarEscaneoMaterialAutomatico(event)">
                </div>
            </div>
        </div>
        
        <div class="embarque-tabla-container">
            <table class="embarque-tabla">
                <thead class="embarque-tabla-header">
                    <tr>
                        <th class="embarque-th">#</th>
                        <th class="embarque-th">Código de Material</th>
                        <th class="embarque-th">PO Embarque</th>
                        <th class="embarque-th">Estado</th>
                        <th class="embarque-th">Acciones</th>
                    </tr>
                </thead>
                <tbody id="embarque-tabla-asignaciones">
                    <!-- Se llena dinámicamente -->
                </tbody>
            </table>
        </div>
        
        <div class="embarque-buttons-container">
            <button class="embarque-btn-finalizar" onclick="finalizarAsignacionEmbarque()" id="embarque-btn-finalizar" disabled>Finalizar Asignación</button>
            <button class="embarque-btn-continuar" onclick="continuarSinAsignarEmbarque()">Continuar Sin Asignar</button>
        </div>
    </div>
</div>

<!-- Modal de Advertencia -->
<div id="embarque-modal-advertencia" class="embarque-modal-overlay">
    <div class="embarque-modal-advertencia-content">
        <h3 class="embarque-advertencia-titulo">ADVERTENCIA</h3>
        <div id="embarque-mensaje-advertencia" class="embarque-advertencia-mensaje"></div>
        <div class="embarque-advertencia-buttons">
            <button onclick="cerrarModalAdvertenciaEmbarque()" class="embarque-btn-cancelar">Cancelar</button>
            <button onclick="confirmarAdvertenciaEmbarque()" class="embarque-btn-confirmar">Continuar</button>
        </div>
    </div>
</div>

<!-- Modal de Proceso Completado -->
<div id="embarque-modal-completado" class="embarque-modal-overlay">
    <div class="embarque-modal-completado-content">
        <h3 class="embarque-completado-titulo">PROCESO COMPLETADO</h3>
        <div id="embarque-mensaje-completado" class="embarque-completado-mensaje"></div>
        <div class="embarque-completado-buttons">
            <button onclick="cerrarModalCompletadoEmbarque()" class="embarque-btn-ok">OK</button>
        </div>
    </div>
</div>

<!-- Formulario principal -->
<form autocomplete="off" data-form-type="embarque">
<div class="embarque-container">

    <div class="embarque-form-section">
        <div class="embarque-form-group">
            <label>Tipo de Embarque</label>
            <select id="embarque-tipo" autocomplete="off">
                <option>Marítimo</option>
                <option>Aéreo</option>
                <option>Terrestre</option>
            </select>
        </div>
    </div>

    <div class="embarque-form-section">    
        <div class="embarque-form-row">
            <div class="embarque-form-group">
                <label>Cliente</label>
                <select id="embarque-cliente" autocomplete="off">
                    <option value="">Seleccionar</option>
                    <option value="LG_REFRIS">LG_REFRIS</option>
                    <option value="LG_ESTUFAS">LG_ESTUFAS</option>
                </select>
            </div>
            <div class="embarque-form-group">
                <label>Código de PO de Embarque</label>
                <div class="embarque-input-container">
                    <div class="embarque-input-wrapper">
                        <input type="text" id="embarque-codigo-po" name="embarque_codigo_escaneo" class="embarque-campo-escaneo" placeholder="Listo para escanear PO..." onkeydown="procesarEscaneoPO(event)" onfocus="activarModoEscaneoPO()" onblur="desactivarModoEscaneoPO()" autocomplete="off">
                        <span id="embarque-indicador-escaneo" class="embarque-indicador">LISTO</span>
                        <button type="button" onclick="limpiarCampoPOManual()" class="embarque-btn-limpiar" title="Limpiar campo">X</button>
                    </div>
                    <button type="button" onclick="abrirEscanerPOQR()" class="embarque-btn-cam" title="Escanear PO con cámara">CAM</button>
                </div>
            </div>
        </div>

        <div class="embarque-form-row">
            <div class="embarque-form-group">
                <label>Proveedor</label>
                <select id="embarque-proveedor-select">
                    <option value="">Seleccionar</option>
                    <option value="ROHM">ROHM</option>
                    <option value="SMART">SMART</option>
                    <option value="INFINEON">INFINEON</option>
                </select>
            </div>
            <div class="embarque-form-group">
                <label>Fecha de Embarque</label>
                <input type="date" id="embarque-fecha" autocomplete="off">
            </div>
            <div class="embarque-form-group">
                <label>Puerto/Destino</label>
                <input type="text" id="embarque-destino-input" placeholder="Puerto o ciudad de destino" autocomplete="off">
            </div>
            <div class="embarque-form-group">
                <label>Estado del Embarque</label>
                <select id="embarque-estado">
                    <option value="PREPARACION">En Preparación</option>
                    <option value="EMBARCADO">Embarcado</option>
                    <option value="EN_TRANSITO">En Tránsito</option>
                    <option value="ENTREGADO">Entregado</option>
                </select>
            </div>
        </div>
    </div>

    <div class="embarque-form-section">
        <div class="embarque-form-row">
            <div class="embarque-form-group">
                <label>Número de Contenedor</label>
                <input type="text" id="embarque-contenedor" placeholder="Número de contenedor" autocomplete="off">
            </div>
            <div class="embarque-form-group">
                <label>Peso Total (kg)</label>
                <input type="number" id="embarque-peso" placeholder="0.00" step="0.01" autocomplete="off">
            </div>
            <div class="embarque-form-group">
                <label>Volumen (m³)</label>
                <input type="number" id="embarque-volumen" placeholder="0.00" step="0.01" autocomplete="off">
            </div>
            <div class="embarque-form-group">
                <label>Observaciones</label>
                <textarea id="embarque-observaciones" placeholder="Observaciones del embarque" rows="2" autocomplete="off"></textarea>
            </div>
        </div>
    </div>

    <div class="embarque-actions">
        <button type="button" onclick="registrarEmbarque()" class="embarque-btn-registrar">Registrar Embarque</button>
        <button type="button" onclick="imprimirEtiquetaEmbarque()" class="embarque-btn-imprimir">Imprimir Etiqueta</button>
        <button type="button" onclick="limpiarFormularioEmbarque()" class="embarque-btn-limpiar-form">Limpiar</button>
    </div>

</div>
</form>

<script>
// Variables globales para Control de Embarque
let embarqueAsignaciones = [];
let embarqueContadorAsignados = 0;
let embarqueContadorTotal = 0;
let embarquePOActual = '';
let embarqueModoEscaneoActivo = false;

// Funciones para manejo de modales
function cerrarModalEmbarquePO() {
    document.getElementById('embarque-modal-po').style.display = 'none';
}

function guardarPOEmbarque() {
    const codigo = document.getElementById('embarque-po-codigo').value;
    const proveedor = document.getElementById('embarque-proveedor').value;
    const fecha = document.getElementById('embarque-fecha-embarque').value;
    const destino = document.getElementById('embarque-destino').value;
    
    if (!codigo || !proveedor || !fecha || !destino) {
        alert('Por favor complete todos los campos');
        return;
    }
    
    // Aquí iría la lógica para guardar en la base de datos
    console.log('Guardando PO de embarque:', { codigo, proveedor, fecha, destino });
    
    cerrarModalEmbarquePO();
    mostrarModalCompletadoEmbarque('PO de embarque registrado exitosamente');
}

// Funciones para escaneo de PO
function activarModoEscaneoPO() {
    embarqueModoEscaneoActivo = true;
    const campo = document.getElementById('embarque-codigo-po');
    const indicador = document.getElementById('embarque-indicador-escaneo');
    
    campo.classList.add('embarque-campo-activo');
    indicador.textContent = 'ACTIVO';
    indicador.style.color = '#e74c3c';
}

function desactivarModoEscaneoPO() {
    embarqueModoEscaneoActivo = false;
    const campo = document.getElementById('embarque-codigo-po');
    const indicador = document.getElementById('embarque-indicador-escaneo');
    
    campo.classList.remove('embarque-campo-activo');
    indicador.textContent = 'LISTO';
    indicador.style.color = '#28a745';
}

function procesarEscaneoPO(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const codigo = event.target.value.trim();
        
        if (codigo) {
            console.log('PO escaneado:', codigo);
            embarquePOActual = codigo;
            
            // Aquí iría la validación del PO
            validarPOEmbarque(codigo);
        }
    }
}

function validarPOEmbarque(codigo) {
    // Simulación de validación
    console.log('Validando PO de embarque:', codigo);
    
    // Aquí iría la lógica de validación real
    const esValido = true; // Simulación
    
    if (esValido) {
        document.getElementById('embarque-codigo-po').style.background = '#d1edff';
        document.getElementById('embarque-indicador-escaneo').textContent = 'VÁLIDO';
        document.getElementById('embarque-indicador-escaneo').style.color = '#007bff';
    } else {
        document.getElementById('embarque-codigo-po').style.background = '#ffe6e6';
        document.getElementById('embarque-indicador-escaneo').textContent = 'ERROR';
        document.getElementById('embarque-indicador-escaneo').style.color = '#dc3545';
    }
}

// Funciones para asignación de materiales
function procesarEscaneoPOEmbarque(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const po = event.target.value.trim();
        
        if (po) {
            embarquePOActual = po;
            document.getElementById('embarque-escaneo-material').disabled = false;
            document.getElementById('embarque-escaneo-material').focus();
        }
    }
}

function procesarEscaneoMaterialEmbarque(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const material = event.target.value.trim();
        
        if (material && embarquePOActual) {
            asignarMaterialAEmbarque(material, embarquePOActual);
            event.target.value = '';
        }
    }
}

function asignarMaterialAEmbarque(material, po) {
    const asignacion = {
        id: Date.now(),
        material: material,
        po: po,
        estado: 'ASIGNADO',
        fecha: new Date().toISOString()
    };
    
    embarqueAsignaciones.push(asignacion);
    embarqueContadorAsignados++;
    
    actualizarTablaAsignacionesEmbarque();
    actualizarContadoresEmbarque();
}

function actualizarTablaAsignacionesEmbarque() {
    const tbody = document.getElementById('embarque-tabla-asignaciones');
    tbody.innerHTML = '';
    
    embarqueAsignaciones.forEach((asignacion, index) => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
            <td class="embarque-td">${index + 1}</td>
            <td class="embarque-td">${asignacion.material}</td>
            <td class="embarque-td">${asignacion.po}</td>
            <td class="embarque-td"><span class="embarque-estado-${asignacion.estado.toLowerCase()}">${asignacion.estado}</span></td>
            <td class="embarque-td">
                <button onclick="eliminarAsignacionEmbarque(${asignacion.id})" class="embarque-btn-eliminar">Eliminar</button>
            </td>
        `;
        tbody.appendChild(fila);
    });
}

function actualizarContadoresEmbarque() {
    document.getElementById('embarque-contador-asignados').textContent = embarqueContadorAsignados;
    document.getElementById('embarque-contador-total').textContent = embarqueContadorTotal;
    
    const btnFinalizar = document.getElementById('embarque-btn-finalizar');
    if (embarqueContadorAsignados > 0) {
        btnFinalizar.disabled = false;
        btnFinalizar.style.background = '#5A8A5A';
        btnFinalizar.style.cursor = 'pointer';
    }
}

function eliminarAsignacionEmbarque(id) {
    embarqueAsignaciones = embarqueAsignaciones.filter(a => a.id !== id);
    embarqueContadorAsignados--;
    actualizarTablaAsignacionesEmbarque();
    actualizarContadoresEmbarque();
}

// Funciones para modales de advertencia y completado
function mostrarModalAdvertenciaEmbarque(mensaje) {
    document.getElementById('embarque-mensaje-advertencia').innerHTML = mensaje;
    document.getElementById('embarque-modal-advertencia').style.display = 'flex';
}

function cerrarModalAdvertenciaEmbarque() {
    document.getElementById('embarque-modal-advertencia').style.display = 'none';
}

function confirmarAdvertenciaEmbarque() {
    cerrarModalAdvertenciaEmbarque();
    // Continuar con la acción
}

function mostrarModalCompletadoEmbarque(mensaje) {
    document.getElementById('embarque-mensaje-completado').innerHTML = mensaje;
    document.getElementById('embarque-modal-completado').style.display = 'flex';
}

function cerrarModalCompletadoEmbarque() {
    document.getElementById('embarque-modal-completado').style.display = 'none';
    limpiarFormularioEmbarque();
}

// Funciones principales
function registrarEmbarque() {
    const datos = {
        tipo: document.getElementById('embarque-tipo').value,
        cliente: document.getElementById('embarque-cliente').value,
        codigoPO: document.getElementById('embarque-codigo-po').value,
        proveedor: document.getElementById('embarque-proveedor-select').value,
        fecha: document.getElementById('embarque-fecha').value,
        destino: document.getElementById('embarque-destino-input').value,
        estado: document.getElementById('embarque-estado').value,
        contenedor: document.getElementById('embarque-contenedor').value,
        peso: document.getElementById('embarque-peso').value,
        volumen: document.getElementById('embarque-volumen').value,
        observaciones: document.getElementById('embarque-observaciones').value
    };
    
    if (!datos.codigoPO || !datos.cliente || !datos.proveedor) {
        mostrarModalAdvertenciaEmbarque('Por favor complete los campos obligatorios: Código PO, Cliente y Proveedor');
        return;
    }
    
    console.log('Registrando embarque:', datos);
    mostrarModalCompletadoEmbarque('Embarque registrado exitosamente');
}

function imprimirEtiquetaEmbarque() {
    const codigoPO = document.getElementById('embarque-codigo-po').value;
    
    if (!codigoPO) {
        mostrarModalAdvertenciaEmbarque('Debe ingresar un código de PO antes de imprimir');
        return;
    }
    
    console.log('Imprimiendo etiqueta para PO:', codigoPO);
    mostrarModalCompletadoEmbarque('Etiqueta de embarque enviada a impresión');
}

function limpiarFormularioEmbarque() {
    document.querySelectorAll('#embarque-container input, #embarque-container select, #embarque-container textarea').forEach(campo => {
        if (campo.type === 'checkbox' || campo.type === 'radio') {
            campo.checked = false;
        } else {
            campo.value = '';
        }
    });
    
    embarqueAsignaciones = [];
    embarqueContadorAsignados = 0;
    embarqueContadorTotal = 0;
    embarquePOActual = '';
    
    actualizarTablaAsignacionesEmbarque();
    actualizarContadoresEmbarque();
}

function limpiarCampoPOManual() {
    document.getElementById('embarque-codigo-po').value = '';
    document.getElementById('embarque-codigo-po').style.background = '';
    document.getElementById('embarque-indicador-escaneo').textContent = 'LISTO';
    document.getElementById('embarque-indicador-escaneo').style.color = '#28a745';
}

function abrirEscanerPOQR() {
    console.log('Abriendo escáner QR para PO');
    // Aquí iría la implementación del escáner QR
}

// Funciones de detección automática
function detectarEscaneoPOAutomatico(event) {
    // Lógica para detectar escaneo automático
}

function detectarEscaneoMaterialAutomatico(event) {
    // Lógica para detectar escaneo automático
}

function finalizarAsignacionEmbarque() {
    if (embarqueAsignaciones.length === 0) {
        mostrarModalAdvertenciaEmbarque('No hay materiales asignados para finalizar');
        return;
    }
    
    const mensaje = `
        <strong>Resumen de Asignación:</strong><br>
        Materiales asignados: ${embarqueContadorAsignados}<br>
        PO de embarque: ${embarquePOActual}<br>
        <span style="color: #5A8A5A; font-weight: bold;">Asignación completada exitosamente</span>
    `;
    
    mostrarModalCompletadoEmbarque(mensaje);
}

function continuarSinAsignarEmbarque() {
    if (embarqueAsignaciones.length > 0) {
        mostrarModalAdvertenciaEmbarque('Hay materiales asignados. ¿Está seguro de continuar sin completar la asignación?');
    } else {
        mostrarModalCompletadoEmbarque('Proceso continuado sin asignaciones');
    }
}

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    console.log('Control de Embarque inicializado');
    
    // Configurar fecha actual por defecto
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('embarque-fecha').value = hoy;
});
</script>

</body>
</html>